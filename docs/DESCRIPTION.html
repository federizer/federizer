<!DOCTYPE html><html><head>
      <title>DESCRIPTION</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////home/igor/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.8.15/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="system-instructions">System Instructions </h1>
<p>You are an expert in OAuth 2.0 and email system. You are an experienced frontend and backend developer. You know how to code in these languages (a) Golang, SQL (b) HTML, Javascript/Typescript, CSS and you know how to use React framework with styled-components. You can write API documentation using OpenAPI 3.1 specification. You know how to design a synchronization protocol to synchronize data between backend services and a frontend application.</p>
<h1 id="the-federizer-project">The Federizer Project </h1>
<p>We aim to create an Internet mail system, similar to the current email system, that facilitates the transmission of various types of data, such as messages, documents, books, photos, podcasts, and videos, using a set of OAuth 2.0 mechanisms.</p>
<h1 id="logic">Logic </h1>
<h2 id="placeholder-message-and-external-resources">Placeholder Message and External Resources </h2>
<p>Each email entity consists of a Placeholder Message and its associated External Resources—the message bodies stored within the mailbox.</p>
<p>The Placeholder Message also serves as an Access Control List, granting access to the External Resources to the individuals specified in the message headers: "From", "To", "Cc", "Bcc", "Forwarded-From", and "Forwarded-To".</p>
<p>Owners of the External Resources can send each recipient a copy of the Placeholder Message, signed by their agent. This action notifies the recipients' agents to fetch the corresponding External Resources.</p>
<h2 id="contextual-discharge">Contextual Discharge </h2>
<p>As Placeholder Messages pass through each mailbox service, a chronological sequence of signed Placeholder Messages is formed.</p>
<p>To grant recipients access to External Resources that are confined to the owner, a chain of signed Placeholder Messages can be presented. This enables access and allows the recipients to fetch the External Resources.</p>
<p>Upon fetching the External Resources, each recipient gains ownership of the copies stored in their mailbox.</p>
<h2 id="concept">Concept </h2>
<h3 id="acronyms">Acronyms </h3>
<p>For the sake of brevity of this document, the following list of acronyms will be used:</p>
<ul>
<li>AS: Authorization Server</li>
<li>RS: Resource Server</li>
<li>MTA: Mail Transfer Agent</li>
<li>MBX: Mailbox</li>
<li>APP: Webmail Application</li>
</ul>
<h3 id="components">Components </h3>
<p>Suppose we have two trust domains, <a href="http://example.com">example.com</a> and <a href="http://example.net">example.net</a>, and two users: (a) Alice with the email address <a href="mailto:alice@example.com">alice@example.com</a>, and (b) Bob with the email address <a href="mailto:bob@example.net">bob@example.net</a>. These domains and users do not have any pre-established trust relationship, nor do we intend to create any permanent trust relationship (e.g. through federation) between the trust domains.</p>
<p>We have the following components:</p>
<ul>
<li>
<p>Authorization Server (AS1): Operates under the <a href="http://example.com">example.com</a> trust domain.</p>
</li>
<li>
<p>Authorization Server (AS2): Operates under the <a href="http://example.net">example.net</a> trust domain.</p>
</li>
<li>
<p>Client (Client1): Operates under the <a href="http://example.com">example.com</a> trust domain and serves as Alice's Webmail application (APP1).</p>
</li>
<li>
<p>Client (Client2): Operates under the <a href="http://example.com">example.com</a> trust domain and serves as Alice's Mail Transfer Agent (MTA1)</p>
</li>
<li>
<p>Client (Client3): Operates under the <a href="http://example.net">example.net</a> trust domain and serves as Bob's Mail Transfer Agent (MTA2)</p>
</li>
<li>
<p>Client (Client4): Operates under the <a href="http://example.net">example.net</a> trust domain and serves as Bob's Webmail application (APP2).</p>
</li>
<li>
<p>Resource Server (RS1): Operates under the <a href="http://example.com">example.com</a> trust domain and serves as Alice's Mailbox (MBX1).</p>
</li>
<li>
<p>Resource Server (RS2): Operates under the <a href="http://example.net">example.net</a> trust domain and serves as Bob's Mailbox (MBX2).</p>
</li>
<li>
<p>MBX1 and MTA1: We will refer to them collectively as the MBX1/MTA1 entity, that acts in a dual role and functions as both a service and an agent:</p>
<ul>
<li>
<p>Acts as an RS1 with respect to Client1 or Client3.</p>
</li>
<li>
<p>Acts as a Client2 with respect to RS2.</p>
</li>
</ul>
</li>
<li>
<p>MBX2 and MTA2: We will refer to them collectively as the MBX2/MTA2 entity, that acts in a dual role and functions as both a service and an agent:</p>
<ul>
<li>
<p>Acts as an RS2 with respect to Client4 or Client2.</p>
</li>
<li>
<p>Acts as a Client3 with respect to RS1.</p>
</li>
</ul>
</li>
</ul>
<p>The MTA allows bidirectional data transfer, it can send and receive resources using the POST and GET http methods. That allows to deliver Alice's resources to Bob in two different ways:</p>
<ol>
<li>
<p>Alice's MTA1 sends her resources to Bob's MBX2.</p>
</li>
<li>
<p>Alice temporarily shares her resources to Bob on her MBX1 and sends a notification message (a Placeholder Message, see Fig. 1) via MTA1 to Bob's MBX2/MTA2 service. Next, the Bob's MTA2 fetches the resources from Alice's MBX1/MTA1 service.</p>
</li>
</ol>
<p>Taking into account both ways of transferring Alice's resources to Bob and highlight the symmetry of the system (Alice can deliver her resources to Bob in two ways; Bob can deliver his resources to Alice in two ways) we can summarize the concept of dual roles as follows:</p>
<ul>
<li>
<p>the MBX1/MTA1 acts as RS1 when Alice posts/gets her resources via APP1.</p>
</li>
<li>
<p>the MBX1/MTA1 acts as Client2 when transferring Alice's resources to Bob's MBX2.</p>
</li>
<li>
<p>the MBX1/MTA1 acts as RS1 when Bob's MTA2 fetches Alice's shared resources from Alice's MBX1.</p>
</li>
<li>
<p>the MBX2/MTA2 acts as RS2 when Bob posts/gets his resources via APP2.</p>
</li>
<li>
<p>the MBX2/MTA2 acts as Client3 when transferring Bob's resources to Alice's MBX1.</p>
</li>
<li>
<p>the MBX2/MTA2 acts as RS2 when Alice's MTA1 fetches Bob's shared resources from Bob's MBX2.</p>
</li>
</ul>
<h3 id="oauth-20-flow">OAuth 2.0 Flow </h3>
<p>We utilize two OAuth 2.0 grant types:</p>
<ol>
<li>
<p>Authorization Code Grant with PKCE: Facilitates user-driven interactions (e.g., Alice or Bob accessing their respective mailboxes using Webmail applications).</p>
</li>
<li>
<p>Token Exchange (RFC 8693) for Email Transfer with JWT Assertion and the Demonstrating Proof of Possession (DPoP) mechanism using the "message_digest" claim: Authorizes automated service-to-service interactions (e.g., Alice's MTA1 accessing Bob's Mailbox MBX2). We call this complex authorization mechanism Cross-Domain Authorization Grant and will describe it in more detail later.</p>
</li>
</ol>
<h3 id="client-registration">Client Registration </h3>
<p>We use the following OAuth 2.0 Client Registration Schema:</p>
<ul>
<li>
<p>The APP1 is registered at the AS1 as a public client.</p>
</li>
<li>
<p>The APP2 is registered at the AS2 as a public client.</p>
</li>
<li>
<p>The MBX1/MTA1 is registered at the AS1 as a confidential client.</p>
</li>
<li>
<p>The MBX2/MTA2 is registered at the AS2 as a confidential client.</p>
</li>
</ul>
<h3 id="service-discovery">Service Discovery </h3>
<p>In the OAuth 2.0-based internet mail architecture, the mailbox (locator) and the email address (user identity identifier) are separated. This separation allows users from the <a href="http://example.com">example.com</a> trust domain to have their mailboxes hosted in another domain, such as <a href="http://example.edu">example.edu</a>. This architecture always requires two DNS records: one for the identity provider and another for the storage provider. However, both providers may operate under the same trust domain, as we will assume in the following description.</p>
<p>We implement service discovery using these DNS records:</p>
<ol>
<li>
<p><code>_federizer._as._tcp.example.com. 3600 IN SRV 10 5 443 as1.example.com.</code></p>
<ul>
<li>Points either: (a) directly to the authorization service, or (b) to a redirect service that redirects http requests to the URL of the authorization service (e.g., <a href="http://example.com/as1">example.com/as1</a>), see Note 1. This is used by the MBX2/MTA2 service to verify that Alice's AS1 is the corresponding JWT Assertion issuer.</li>
</ul>
</li>
<li>
<p><code>_federizer._rs._tcp.example.com. 3600 IN SRV 10 5 443 rs1.example.com.</code></p>
<ul>
<li>Points either: (a) directly to the resource server, or (b) to a redirect service that redirects http requests to the URL of the resource server (e.g., <a href="http://example.com/rs1">example.com/rs1</a>), see Note 1. This is used by the MBX2/MTA2 agent to discover the MBX1/MTA1 service and by the MBX2/MTA2 service to verify that the MBX1/MTA1 agent is the correct client making the request, see Note 2.</li>
</ul>
</li>
<li>
<p><code>_federizer._as._tcp.example.net. 3600 IN SRV 10 5 443 as2.example.net.</code></p>
<ul>
<li>Points either: (a) directly to the authorization service, or (b) to a redirect service that redirects http requests to the URL of the authorization service (e.g., <a href="http://example.net/as2">example.net/as2</a>), see Note 1. This is used by the MBX1/MTA1 service to verify that Bob's AS2 is the corresponding JWT Assertion issuer.</li>
</ul>
</li>
<li>
<p><code>_federizer._rs._tcp.example.net. 3600 IN SRV 10 5 443 rs2.example.net.</code></p>
<ul>
<li>Points either: (a) directly to the resource server, or (b) to a redirect service that redirects http requests to the URL of the resource server (e.g., <a href="http://example.net/rs2">example.net/rs2</a>), see Note 1. This is used by the MBX1/MTA1 agent to discover the MBX2/MTA2 service and by the MBX1/MTA1 service to verify that the MBX2/MTA2 agent is the correct client making the request, see Note 2.</li>
</ul>
</li>
</ol>
<p>Note 1: DNS SRV records cannot point to a URL with a path, while using a URL with a specific path is common for Authorization Servers or Resource Servers. A trusted redirect service can run on the hostname specified in the SRV record and redirect (e.g., a 302 Found) http requests to the actual URL of the Authorization Server or Resource Server, including the path.</p>
<p>Note 2: We utilize the dual role feature of MBX1/MTA1 and MBX2/MTA2 entities to provide metadata about Client2 and Client3. When each MTA is registered with its respective AS as a confidential client, the sibling MTX resource server can supply metadata about its MTA, including the MTA client_id. This client_id, also included in the JWT Assertion as an "azp" claim, is used to verify that the correct client is making the request.</p>
<h3 id="conceptual-example">Conceptual Example </h3>
<ul>
<li>
<p>The External Resources owned by the author stored on the RS of the origin mailbox service are temporarily shared with recipients by creating a Placeholder Message which also acts as an Access Control List. Following a successful sharing process, using the Cross-Domain Authorization Grant, the Placeholder Message is sent to each recipient through the MTA operating within the origin trust domain. This Placeholder Message stores SHA-256 digests of the referenced External Resources in its <code>Content-ID</code> headers (see Figure 1 for an example of a Placeholder Message).</p>
</li>
<li>
<p>The MTA operating within the destination trust domain using the Cross-Domain Authorization Grant attempts to fetch the External Resources from the RS of the origin mailbox service. After successful authorization, the External Resource is fetched using a digest from the Content-ID header of the Placeholder Message as an identifier and is stored on the RS of the destination mailbox service. That means that each recipient becomes the owner of the corresponding copy of the referenced External Resource (a Signed Placeholder Message can prove it, as explained later—TBD), which they can download and use, or send to other recipients. Finally, the Webmail application downloads the relevant data from the RS of the destination mailbox service and reconstructs the original message according to the Placeholder Message source.</p>
</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token comment"># Email envelope</span>
<span class="token key atrule">headers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">From</span><span class="token punctuation">:</span> Alice &lt;alice@example.com<span class="token punctuation">&gt;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">Subject</span><span class="token punctuation">:</span> Vacation photo
  <span class="token punctuation">-</span> <span class="token key atrule">To</span><span class="token punctuation">:</span> Bob &lt;bob@example.net<span class="token punctuation">&gt;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">Message-ID</span><span class="token punctuation">:</span> &lt;b07d0cdf<span class="token punctuation">-</span>c6f4<span class="token punctuation">-</span>4f67<span class="token punctuation">-</span>b24c<span class="token punctuation">-</span>cc847a4c2df4@example.com<span class="token punctuation">&gt;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">X-Thread-ID</span><span class="token punctuation">:</span> &lt;68fb9177<span class="token punctuation">-</span>6853<span class="token punctuation">-</span>466a<span class="token punctuation">-</span>8f7d<span class="token punctuation">-</span>c96fbb885f81@example.com<span class="token punctuation">&gt;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">Content-Type</span><span class="token punctuation">:</span> multipart/mixed
<span class="token comment"># Email body</span>
<span class="token key atrule">parts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">Content-Type</span><span class="token punctuation">:</span> multipart/alternative
    <span class="token key atrule">parts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">Content-Disposition</span><span class="token punctuation">:</span> inline
          <span class="token punctuation">-</span> <span class="token key atrule">Content-ID</span><span class="token punctuation">:</span> &lt;aSQnmlBT6RndpDnwTSStJUVhlh9XL9_y2QXX42NhKuI<span class="token punctuation">&gt;</span>
          <span class="token punctuation">-</span> <span class="token key atrule">Content-Type</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> message/external<span class="token punctuation">-</span>body; access<span class="token punctuation">-</span>type='x<span class="token punctuation">-</span>content<span class="token punctuation">-</span>addressed<span class="token punctuation">-</span>uri';
              hash<span class="token punctuation">-</span>algorithm='sha256'; size='42'
            <span class="token punctuation">-</span> text/plain; charset=UTF<span class="token punctuation">-</span><span class="token number">8</span>
      <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">Content-Disposition</span><span class="token punctuation">:</span> inline
          <span class="token punctuation">-</span> <span class="token key atrule">Content-ID</span><span class="token punctuation">:</span> &lt;Y_ION3g8WQuqGzhsDlVrhAgQ0D7AbXu9T<span class="token punctuation">-</span>HSv3w<span class="token punctuation">-</span><span class="token punctuation">-</span>zY<span class="token punctuation">&gt;</span>
          <span class="token punctuation">-</span> <span class="token key atrule">Content-Type</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> message/external<span class="token punctuation">-</span>body; access<span class="token punctuation">-</span>type='x<span class="token punctuation">-</span>content<span class="token punctuation">-</span>addressed<span class="token punctuation">-</span>uri';
              hash<span class="token punctuation">-</span>algorithm='sha256'; size='109'
            <span class="token punctuation">-</span> text/html; charset=UTF<span class="token punctuation">-</span><span class="token number">8</span>
  <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">Content-Type</span><span class="token punctuation">:</span> multipart/mixed
    <span class="token key atrule">parts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">Content-Disposition</span><span class="token punctuation">:</span> attachment; filename='Venice.png'
          <span class="token punctuation">-</span> <span class="token key atrule">Content-ID</span><span class="token punctuation">:</span> &lt;1pzyqfFWbfhJ3hrydjL9jO9Qgeg70TgZQ_zpOkt4HOU<span class="token punctuation">&gt;</span>
          <span class="token punctuation">-</span> <span class="token key atrule">Content-Type</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> message/external<span class="token punctuation">-</span>body; access<span class="token punctuation">-</span>type='x<span class="token punctuation">-</span>content<span class="token punctuation">-</span>addressed<span class="token punctuation">-</span>uri';
              hash<span class="token punctuation">-</span>algorithm='sha256'; size='3520247'
            <span class="token punctuation">-</span> image/png
</code></pre><p>Fig. 1. An example of a draft Placeholder Message in YAML format.</p>
<p>In the example above, all headers are static, meaning they are part of the original email composition. Dynamic headers, such as <code>Date</code>, <code>Received</code>, <code>Forwarded-From</code>, <code>Forwarded-To</code>, and <code>Digest</code>, are added sequentially as the Placeholder Message passes through each mailbox service. The most recent dynamic header appears at the top of the list (see Figure 2). A <code>Digest</code> header is added at the top of the list before each mailbox service token exchange request (refer to the OAuth 2.0 Cross-Domain Authorization Grant sequence diagrams).</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">headers</span><span class="token punctuation">:</span>
<span class="token comment"># Email envelope</span>
  <span class="token comment"># Dynamic headers go here...</span>
  <span class="token punctuation">-</span> <span class="token key atrule">Received</span><span class="token punctuation">:</span> from example.net by example.org; Sun Dec 22 21<span class="token punctuation">:</span>40<span class="token punctuation">:</span>08 CEST 2024
  <span class="token punctuation">-</span> <span class="token key atrule">Digest</span><span class="token punctuation">:</span> &lt;1pzyqfFWbfhJ3hrydjL9jO9Qgeg70TgZQ_zpOkt4HOU<span class="token punctuation">&gt;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">Forwarded-To</span><span class="token punctuation">:</span> Bobby &lt;bobby@example.org<span class="token punctuation">&gt;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">Forwarded-From</span><span class="token punctuation">:</span> Bob &lt;bob@example.net<span class="token punctuation">&gt;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">Received</span><span class="token punctuation">:</span> from example.com by example.net; Sun Dec 22 20<span class="token punctuation">:</span>58<span class="token punctuation">:</span>14 CEST 2024
  <span class="token punctuation">-</span> <span class="token key atrule">Digest</span><span class="token punctuation">:</span> &lt;6G6Mkapa3<span class="token punctuation">-</span>Om7B6BVhPUBEsCLP6t6LAVP4bHxhQF5nc<span class="token punctuation">&gt;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">Date</span><span class="token punctuation">:</span> Sun Dec 22 20<span class="token punctuation">:</span>49<span class="token punctuation">:</span>35 CEST 2024
  <span class="token comment"># Static headers go here...</span>
  <span class="token punctuation">-</span> <span class="token key atrule">From</span><span class="token punctuation">:</span> Alice &lt;alice@example.com<span class="token punctuation">&gt;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">Subject</span><span class="token punctuation">:</span> Vacation photo
  <span class="token punctuation">-</span> <span class="token key atrule">To</span><span class="token punctuation">:</span> Bob &lt;bob@example.net<span class="token punctuation">&gt;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">Message-ID</span><span class="token punctuation">:</span> &lt;b07d0cdf<span class="token punctuation">-</span>c6f4<span class="token punctuation">-</span>4f67<span class="token punctuation">-</span>b24c<span class="token punctuation">-</span>cc847a4c2df4@example.com<span class="token punctuation">&gt;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">X-Thread-ID</span><span class="token punctuation">:</span> &lt;68fb9177<span class="token punctuation">-</span>6853<span class="token punctuation">-</span>466a<span class="token punctuation">-</span>8f7d<span class="token punctuation">-</span>c96fbb885f81@example.com<span class="token punctuation">&gt;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">Content-Type</span><span class="token punctuation">:</span> multipart/mixed
<span class="token comment"># Email body content go here...</span>
</code></pre><p>Fig. 2. An example of a forwarded Placeholder Message in YAML format with dynamic headers.</p>
<p>The "Date" header means that the message has been sent and is immutable—without the "Date" header it is a draft message.</p>
<h2 id="digital-assets">Digital Assets </h2>
<p>The user can digitally sign the Placeholder Message, referred to as a PGP Signed Placeholder Message, either as a whole (including all static headers and the email body) or in parts by headers (<code>Content-Disposition</code>, <code>Content-ID</code>, <code>Content-Type</code>) of the individual External Resources using the <code>application/pgp-signature</code> protocol. The signature transforms the External Resource into a digital asset that has verifiable authenticity, integrity, and data origin, provided the resource includes provenance metadata.</p>
<h2 id="resources-delivery-scenario">Resource(s) Delivery Scenario </h2>
<p>We describe the delivery of Alice's resources to Bob.</p>
<p>Alice wants to send a vacation photo to Bob. She creates a new Placeholder Message in YAML format using the APP1 compose form. Alice opens the compose form and fills in the "To", "Subject", and (optionally) "Text" fields. While composing the message, she uploads the photo to the MBX1/MTA1 service to add it as an External Resource to the Placeholder Message. After a successful upload, the service returns a digest of the uploaded photo. This digest is then added to the Placeholder Message as the value of the <code>Content-ID</code> header and an External Resource with the <code>Content-Disposition: attachment</code> header. The content of the "Text" field is posted as a resource to the MBX1/MTA1 service that returns a digest of the posted text. This digest is then added to the Placeholder Message as the value of the <code>Content-ID</code> header and an External Resource with the <code>Content-Disposition: inline</code> header. Finally, to initiate the delivery process, Alice presses the "Send" button, posting the Placeholder Message to the MBX1/MTA1 service.</p>
<p>The MBX1/MTA1 agent sends the Placeholder Message to the MBX2/MTA2 service, using the Cross-Domain Authorization Grant. After completing the validation process, the MBX2/MTA2 agent fetches the External Resources from the MBX1/MTA1 service using the Cross-Domain Authorization Grant and notifies the APP2 Webmail application that it has received a new email.</p>
<p>Upon receiving the notification, Bob's APP2 downloads the Placeholder Message from the MBX2/MTA2 service. Using the information contained within, APP2 downloads the corresponding External Resources with the <code>Content-Disposition: inline</code> header (the "Text" field) to accurately reconstruct and display the content of the original Placeholder Message (including the content of the "Text" field). After this  delivery process, Bob is able to download the External Resource with the <code>Content-Disposition: attachment</code> header (the vacation photo) identified by its digest from the MBX2/MTA service.</p>
<div style="break-after:page"></div>
<h2 id="sequence-diagrams">Sequence Diagrams </h2>
<h3 id="oauth-20-authorization-code-grant-with-pkce">OAuth 2.0 Authorization Code Grant with PKCE </h3>
<p>This diagram illustrates the sequence of interactions in an OAuth 2.0 Authorization Code Grant flow enhanced with Proof Key for Code Exchange (PKCE). It is used in the interaction of Alice's APP1 with Alice's MBX1/MTA1 service and also in the interaction of Bob's App2 with Bob's MBX2/MTA2 service.</p>
<h4 id="to-authorize-a-public-client-to-interact-with-the-backend-service">To authorize a public client to interact with the backend service: </h4>
<ul>
<li>We will use OAuth 2.0 Authorization Code Grant with PKCE (RFC 7636).</li>
<li>The client should be registered at the authorization server as a public client.</li>
</ul>
<h5 id="sequence-diagram">Sequence Diagram </h5>
<p class="plantuml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" data-diagram-type="SEQUENCE" height="960px" preserveAspectRatio="none" style="width:1213px;height:960px;background:#FFFFFF;" version="1.1" viewBox="0 0 1213 960" width="1213px" zoomAndPan="magnify"><title>OAuth 2.0 Authorization Code Grant with PKCE</title><defs></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="370.1113" x="420.6377" y="27.9951">OAuth 2.0 Authorization Code Grant with PKCE</text><g><title>User/Browser</title><rect fill="#FFFFFF" height="131.6641" style="stroke:#181818;stroke-width:1;" width="10" x="49.833" y="379.1172"></rect></g><g><title>Client Application</title><rect fill="#FFFFFF" height="711.9141" style="stroke:#181818;stroke-width:1;" width="10" x="263.3994" y="149.7266"></rect></g><g><title>Authorization Server</title><rect fill="#FFFFFF" height="438.2578" style="stroke:#181818;stroke-width:1;" width="10" x="710.873" y="349.9844"></rect></g><g><title>Resource Server</title><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1;" width="10" x="888.0381" y="832.5078"></rect></g><g><title>Code Verifier</title><rect fill="#FFFFFF" height="31.2969" style="stroke:#181818;stroke-width:1;" width="10" x="1015.4453" y="188.8594"></rect></g><g><title>Code Verifier</title><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1;" width="10" x="1015.4453" y="599.3125"></rect></g><g><title>Code Challenge</title><rect fill="#FFFFFF" height="31.2969" style="stroke:#181818;stroke-width:1;" width="10" x="1140.2446" y="259.2891"></rect></g><g><title>Code Challenge</title><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1;" width="10" x="1140.2446" y="657.5781"></rect></g><g><title>User/Browser</title><rect fill="transparent" height="761.0469" width="8" x="50.833" y="118.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="54" x2="54" y1="118.5938" y2="879.6406"></line></g><g><title>Client Application</title><rect fill="transparent" height="761.0469" width="8" x="264.3994" y="118.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="267.7974" x2="267.7974" y1="118.5938" y2="879.6406"></line></g><g><title>Authorization Server</title><rect fill="transparent" height="761.0469" width="8" x="711.873" y="118.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="715.8086" x2="715.8086" y1="118.5938" y2="879.6406"></line></g><g><title>Resource Server</title><rect fill="transparent" height="761.0469" width="8" x="889.0381" y="118.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="892.2881" x2="892.2881" y1="118.5938" y2="879.6406"></line></g><g><title>Code Verifier</title><rect fill="transparent" height="691.2656" width="8" x="1016.4453" y="188.375"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1019.7881" x2="1019.7881" y1="188.375" y2="879.6406"></line></g><g><title>Code Challenge</title><rect fill="transparent" height="620.8359" width="8" x="1141.2446" y="258.8047"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1145.1025" x2="1145.1025" y1="258.8047" y2="879.6406"></line></g><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93.666" x="5" y="115.292">User/Browser</text><ellipse cx="54.833" cy="50.7969" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"></ellipse><path d="M54.833,58.7969 L54.833,85.7969 M41.833,66.7969 L67.833,66.7969 M54.833,85.7969 L41.833,100.7969 M54.833,85.7969 L67.833,100.7969 " fill="transparent" style="stroke:#181818;stroke-width:0.5;"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93.666" x="5" y="891.6357">User/Browser</text><ellipse cx="54.833" cy="903.4375" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"></ellipse><path d="M54.833,911.4375 L54.833,938.4375 M41.833,919.4375 L67.833,919.4375 M54.833,938.4375 L41.833,953.4375 M54.833,938.4375 L67.833,953.4375 " fill="transparent" style="stroke:#181818;stroke-width:0.5;"></path><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="137.2041" x="199.7974" y="87.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="123.2041" x="206.7974" y="107.292">Client Application</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="137.2041" x="199.7974" y="878.6406"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="123.2041" x="206.7974" y="898.6357">Client Application</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="158.1289" x="636.8086" y="87.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="144.1289" x="643.8086" y="107.292">Authorization Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="158.1289" x="636.8086" y="878.6406"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="144.1289" x="643.8086" y="898.6357">Authorization Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="129.5" x="828.2881" y="87.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="115.5" x="835.2881" y="107.292">Resource Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="129.5" x="828.2881" y="878.6406"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="115.5" x="835.2881" y="898.6357">Resource Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105.3145" x="967.7881" y="878.6406"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91.3145" x="974.7881" y="898.6357">Code Verifier</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="124.2842" x="1083.1025" y="878.6406"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110.2842" x="1090.1025" y="898.6357">Code Challenge</text><g><title>User/Browser</title><rect fill="#FFFFFF" height="131.6641" style="stroke:#181818;stroke-width:1;" width="10" x="49.833" y="379.1172"></rect></g><g><title>Client Application</title><rect fill="#FFFFFF" height="711.9141" style="stroke:#181818;stroke-width:1;" width="10" x="263.3994" y="149.7266"></rect></g><g><title>Authorization Server</title><rect fill="#FFFFFF" height="438.2578" style="stroke:#181818;stroke-width:1;" width="10" x="710.873" y="349.9844"></rect></g><g><title>Resource Server</title><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1;" width="10" x="888.0381" y="832.5078"></rect></g><g><title>Code Verifier</title><rect fill="#FFFFFF" height="31.2969" style="stroke:#181818;stroke-width:1;" width="10" x="1015.4453" y="188.8594"></rect></g><g><title>Code Verifier</title><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1;" width="10" x="1015.4453" y="599.3125"></rect></g><g><title>Code Challenge</title><rect fill="#FFFFFF" height="31.2969" style="stroke:#181818;stroke-width:1;" width="10" x="1140.2446" y="259.2891"></rect></g><g><title>Code Challenge</title><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1;" width="10" x="1140.2446" y="657.5781"></rect></g><polygon fill="#181818" points="251.3994,145.7266,261.3994,149.7266,251.3994,153.7266,255.3994,149.7266" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="54.833" x2="257.3994" y1="149.7266" y2="149.7266"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189.5664" x="61.833" y="144.6606">Initiate authorization request</text><polygon fill="#181818" points="955.7881,174.8594,965.7881,178.8594,955.7881,182.8594,959.7881,178.8594" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="273.3994" x2="961.7881" y1="178.8594" y2="178.8594"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148.8779" x="280.3994" y="173.7935">Generate code_verifier</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105.3145" x="967.7881" y="157.7266"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91.3145" x="974.7881" y="177.7217">Code Verifier</text><polygon fill="#181818" points="284.3994,216.1563,274.3994,220.1563,284.3994,224.1563,280.3994,220.1563" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="278.3994" x2="1019.4453" y1="220.1563" y2="220.1563"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84.0303" x="290.3994" y="215.0903">code_verifier</text><polygon fill="#181818" points="1071.1025,245.2891,1081.1025,249.2891,1071.1025,253.2891,1075.1025,249.2891" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="273.3994" x2="1077.1025" y1="249.2891" y2="249.2891"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="354.6055" x="280.3994" y="244.2231">Generate code_challenge from code_verifier (SHA256)</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="124.2842" x="1083.1025" y="228.1563"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110.2842" x="1090.1025" y="248.1514">Code Challenge</text><polygon fill="#181818" points="284.3994,286.5859,274.3994,290.5859,284.3994,294.5859,280.3994,290.5859" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="278.3994" x2="1144.2446" y1="290.5859" y2="290.5859"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100.915" x="290.3994" y="285.52">code_challenge</text><polygon fill="#181818" points="698.873,345.9844,708.873,349.9844,698.873,353.9844,702.873,349.9844" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="273.3994" x2="704.873" y1="349.9844" y2="349.9844"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144.5933" x="280.3994" y="314.6528">Authorization Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="291.4082" x="280.3994" y="329.7856">(response_type=code, client_id, redirect_uri,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="403.4126" x="280.3994" y="344.9185">scope, state, code_challenge, code_challenge_method=S256)</text><polygon fill="#181818" points="70.833,375.1172,60.833,379.1172,70.833,383.1172,66.833,379.1172" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="64.833" x2="709.873" y1="379.1172" y2="379.1172"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152.9531" x="76.833" y="374.0513">Authentication Request</text><polygon fill="#181818" points="698.873,404.25,708.873,408.25,698.873,412.25,702.873,408.25" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="59.833" x2="704.873" y1="408.25" y2="408.25"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="83.624" x="66.833" y="403.1841">Authenticate</text><polygon fill="#181818" points="70.833,433.3828,60.833,437.3828,70.833,441.3828,66.833,437.3828" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="64.833" x2="709.873" y1="437.3828" y2="437.3828"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192.5371" x="76.833" y="432.3169">Consent Request (if required)</text><polygon fill="#181818" points="698.873,462.5156,708.873,466.5156,698.873,470.5156,702.873,466.5156" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="59.833" x2="704.873" y1="466.5156" y2="466.5156"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175.8682" x="66.833" y="461.4497">Grant Consent (if required)</text><polygon fill="#181818" points="284.3994,506.7813,274.3994,510.7813,284.3994,514.7813,280.3994,510.7813" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="278.3994" x2="709.873" y1="510.7813" y2="510.7813"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124.4839" x="290.3994" y="490.5825">Authorization Code</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82.6909" x="290.3994" y="505.7153">(code, state)</text><polygon fill="#181818" points="698.873,566.1797,708.873,570.1797,698.873,574.1797,702.873,570.1797" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="273.3994" x2="704.873" y1="570.1797" y2="570.1797"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97.1826" x="280.3994" y="534.8481">Token Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="336.9019" x="280.3994" y="549.981">(grant_type=authorization_code, code, redirect_uri,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151.436" x="280.3994" y="565.1138">client_id, code_verifier)</text><polygon fill="#181818" points="1003.4453,595.3125,1013.4453,599.3125,1003.4453,603.3125,1007.4453,599.3125" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="720.873" x2="1009.4453" y1="599.3125" y2="599.3125"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142.9365" x="727.873" y="594.2466">Retrieve code_verifier</text><polygon fill="#181818" points="731.873,624.4453,721.873,628.4453,731.873,632.4453,727.873,628.4453" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="725.873" x2="1019.4453" y1="628.4453" y2="628.4453"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84.0303" x="737.873" y="623.3794">code_verifier</text><polygon fill="#181818" points="1128.2446,653.5781,1138.2446,657.5781,1128.2446,661.5781,1132.2446,657.5781" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="720.873" x2="1134.2446" y1="657.5781" y2="657.5781"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="354.6055" x="727.873" y="652.5122">Generate code_challenge from code_verifier (SHA256)</text><polygon fill="#181818" points="731.873,682.7109,721.873,686.7109,731.873,690.7109,727.873,686.7109" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="725.873" x2="1144.2446" y1="686.7109" y2="686.7109"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100.915" x="737.873" y="681.645">code_challenge</text><line style="stroke:#181818;stroke-width:1;" x1="720.873" x2="762.873" y1="715.8438" y2="715.8438"></line><line style="stroke:#181818;stroke-width:1;" x1="762.873" x2="762.873" y1="715.8438" y2="728.8438"></line><line style="stroke:#181818;stroke-width:1;" x1="721.873" x2="762.873" y1="728.8438" y2="728.8438"></line><polygon fill="#181818" points="731.873,724.8438,721.873,728.8438,731.873,732.8438,727.873,728.8438" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143.165" x="727.873" y="710.7778">Verify code_challenge</text><polygon fill="#181818" points="284.3994,784.2422,274.3994,788.2422,284.3994,792.2422,280.3994,788.2422" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="278.3994" x2="714.873" y1="788.2422" y2="788.2422"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="261.6377" x="290.3994" y="752.9106">Access Token, Refresh Token (optional),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190.6836" x="290.3994" y="768.0435">ID Token (if OpenID Connect)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="413.4736" x="290.3994" y="783.1763">(access_token, token_type, expires_in, refresh_token, id_token)</text><polygon fill="#181818" points="876.0381,828.5078,886.0381,832.5078,876.0381,836.5078,880.0381,832.5078" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="273.3994" x2="882.0381" y1="832.5078" y2="832.5078"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176.2109" x="280.3994" y="812.3091">Access Protected Resource</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97.2651" x="280.3994" y="827.4419">(access_token)</text><polygon fill="#181818" points="279.3994,857.6406,269.3994,861.6406,279.3994,865.6406,275.3994,861.6406" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="273.3994" x2="892.0381" y1="861.6406" y2="861.6406"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127.3467" x="285.3994" y="856.5747">Protected Resource</text><!--SRC=[lLLDRzGm4BtdLrXxsaWfe4fmMAb8Iq2buj1g5pXLYY9djckHni7sRYc_dXdRIMmdI1K7BXjxCXzlvhtP665QOBVRapcoorTl61sa4hzh8sJ7Ija0krPrPzYJG8-xB-MdBAkvaOfzqw1OhTcA3gy_AFc4prNMrye8BdgAALi1-20dVzpsVIkuJHwxhkB2Ur1dp4QXzC9Tuu0TQ7bI74BVmURzCulnuhq7ic4tdJ2YDi3gg9g2doVGXXeJPthj_3EkW6uhEuRleCH1-49a6GoPxutg1EODkuOE52NWQAxEW_jK9KeINDX5W3aERc0vF89Q7kksXUu1HgoZ9G4xsbEqV7Z13ae-nY3OUlzvU_dsNHwt4jG8R_DcnjnfDqie9_etYJXtZhNxRgr0zxBJK9dd7gweHi6upL29fa1w6w60c-gaH77VQIvxTD06onO9elHUFGAMRAxsSRk19gSZeIN1EPnOt0jz03g5azUepRH17mYBcKjg4mVZKxArE5ZrOdzDlfZIRUyG5_k75GAIvly1E6CtLJkqFEJDzh9CrrVv0qAQ7WYAuoZQlyepPdyJiW8Q8mtcoNZYpTk1KGBE_xXvOGylsxuvbl-rM3EiBrYk66sOmJRqd2Rwcqmu1wqTomME_81hUFIahsLFpDPjZXpUV1oigBxR7iY0WkoGvHnbKTiybN5vxCEAf63mgqSjw4fqf0kRVt0JZJj5MWpMSb9a_4qOOTyfQH00DAD30YKW8VcinDTe9lEi8RuaJqYG- -3y0G00]--></g></svg></p><p>The sequence diagram of this standard flow is self-explanatory.</p>
<div style="break-after:page"></div>
<h3 id="oauth-20-cross-domain-authorization-grant">OAuth 2.0 Cross-Domain Authorization Grant </h3>
<p>We need to replace the DomainKeys Identified Mail (DKIM) email authentication method by the Cross-Domain Authorization Grant, which we present as a JWT Assertion to Mailbox services running in different trust domains.</p>
<h4 id="to-authorize-the-transfer-of-the-placeholder-message">To authorize the transfer of the Placeholder Message: </h4>
<ul>
<li>We will use the OAuth 2.0 Token Exchange grant type (RFC 8693).</li>
<li>We will use a JWT Assertion with the "message_digest" claim (a SHA-256 digest of the Placeholder Message that serves as a digital signature). This assertion embodies the DKIM signature.</li>
<li>We will use the DPoP mechanism to bind the JWT Assertion to the client.</li>
<li>The MBX1/MTA1 agent should be registered at the AS1 authorization server as a confidential client.</li>
</ul>
<h5 id="sequence-diagram-1">Sequence Diagram </h5>
<p class="plantuml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" data-diagram-type="SEQUENCE" height="1509px" preserveAspectRatio="none" style="width:1807px;height:1509px;background:#FFFFFF;" version="1.1" viewBox="0 0 1807 1509" width="1807px" zoomAndPan="magnify"><title>OAuth 2.0 Token Exchange for transferring Placeholder Messages using JWT Assertion and DPoP.</title><defs></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="769.7949" x="525.6768" y="27.9951">OAuth 2.0 Token Exchange for transferring Placeholder Messages using JWT Assertion and DPoP.</text><g><title>MBX1/MTA1</title><rect fill="#FFFFFF" height="1344.5078" style="stroke:#181818;stroke-width:1;" width="10" x="390.4688" y="104.7266"></rect></g><g><title>MBX1/MTA1</title><rect fill="#D3D3D3" height="501.3906" style="stroke:#181818;stroke-width:1;" width="10" x="395.4688" y="947.8438"></rect></g><g><title>AS1 Authorization Server</title><rect fill="#FFFFFF" height="330.5938" style="stroke:#181818;stroke-width:1;" width="10" x="926.5747" y="438.5859"></rect></g><g><title>MBX2/MTA2</title><rect fill="#FFFFFF" height="360.8594" style="stroke:#181818;stroke-width:1;" width="10" x="1393.396" y="1011.1094"></rect></g><g><title>Client1</title><rect fill="transparent" height="1400.6406" width="8" x="32.7188" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="36" x2="36" y1="73.5938" y2="1474.2344"></line></g><g><title>MBX1/MTA1</title><rect fill="transparent" height="1400.6406" width="8" x="391.4688" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="395.4619" x2="395.4619" y1="73.5938" y2="1474.2344"></line></g><g><title>AS1 Authorization Server</title><rect fill="transparent" height="1400.6406" width="8" x="927.5747" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="930.5996" x2="930.5996" y1="73.5938" y2="1474.2344"></line></g><g><title>MBX2/MTA2</title><rect fill="transparent" height="1400.6406" width="8" x="1394.396" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1398.3892" x2="1398.3892" y1="73.5938" y2="1474.2344"></line></g><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="63.4375" x="5" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="49.4375" x="12" y="62.292">Client1</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="63.4375" x="5" y="1473.2344"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="49.4375" x="12" y="1493.2295">Client1</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="346.4619" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="353.4619" y="62.292">MBX1/MTA1</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="346.4619" y="1473.2344"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="353.4619" y="1493.2295">MBX1/MTA1</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="189.9502" x="836.5996" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="175.9502" x="843.5996" y="62.292">AS1 Authorization Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="189.9502" x="836.5996" y="1473.2344"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="175.9502" x="843.5996" y="1493.2295">AS1 Authorization Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="1349.3892" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="1356.3892" y="62.292">MBX2/MTA2</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="1349.3892" y="1473.2344"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="1356.3892" y="1493.2295">MBX2/MTA2</text><g><title>MBX1/MTA1</title><rect fill="#FFFFFF" height="1344.5078" style="stroke:#181818;stroke-width:1;" width="10" x="390.4688" y="104.7266"></rect></g><g><title>MBX1/MTA1</title><rect fill="#D3D3D3" height="501.3906" style="stroke:#181818;stroke-width:1;" width="10" x="395.4688" y="947.8438"></rect></g><g><title>AS1 Authorization Server</title><rect fill="#FFFFFF" height="330.5938" style="stroke:#181818;stroke-width:1;" width="10" x="926.5747" y="438.5859"></rect></g><g><title>MBX2/MTA2</title><rect fill="#FFFFFF" height="360.8594" style="stroke:#181818;stroke-width:1;" width="10" x="1393.396" y="1011.1094"></rect></g><polygon fill="#181818" points="378.4688,100.7266,388.4688,104.7266,378.4688,108.7266,382.4688,104.7266" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="36.7188" x2="384.4688" y1="104.7266" y2="104.7266"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334.75" x="43.7188" y="99.6606">Send Placeholder Message (includes Access Token)</text><line style="stroke:#181818;stroke-width:1;" x1="400.4688" x2="442.4688" y1="133.8594" y2="133.8594"></line><line style="stroke:#181818;stroke-width:1;" x1="442.4688" x2="442.4688" y1="133.8594" y2="146.8594"></line><line style="stroke:#181818;stroke-width:1;" x1="401.4688" x2="442.4688" y1="146.8594" y2="146.8594"></line><polygon fill="#181818" points="411.4688,142.8594,401.4688,146.8594,411.4688,150.8594,407.4688,146.8594" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273.3428" x="407.4688" y="128.7935">Generate DPoP Proof (using new key pair)</text><line style="stroke:#181818;stroke-width:1;" x1="400.4688" x2="442.4688" y1="175.9922" y2="175.9922"></line><line style="stroke:#181818;stroke-width:1;" x1="442.4688" x2="442.4688" y1="175.9922" y2="188.9922"></line><line style="stroke:#181818;stroke-width:1;" x1="401.4688" x2="442.4688" y1="188.9922" y2="188.9922"></line><polygon fill="#181818" points="411.4688,184.9922,401.4688,188.9922,411.4688,192.9922,407.4688,188.9922" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="403.1079" x="407.4688" y="170.9263">Add the new (Date) header at the top of Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="400.4688" x2="442.4688" y1="233.2578" y2="233.2578"></line><line style="stroke:#181818;stroke-width:1;" x1="442.4688" x2="442.4688" y1="233.2578" y2="246.2578"></line><line style="stroke:#181818;stroke-width:1;" x1="401.4688" x2="442.4688" y1="246.2578" y2="246.2578"></line><polygon fill="#181818" points="411.4688,242.2578,401.4688,246.2578,411.4688,250.2578,407.4688,246.2578" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="417.7329" x="407.4688" y="213.0591">Create Placeholder Message Digest msg_digest=&lt;SHA256 hash</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164.6265" x="411.6011" y="228.1919">of Placeholder Message&gt;</text><line style="stroke:#181818;stroke-width:1;" x1="400.4688" x2="442.4688" y1="290.5234" y2="290.5234"></line><line style="stroke:#181818;stroke-width:1;" x1="442.4688" x2="442.4688" y1="290.5234" y2="303.5234"></line><line style="stroke:#181818;stroke-width:1;" x1="401.4688" x2="442.4688" y1="303.5234" y2="303.5234"></line><polygon fill="#181818" points="411.4688,299.5234,401.4688,303.5234,411.4688,307.5234,407.4688,303.5234" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="457.1392" x="407.4688" y="270.3247">Add the new (Digest: &lt;msg_digest&gt;) header at the top of Placeholder</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="56.9766" x="411.6011" y="285.4575">Message</text><polygon fill="#181818" points="914.5747,434.5859,924.5747,438.5859,914.5747,442.5859,918.5747,438.5859" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="400.4688" x2="920.5747" y1="438.5859" y2="438.5859"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165.0645" x="407.4688" y="327.5903">Token Exchange Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="415.6763" x="407.4688" y="342.7231">(grant_type=urn:ietf:params:oauth:grant-type:token-exchange,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="401.1909" x="407.4688" y="357.856">requested_token_type=urn:ietf:params:oauth:token-type:jwt,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215.7695" x="407.4688" y="372.9888">subject_token=&lt;Access Token&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="450.1377" x="407.4688" y="388.1216">subject_token_type=urn:ietf:params:oauth:token-type:access_token,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201.5698" x="407.4688" y="403.2544">msg=&lt;Placeholder Message&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136.8301" x="407.4688" y="418.3872">dpop=&lt;DPoP Proof&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185.9546" x="407.4688" y="433.52">client_id=&lt;MTA1 client ID&gt;)</text><line style="stroke:#181818;stroke-width:1;" x1="936.5747" x2="978.5747" y1="467.7188" y2="467.7188"></line><line style="stroke:#181818;stroke-width:1;" x1="978.5747" x2="978.5747" y1="467.7188" y2="480.7188"></line><line style="stroke:#181818;stroke-width:1;" x1="937.5747" x2="978.5747" y1="480.7188" y2="480.7188"></line><polygon fill="#181818" points="947.5747,476.7188,937.5747,480.7188,947.5747,484.7188,943.5747,480.7188" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146.0532" x="943.5747" y="462.6528">Validate Access Token</text><line style="stroke:#181818;stroke-width:1;" x1="936.5747" x2="978.5747" y1="509.8516" y2="509.8516"></line><line style="stroke:#181818;stroke-width:1;" x1="978.5747" x2="978.5747" y1="509.8516" y2="522.8516"></line><line style="stroke:#181818;stroke-width:1;" x1="937.5747" x2="978.5747" y1="522.8516" y2="522.8516"></line><polygon fill="#181818" points="947.5747,518.8516,937.5747,522.8516,947.5747,526.8516,943.5747,522.8516" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128.9717" x="943.5747" y="504.7856">Validate DPoP Proof</text><line style="stroke:#181818;stroke-width:1;" x1="936.5747" x2="978.5747" y1="567.1172" y2="567.1172"></line><line style="stroke:#181818;stroke-width:1;" x1="978.5747" x2="978.5747" y1="567.1172" y2="580.1172"></line><line style="stroke:#181818;stroke-width:1;" x1="937.5747" x2="978.5747" y1="580.1172" y2="580.1172"></line><polygon fill="#181818" points="947.5747,576.1172,937.5747,580.1172,947.5747,584.1172,943.5747,580.1172" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="432.8213" x="943.5747" y="546.9185">Validate Placeholder Message format and content of the From, To,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104.4063" x="947.707" y="562.0513">Cc, Bcc headers</text><line style="stroke:#181818;stroke-width:1;" x1="936.5747" x2="978.5747" y1="609.25" y2="609.25"></line><line style="stroke:#181818;stroke-width:1;" x1="978.5747" x2="978.5747" y1="609.25" y2="622.25"></line><line style="stroke:#181818;stroke-width:1;" x1="937.5747" x2="978.5747" y1="622.25" y2="622.25"></line><polygon fill="#181818" points="947.5747,618.25,937.5747,622.25,947.5747,626.25,943.5747,622.25" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="431.8374" x="943.5747" y="604.1841">Verify top header (Digest: &lt;msg_digest&gt;) of Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="936.5747" x2="978.5747" y1="681.6484" y2="681.6484"></line><line style="stroke:#181818;stroke-width:1;" x1="978.5747" x2="978.5747" y1="681.6484" y2="694.6484"></line><line style="stroke:#181818;stroke-width:1;" x1="937.5747" x2="978.5747" y1="694.6484" y2="694.6484"></line><polygon fill="#181818" points="947.5747,690.6484,937.5747,694.6484,947.5747,698.6484,943.5747,694.6484" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="238.3989" x="943.5747" y="646.3169">Create JWT Assertion (azp=client_id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245.7622" x="947.707" y="661.4497">cnf={jkt=SHA256(JWK Thumbprint)},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382.4526" x="947.707" y="676.5825">message_digest={alg="SHA256", value=&lt;msg_digest&gt;})</text><polygon fill="#181818" points="411.4688,765.1797,401.4688,769.1797,411.4688,773.1797,407.4688,769.1797" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="405.4688" x2="930.5747" y1="769.1797" y2="769.1797"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174.6938" x="417.4688" y="718.7153">Token Exchange Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218.4482" x="417.4688" y="733.8481">(access_token=&lt;JWT Assertion&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="328.7388" x="417.4688" y="748.981">token_type=urn:ietf:params:oauth:token-type:jwt,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377.8252" x="417.4688" y="764.1138">issued_token_type=urn:ietf:params:oauth:token-type:jwt)</text><line style="stroke:#181818;stroke-width:1;" x1="400.4688" x2="442.4688" y1="798.3125" y2="798.3125"></line><line style="stroke:#181818;stroke-width:1;" x1="442.4688" x2="442.4688" y1="798.3125" y2="811.3125"></line><line style="stroke:#181818;stroke-width:1;" x1="401.4688" x2="442.4688" y1="811.3125" y2="811.3125"></line><polygon fill="#181818" points="411.4688,807.3125,401.4688,811.3125,411.4688,815.3125,407.4688,811.3125" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="497.3262" x="407.4688" y="793.2466">Generate new DPoP Proof (using the same key pair, for MBX2/MTA2 service)</text><line style="stroke:#181818;stroke-width:1;" x1="400.4688" x2="442.4688" y1="855.5781" y2="855.5781"></line><line style="stroke:#181818;stroke-width:1;" x1="442.4688" x2="442.4688" y1="855.5781" y2="868.5781"></line><line style="stroke:#181818;stroke-width:1;" x1="401.4688" x2="442.4688" y1="868.5781" y2="868.5781"></line><polygon fill="#181818" points="411.4688,864.5781,401.4688,868.5781,411.4688,872.5781,407.4688,868.5781" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="502.106" x="407.4688" y="835.3794">Use DNS to discover MBX2/MTA2 service using the domain part of recipient's</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91.3428" x="411.6011" y="850.5122">email address</text><line style="stroke:#181818;stroke-width:1;" x1="400.4688" x2="442.4688" y1="897.7109" y2="897.7109"></line><line style="stroke:#181818;stroke-width:1;" x1="442.4688" x2="442.4688" y1="897.7109" y2="910.7109"></line><line style="stroke:#181818;stroke-width:1;" x1="401.4688" x2="442.4688" y1="910.7109" y2="910.7109"></line><polygon fill="#181818" points="411.4688,906.7109,401.4688,910.7109,411.4688,914.7109,407.4688,910.7109" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="388.5464" x="407.4688" y="892.645">Create Placeholder Message request to MBX2/MTA2 service</text><line style="stroke:#181818;stroke-width:1;" x1="400.4688" x2="447.4688" y1="934.8438" y2="934.8438"></line><line style="stroke:#181818;stroke-width:1;" x1="447.4688" x2="447.4688" y1="934.8438" y2="947.8438"></line><line style="stroke:#181818;stroke-width:1;" x1="406.4688" x2="447.4688" y1="947.8438" y2="947.8438"></line><polygon fill="#181818" points="416.4688,943.8438,406.4688,947.8438,416.4688,951.8438,412.4688,947.8438" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="237.7451" x="412.4688" y="929.7778">Queue Placeholder Message request</text><polygon fill="#181818" points="47.7188,977.9766,37.7188,981.9766,47.7188,985.9766,43.7188,981.9766" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="41.7188" x2="394.4688" y1="981.9766" y2="981.9766"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="244.0166" x="53.7188" y="976.9106">Placeholder Message request queued</text><polygon fill="#181818" points="1381.396,1007.1094,1391.396,1011.1094,1381.396,1015.1094,1385.396,1011.1094" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="405.4688" x2="1387.396" y1="1011.1094" y2="1011.1094"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="726.6416" x="412.4688" y="1006.0435">Post Placeholder Message (Placeholder Message, Authorization: Bearer &lt;JWT Assertion&gt;, DPoP: &lt;DPoP Proof&gt;)</text><line style="stroke:#181818;stroke-width:1;" x1="1403.396" x2="1445.396" y1="1040.2422" y2="1040.2422"></line><line style="stroke:#181818;stroke-width:1;" x1="1445.396" x2="1445.396" y1="1040.2422" y2="1053.2422"></line><line style="stroke:#181818;stroke-width:1;" x1="1404.396" x2="1445.396" y1="1053.2422" y2="1053.2422"></line><polygon fill="#181818" points="1414.396,1049.2422,1404.396,1053.2422,1414.396,1057.2422,1410.396,1053.2422" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="374.9941" x="1410.396" y="1035.1763">Validate DPoP Proof (using "jkt" from JWT Assertion "cnf")</text><line style="stroke:#181818;stroke-width:1;" x1="1403.396" x2="1445.396" y1="1112.6406" y2="1112.6406"></line><line style="stroke:#181818;stroke-width:1;" x1="1445.396" x2="1445.396" y1="1112.6406" y2="1125.6406"></line><line style="stroke:#181818;stroke-width:1;" x1="1404.396" x2="1445.396" y1="1125.6406" y2="1125.6406"></line><polygon fill="#181818" points="1414.396,1121.6406,1404.396,1125.6406,1414.396,1129.6406,1410.396,1125.6406" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="311.3398" x="1410.396" y="1077.3091">Validate JWT Assertion (verify message_digest),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377.5205" x="1414.5283" y="1092.4419">use DNS discovery to verify that AS1 is the corresponding</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="132.3169" x="1414.5283" y="1107.5747">JWT Assertion issuer</text><line style="stroke:#181818;stroke-width:1;" x1="1403.396" x2="1445.396" y1="1169.9063" y2="1169.9063"></line><line style="stroke:#181818;stroke-width:1;" x1="1445.396" x2="1445.396" y1="1169.9063" y2="1182.9063"></line><line style="stroke:#181818;stroke-width:1;" x1="1404.396" x2="1445.396" y1="1182.9063" y2="1182.9063"></line><polygon fill="#181818" points="1414.396,1178.9063,1404.396,1182.9063,1414.396,1186.9063,1410.396,1182.9063" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382.2114" x="1410.396" y="1149.7075">Use DNS discovery to verify that MTA1 is the correct client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127.5625" x="1414.5283" y="1164.8403">making the request</text><line style="stroke:#181818;stroke-width:1;" x1="1403.396" x2="1445.396" y1="1227.1719" y2="1227.1719"></line><line style="stroke:#181818;stroke-width:1;" x1="1445.396" x2="1445.396" y1="1227.1719" y2="1240.1719"></line><line style="stroke:#181818;stroke-width:1;" x1="1404.396" x2="1445.396" y1="1240.1719" y2="1240.1719"></line><polygon fill="#181818" points="1414.396,1236.1719,1404.396,1240.1719,1414.396,1244.1719,1410.396,1240.1719" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273.0762" x="1410.396" y="1206.9731">Create JWT Signed Placeholder Message=</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="278.8462" x="1410.396" y="1222.106">&lt;Placeholder Message&gt;||&lt;JWT Assertion&gt;</text><line style="stroke:#181818;stroke-width:1;" x1="1403.396" x2="1445.396" y1="1329.8359" y2="1329.8359"></line><line style="stroke:#181818;stroke-width:1;" x1="1445.396" x2="1445.396" y1="1329.8359" y2="1342.8359"></line><line style="stroke:#181818;stroke-width:1;" x1="1404.396" x2="1445.396" y1="1342.8359" y2="1342.8359"></line><polygon fill="#181818" points="1414.396,1338.8359,1404.396,1342.8359,1414.396,1346.8359,1410.396,1342.8359" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="371.3442" x="1410.396" y="1264.2388">Store JWT Signed Placeholder Message in the store using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="364.438" x="1414.5283" y="1279.3716">message_digest from the JWT Assertion as an identifier,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="370.373" x="1414.5283" y="1294.5044">and use it as an Access Control List to allow/deny access</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="385.6201" x="1414.5283" y="1309.6372">to the External Resource stored on the MBX1/MTA1 service</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179.0737" x="1414.5283" y="1324.77">during the fetching process</text><polygon fill="#181818" points="416.4688,1367.9688,406.4688,1371.9688,416.4688,1375.9688,412.4688,1371.9688" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="410.4688" x2="1397.396" y1="1371.9688" y2="1371.9688"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="283.6323" x="422.4688" y="1366.9028">Placeholder Message Delivery Confirmation</text><line style="stroke:#181818;stroke-width:1;" x1="405.4688" x2="447.4688" y1="1401.1016" y2="1401.1016"></line><line style="stroke:#181818;stroke-width:1;" x1="447.4688" x2="447.4688" y1="1401.1016" y2="1414.1016"></line><line style="stroke:#181818;stroke-width:1;" x1="406.4688" x2="447.4688" y1="1414.1016" y2="1414.1016"></line><polygon fill="#181818" points="416.4688,1410.1016,406.4688,1414.1016,416.4688,1418.1016,412.4688,1414.1016" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="253.7729" x="412.4688" y="1396.0356">Dequeue Placeholder Message request</text><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="405.4688" x2="447.4688" y1="1448.2344" y2="1448.2344"></line><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="447.4688" x2="447.4688" y1="1448.2344" y2="1461.2344"></line><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="400.4688" x2="447.4688" y1="1461.2344" y2="1461.2344"></line><polygon fill="#181818" points="410.4688,1457.2344,400.4688,1461.2344,410.4688,1465.2344,406.4688,1461.2344" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260.2666" x="412.4688" y="1443.1685">Placeholder Message request dequeued</text><!--SRC=[bLPDSzis4BthL-oeXqWpSb9hfZbmHCt8bfisZLktSfeUDED1Y9K8cm9e09IZVFptBa1I8YLOjcyaiNZxW7txbbRO3E6lIM5J6Bx-6QxL7Kgu-9AaJ2uH5ag3rKoQ1Mejv1AkCfPWgZAE6YxH6BP40uLnI-y_NSF46DHMA0bCSfXUgQlNdPpHbqJaJ5hedcS2fJtj0ZDGFRS3Bi_-EtrpUJqfGowa5NQp5pAPdO8ZhBJuodoo6UerQh_3BPIl1xX3Xpjiu0uxdOe3d8phN16X4VV0GQ4dP98Ld4uyIHBwLjvMlyCIAzRCufPkftfemRv3YTf5kMk1AwtK0dhbrKbyW3lSGCw4xWStJpW7cwAFx4q9fGyfCaUEMRzWLGu46A0Tn3lNwAY4JZaLL5CBAxEyuVun7ir-cmn_UGifC-bSFf9c_0pU7Yw2qGvx_FGvA6DzacQANQ6ZVTN-W_S5OSzbRqdQjJTsasDSQ1a9j8k8PC5M9bAC028VSE828kj0Jh026SobBc6Gt_YbOp3bNWzp-s1fhoa-ts9YovtngAcNyVxoCu6PnoYt40JTOJmArO7MUAxoUBJJsNXEmdL2ln4y7hdkWl8TVf-E6_fjD4zdzxn_s_-oJ70VtZZLS-9tX9uJ7T8c-T6AXEBC9L7IkXEGM9nkVjLgDI0gT7euJmPmbYILiionPAZ5OkD5Lydm4P4-qbgF8rSDrZR57lkQnzjAEAg9NCJVRkziNBPOx_sdF-0wBLQVSx9Rs__XObPbiheRlx5i6NVB-Eu0rYmhC6wo_T5lLw_PZmUTOd8b3LAhDEKLZrgydQHUtWB2cEBblTFlS0pgyQYbEdivj5Md2yDMkFNMWHzesr40TBwrIB0VHlzeIB9_paWTm8L9bBlCWxsmIyNLYWa9RkmulMYasUDA_SfG4P7MCc2SQxhbbrfovKIEoG618DRV1HP7eGvc5lpqGInJ-qwpJUCs2BEQaD5HOlSk7mzSuv3sAGe8ZjF0nq5xiaTmXapJyhuWVRMfIHiUTp27XpMVOOjFm8vgmNIf4xkm82lPQzmkzMctVnnkhzNNfRMqcxVl-hceT5MBolaFLE4s9NjpFpZ2U4qbIclVevpuqTvs4jzYEaZhurD9_1HePabiDHISvR2xMjMrO4996YOt4qk9mT-cU2w3S-hxzxsY1bFChD9FPG3gEj_hFjQNyi0sowgwgBt_L4FJ10IdSuk5GEqAvCQBAvAmrN8rwCvfv6YLmGTHzYBBClNmXhPke7HFsakVNPABBnQrP9bpM5Nef2B7GPLKjx-vTHlJLbxe-j8NQ9FKlUHQ9Jl36BRDFFZtXfdmvIQo2-6c9PsowQbrRuHiOuhtJnf7qnkECgczWMFb3WSaw4VvLHEEDAl3M3CtwO-VwBJpFm00]--></g></svg></p><p>The sequence diagram of this flow is self-explanatory.</p>
<div style="break-after:page"></div>
<h4 id="to-authorize-the-fetching-of-external-resources">To authorize the fetching of External Resources: </h4>
<ul>
<li>We will use the OAuth 2.0 Token Exchange grant type (RFC 8693).</li>
<li>We will use a JWT Assertion with the "message_digest" claim (a SHA-256 digest of the Placeholder Message that serves as a digital signature). This assertion embodies the DKIM signature.</li>
<li>We will use the DPoP mechanism to bind the JWT Assertion to the client.</li>
<li>The MBX2/MTA2 agent should be registered at the AS2 authorization server as a confidential client.</li>
<li>The token exchange and fetching process can begin after the successful Placeholder Message delivery.</li>
</ul>
<h5 id="sequence-diagram-2">Sequence Diagram </h5>
<p class="plantuml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" data-diagram-type="SEQUENCE" height="1536px" preserveAspectRatio="none" style="width:1792px;height:1536px;background:#FFFFFF;" version="1.1" viewBox="0 0 1792 1536" width="1792px" zoomAndPan="magnify"><title>OAuth 2.0 Token Exchange for fetching External Resources using JWT Assertion and DPoP.</title><defs></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="716.2285" x="544.9526" y="27.9951">OAuth 2.0 Token Exchange for fetching External Resources using JWT Assertion and DPoP.</text><g><title>MBX1/MTA1</title><rect fill="#FFFFFF" height="270.0625" style="stroke:#181818;stroke-width:1;" width="10" x="49.0068" y="1128.9063"></rect></g><g><title>AS2 Authorization Server</title><rect fill="#FFFFFF" height="273.3281" style="stroke:#181818;stroke-width:1;" width="10" x="752.2148" y="627.6484"></rect></g><g><title>MBX2/MTA2</title><rect fill="#FFFFFF" height="1371.5078" style="stroke:#181818;stroke-width:1;" width="10" x="1295.5508" y="104.7266"></rect></g><g><title>MBX2/MTA2</title><rect fill="#D3D3D3" height="381.4609" style="stroke:#181818;stroke-width:1;" width="10" x="1300.5508" y="1094.7734"></rect></g><g><title>MBX1/MTA1</title><rect fill="transparent" height="1427.6406" width="8" x="50.0068" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="54" x2="54" y1="73.5938" y2="1501.2344"></line></g><g><title>AS2 Authorization Server</title><rect fill="transparent" height="1427.6406" width="8" x="753.2148" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="756.2397" x2="756.2397" y1="73.5938" y2="1501.2344"></line></g><g><title>MBX2/MTA2</title><rect fill="transparent" height="1427.6406" width="8" x="1296.5508" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1300.5439" x2="1300.5439" y1="73.5938" y2="1501.2344"></line></g><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="5" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="12" y="62.292">MBX1/MTA1</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="5" y="1500.2344"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="12" y="1520.2295">MBX1/MTA1</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="189.9502" x="662.2397" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="175.9502" x="669.2397" y="62.292">AS2 Authorization Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="189.9502" x="662.2397" y="1500.2344"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="175.9502" x="669.2397" y="1520.2295">AS2 Authorization Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="1251.5439" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="1258.5439" y="62.292">MBX2/MTA2</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="1251.5439" y="1500.2344"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="1258.5439" y="1520.2295">MBX2/MTA2</text><g><title>MBX1/MTA1</title><rect fill="#FFFFFF" height="270.0625" style="stroke:#181818;stroke-width:1;" width="10" x="49.0068" y="1128.9063"></rect></g><g><title>AS2 Authorization Server</title><rect fill="#FFFFFF" height="273.3281" style="stroke:#181818;stroke-width:1;" width="10" x="752.2148" y="627.6484"></rect></g><g><title>MBX2/MTA2</title><rect fill="#FFFFFF" height="1371.5078" style="stroke:#181818;stroke-width:1;" width="10" x="1295.5508" y="104.7266"></rect></g><g><title>MBX2/MTA2</title><rect fill="#D3D3D3" height="381.4609" style="stroke:#181818;stroke-width:1;" width="10" x="1300.5508" y="1094.7734"></rect></g><polygon fill="#181818" points="1283.5508,100.7266,1293.5508,104.7266,1283.5508,108.7266,1287.5508,104.7266" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="54.0068" x2="1289.5508" y1="104.7266" y2="104.7266"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="726.6416" x="61.0068" y="99.6606">Post Placeholder Message (Placeholder Message, Authorization: Bearer &lt;JWT Assertion&gt;, DPoP: &lt;DPoP Proof&gt;)</text><line style="stroke:#181818;stroke-width:1;" x1="1305.5508" x2="1347.5508" y1="133.8594" y2="133.8594"></line><line style="stroke:#181818;stroke-width:1;" x1="1347.5508" x2="1347.5508" y1="133.8594" y2="146.8594"></line><line style="stroke:#181818;stroke-width:1;" x1="1306.5508" x2="1347.5508" y1="146.8594" y2="146.8594"></line><polygon fill="#181818" points="1316.5508,142.8594,1306.5508,146.8594,1316.5508,150.8594,1312.5508,146.8594" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="374.9941" x="1312.5508" y="128.7935">Validate DPoP Proof (using "jkt" from JWT Assertion "cnf")</text><line style="stroke:#181818;stroke-width:1;" x1="1305.5508" x2="1347.5508" y1="206.2578" y2="206.2578"></line><line style="stroke:#181818;stroke-width:1;" x1="1347.5508" x2="1347.5508" y1="206.2578" y2="219.2578"></line><line style="stroke:#181818;stroke-width:1;" x1="1306.5508" x2="1347.5508" y1="219.2578" y2="219.2578"></line><polygon fill="#181818" points="1316.5508,215.2578,1306.5508,219.2578,1316.5508,223.2578,1312.5508,219.2578" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="311.3398" x="1312.5508" y="170.9263">Validate JWT Assertion (verify message_digest),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377.5205" x="1316.6831" y="186.0591">use DNS discovery to verify that AS1 is the corresponding</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="132.3169" x="1316.6831" y="201.1919">JWT Assertion issuer</text><line style="stroke:#181818;stroke-width:1;" x1="1305.5508" x2="1347.5508" y1="263.5234" y2="263.5234"></line><line style="stroke:#181818;stroke-width:1;" x1="1347.5508" x2="1347.5508" y1="263.5234" y2="276.5234"></line><line style="stroke:#181818;stroke-width:1;" x1="1306.5508" x2="1347.5508" y1="276.5234" y2="276.5234"></line><polygon fill="#181818" points="1316.5508,272.5234,1306.5508,276.5234,1316.5508,280.5234,1312.5508,276.5234" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382.2114" x="1312.5508" y="243.3247">Use DNS discovery to verify that MTA1 is the correct client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127.5625" x="1316.6831" y="258.4575">making the request</text><line style="stroke:#181818;stroke-width:1;" x1="1305.5508" x2="1347.5508" y1="320.7891" y2="320.7891"></line><line style="stroke:#181818;stroke-width:1;" x1="1347.5508" x2="1347.5508" y1="320.7891" y2="333.7891"></line><line style="stroke:#181818;stroke-width:1;" x1="1306.5508" x2="1347.5508" y1="333.7891" y2="333.7891"></line><polygon fill="#181818" points="1316.5508,329.7891,1306.5508,333.7891,1316.5508,337.7891,1312.5508,333.7891" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273.0762" x="1312.5508" y="300.5903">Create JWT Signed Placeholder Message=</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="278.8462" x="1312.5508" y="315.7231">&lt;Placeholder Message&gt;||&lt;JWT Assertion&gt;</text><line style="stroke:#181818;stroke-width:1;" x1="1305.5508" x2="1347.5508" y1="423.4531" y2="423.4531"></line><line style="stroke:#181818;stroke-width:1;" x1="1347.5508" x2="1347.5508" y1="423.4531" y2="436.4531"></line><line style="stroke:#181818;stroke-width:1;" x1="1306.5508" x2="1347.5508" y1="436.4531" y2="436.4531"></line><polygon fill="#181818" points="1316.5508,432.4531,1306.5508,436.4531,1316.5508,440.4531,1312.5508,436.4531" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="371.3442" x="1312.5508" y="357.856">Store JWT Signed Placeholder Message in the store using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="364.438" x="1316.6831" y="372.9888">message_digest from the JWT Assertion as an identifier,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="370.373" x="1316.6831" y="388.1216">and use it as an Access Control List to allow/deny access</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="385.6201" x="1316.6831" y="403.2544">to the External Resource stored on the MBX1/MTA1 service</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179.0737" x="1316.6831" y="418.3872">during the fetching process</text><polygon fill="#181818" points="65.0068,461.5859,55.0068,465.5859,65.0068,469.5859,61.0068,465.5859" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="59.0068" x2="1294.5508" y1="465.5859" y2="465.5859"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="283.6323" x="71.0068" y="460.52">Placeholder Message Delivery Confirmation</text><line style="stroke:#181818;stroke-width:1;" x1="1305.5508" x2="1347.5508" y1="494.7188" y2="494.7188"></line><line style="stroke:#181818;stroke-width:1;" x1="1347.5508" x2="1347.5508" y1="494.7188" y2="507.7188"></line><line style="stroke:#181818;stroke-width:1;" x1="1306.5508" x2="1347.5508" y1="507.7188" y2="507.7188"></line><polygon fill="#181818" points="1316.5508,503.7188,1306.5508,507.7188,1316.5508,511.7188,1312.5508,507.7188" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273.3428" x="1312.5508" y="489.6528">Generate DPoP Proof (using new key pair)</text><polygon fill="#181818" points="773.2148,623.6484,763.2148,627.6484,773.2148,631.6484,769.2148,627.6484" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="767.2148" x2="1294.5508" y1="627.6484" y2="627.6484"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165.0645" x="779.2148" y="531.7856">Token Exchange Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="415.6763" x="779.2148" y="546.9185">(grant_type=urn:ietf:params:oauth:grant-type:token-exchange,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="401.1909" x="779.2148" y="562.0513">requested_token_type=urn:ietf:params:oauth:token-type:jwt,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="216.6899" x="779.2148" y="577.1841">subject_token=&lt;JWT Assertion&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382.3574" x="779.2148" y="592.3169">subject_token_type=urn:ietf:params:oauth:token-type:jwt,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="279.0684" x="779.2148" y="607.4497">msg=&lt;JWT Signed Placeholder Message&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="326.917" x="779.2148" y="622.5825">dpop=&lt;DPoP Proof&gt;,client_id=&lt;MTA2 client ID&gt;)</text><line style="stroke:#181818;stroke-width:1;" x1="762.2148" x2="804.2148" y1="656.7813" y2="656.7813"></line><line style="stroke:#181818;stroke-width:1;" x1="804.2148" x2="804.2148" y1="656.7813" y2="669.7813"></line><line style="stroke:#181818;stroke-width:1;" x1="763.2148" x2="804.2148" y1="669.7813" y2="669.7813"></line><polygon fill="#181818" points="773.2148,665.7813,763.2148,669.7813,773.2148,673.7813,769.2148,669.7813" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146.9736" x="769.2148" y="651.7153">Validate JWT Assertion</text><line style="stroke:#181818;stroke-width:1;" x1="762.2148" x2="804.2148" y1="698.9141" y2="698.9141"></line><line style="stroke:#181818;stroke-width:1;" x1="804.2148" x2="804.2148" y1="698.9141" y2="711.9141"></line><line style="stroke:#181818;stroke-width:1;" x1="763.2148" x2="804.2148" y1="711.9141" y2="711.9141"></line><polygon fill="#181818" points="773.2148,707.9141,763.2148,711.9141,773.2148,715.9141,769.2148,711.9141" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128.9717" x="769.2148" y="693.8481">Validate DPoP Proof</text><line style="stroke:#181818;stroke-width:1;" x1="762.2148" x2="804.2148" y1="741.0469" y2="741.0469"></line><line style="stroke:#181818;stroke-width:1;" x1="804.2148" x2="804.2148" y1="741.0469" y2="754.0469"></line><line style="stroke:#181818;stroke-width:1;" x1="763.2148" x2="804.2148" y1="754.0469" y2="754.0469"></line><polygon fill="#181818" points="773.2148,750.0469,763.2148,754.0469,773.2148,758.0469,769.2148,754.0469" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="509.3359" x="769.2148" y="735.981">Verify top header (Digest: &lt;msg_digest&gt;) of JWT Signed Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="762.2148" x2="804.2148" y1="813.4453" y2="813.4453"></line><line style="stroke:#181818;stroke-width:1;" x1="804.2148" x2="804.2148" y1="813.4453" y2="826.4453"></line><line style="stroke:#181818;stroke-width:1;" x1="763.2148" x2="804.2148" y1="826.4453" y2="826.4453"></line><polygon fill="#181818" points="773.2148,822.4453,763.2148,826.4453,773.2148,830.4453,769.2148,826.4453" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="238.3989" x="769.2148" y="778.1138">Create JWT Assertion (azp=client_id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245.7622" x="773.3472" y="793.2466">cnf={jkt=SHA256(JWK Thumbprint)},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382.4526" x="773.3472" y="808.3794">message_digest={alg="SHA256", value=&lt;msg_digest&gt;})</text><polygon fill="#181818" points="1283.5508,896.9766,1293.5508,900.9766,1283.5508,904.9766,1287.5508,900.9766" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="757.2148" x2="1289.5508" y1="900.9766" y2="900.9766"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174.6938" x="764.2148" y="850.5122">Token Exchange Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218.4482" x="764.2148" y="865.645">(access_token=&lt;JWT Assertion&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="328.7388" x="764.2148" y="880.7778">token_type=urn:ietf:params:oauth:token-type:jwt,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377.8252" x="764.2148" y="895.9106">issued_token_type=urn:ietf:params:oauth:token-type:jwt)</text><line style="stroke:#181818;stroke-width:1;" x1="1305.5508" x2="1347.5508" y1="945.2422" y2="945.2422"></line><line style="stroke:#181818;stroke-width:1;" x1="1347.5508" x2="1347.5508" y1="945.2422" y2="958.2422"></line><line style="stroke:#181818;stroke-width:1;" x1="1306.5508" x2="1347.5508" y1="958.2422" y2="958.2422"></line><polygon fill="#181818" points="1316.5508,954.2422,1306.5508,958.2422,1316.5508,962.2422,1312.5508,958.2422" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="337.4033" x="1312.5508" y="925.0435">Generate new DPoP Proof (using the same key pair,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155.7905" x="1316.6831" y="940.1763">for MBX1/MTA1 service)</text><line style="stroke:#181818;stroke-width:1;" x1="1305.5508" x2="1347.5508" y1="1002.5078" y2="1002.5078"></line><line style="stroke:#181818;stroke-width:1;" x1="1347.5508" x2="1347.5508" y1="1002.5078" y2="1015.5078"></line><line style="stroke:#181818;stroke-width:1;" x1="1306.5508" x2="1347.5508" y1="1015.5078" y2="1015.5078"></line><polygon fill="#181818" points="1316.5508,1011.5078,1306.5508,1015.5078,1316.5508,1019.5078,1312.5508,1015.5078" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="430.3267" x="1312.5508" y="982.3091">Use DNS to discover MBX1/MTA1 service using the domain part of</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150.4268" x="1316.6831" y="997.4419">sender's email address</text><line style="stroke:#181818;stroke-width:1;" x1="1305.5508" x2="1347.5508" y1="1044.6406" y2="1044.6406"></line><line style="stroke:#181818;stroke-width:1;" x1="1347.5508" x2="1347.5508" y1="1044.6406" y2="1057.6406"></line><line style="stroke:#181818;stroke-width:1;" x1="1306.5508" x2="1347.5508" y1="1057.6406" y2="1057.6406"></line><polygon fill="#181818" points="1316.5508,1053.6406,1306.5508,1057.6406,1316.5508,1061.6406,1312.5508,1057.6406" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="472.583" x="1312.5508" y="1039.5747">Create the Fetching of External Resource request to MBX1/MTA1 service</text><line style="stroke:#181818;stroke-width:1;" x1="1305.5508" x2="1352.5508" y1="1081.7734" y2="1081.7734"></line><line style="stroke:#181818;stroke-width:1;" x1="1352.5508" x2="1352.5508" y1="1081.7734" y2="1094.7734"></line><line style="stroke:#181818;stroke-width:1;" x1="1311.5508" x2="1352.5508" y1="1094.7734" y2="1094.7734"></line><polygon fill="#181818" points="1321.5508,1090.7734,1311.5508,1094.7734,1321.5508,1098.7734,1317.5508,1094.7734" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="296.3149" x="1317.5508" y="1076.7075">Queue Fetching of External Resource request</text><polygon fill="#181818" points="70.0068,1124.9063,60.0068,1128.9063,70.0068,1132.9063,66.0068,1128.9063" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="64.0068" x2="1299.5508" y1="1128.9063" y2="1128.9063"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="916.0938" x="76.0068" y="1123.8403">Get External Resource (msg=&lt;JWT Signed Placeholder Message&gt;,Content-ID, Authorization: Bearer &lt;JWT Assertion&gt;, DPoP: &lt;DPoP Proof&gt;)</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="1158.0391" y2="1158.0391"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="1158.0391" y2="1171.0391"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="1171.0391" y2="1171.0391"></line><polygon fill="#181818" points="70.0068,1167.0391,60.0068,1171.0391,70.0068,1175.0391,66.0068,1171.0391" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="374.9941" x="66.0068" y="1152.9731">Validate DPoP Proof (using "jkt" from JWT Assertion "cnf")</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="1200.1719" y2="1200.1719"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="1200.1719" y2="1213.1719"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="1213.1719" y2="1213.1719"></line><polygon fill="#181818" points="70.0068,1209.1719,60.0068,1213.1719,70.0068,1217.1719,66.0068,1213.1719" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="669.208" x="66.0068" y="1195.106">Validate JWT Assertion, use DNS discovery to verify that AS2 is the corresponding JWT Assertion issuer</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="1257.4375" y2="1257.4375"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="1257.4375" y2="1270.4375"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="1270.4375" y2="1270.4375"></line><polygon fill="#181818" points="70.0068,1266.4375,60.0068,1270.4375,70.0068,1274.4375,66.0068,1270.4375" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382.2114" x="66.0068" y="1237.2388">Use DNS discovery to verify that MTA2 is the correct client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127.5625" x="70.1392" y="1252.3716">making the request</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="1299.5703" y2="1299.5703"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="1299.5703" y2="1312.5703"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="1312.5703" y2="1312.5703"></line><polygon fill="#181818" points="70.0068,1308.5703,60.0068,1312.5703,70.0068,1316.5703,66.0068,1312.5703" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="610.0098" x="66.0068" y="1294.5044">Verify msg and use it as an Access Control List to allow/deny access to the External Resource</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="1356.8359" y2="1356.8359"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="1356.8359" y2="1369.8359"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="1369.8359" y2="1369.8359"></line><polygon fill="#181818" points="70.0068,1365.8359,60.0068,1369.8359,70.0068,1373.8359,66.0068,1369.8359" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="600.8945" x="66.0068" y="1336.6372">Find External Resource in Store using Content-ID (file name of the External Resource equals</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190.3472" x="70.1392" y="1351.77">the Content-ID header value)</text><polygon fill="#181818" points="1288.5508,1394.9688,1298.5508,1398.9688,1288.5508,1402.9688,1292.5508,1398.9688" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="54.0068" x2="1294.5508" y1="1398.9688" y2="1398.9688"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166.8672" x="61.0068" y="1393.9028">Return External Resource</text><line style="stroke:#181818;stroke-width:1;" x1="1310.5508" x2="1352.5508" y1="1428.1016" y2="1428.1016"></line><line style="stroke:#181818;stroke-width:1;" x1="1352.5508" x2="1352.5508" y1="1428.1016" y2="1441.1016"></line><line style="stroke:#181818;stroke-width:1;" x1="1311.5508" x2="1352.5508" y1="1441.1016" y2="1441.1016"></line><polygon fill="#181818" points="1321.5508,1437.1016,1311.5508,1441.1016,1321.5508,1445.1016,1317.5508,1441.1016" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312.3428" x="1317.5508" y="1423.0356">Dequeue Fetching of External Resource request</text><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="1310.5508" x2="1352.5508" y1="1475.2344" y2="1475.2344"></line><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="1352.5508" x2="1352.5508" y1="1475.2344" y2="1488.2344"></line><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="1305.5508" x2="1352.5508" y1="1488.2344" y2="1488.2344"></line><polygon fill="#181818" points="1315.5508,1484.2344,1305.5508,1488.2344,1315.5508,1492.2344,1311.5508,1488.2344" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="318.8364" x="1317.5508" y="1470.1685">Fetching of External Resource request dequeued</text><!--SRC=[hLTBRziu4BxxLmoyXzg0qzO2jWSXCk3MRRVTPkl6sMqF0G9M7DbCP59BKicwZ_- -GqcszM1Sf-Z9DZdlcU_Zs0gR8hoVvdO5mUEdSA5kKCBB_-8Laqk4H6b8qCOh8PTqQb5Bbi8v6fNh60tanbsy_NW1KsDGMw4aCCbXDbVpnxsCqKaiCYOjzC-UVne_ERkOZll03BoKLjZDk2aoNGJW8b5QV665hGNgMzI5XhieVtRi1ivkKBCRz7gL0pYPRCz2c2jZOPwo65SgvQZX38rXbER0SpXgXXB2SsIQhayRsKv6HQuXdBeFc6kbaicmns8hRfd5TZn18vv_M2guazhhmg0iQV_wnlOXqMhTgcu_bab_UDXSKsD09HF91jPbNbTSBD7OuUXIKll8zryBuCB4YiGsO1LKudR5B4mNOn26lYF4IciqcPASuYFTfXDXJ4wTyONrzu-SkA5eU8ajnAb0QSdDcjsuUhWxZV_c5BdNoGkDsymNOYcH-_eSNSfJp_7asxTMKxqk5bRf7ta08OjGJI5RjDBbqAXysLKdrSAD8UY0u9ItI0Hgro279TSaOQlhQKomC_12IQjL2ky4sQDoiZHLTqz8TGEia21TEdPEEgWjW-EWob1tk0GAv5R4IAeyrzkYxz2VQUKCxqkpgyquz9PYXgaesat19aAl2nZvWV0Q9Me_42JUmGrk86D23nlQUq88sxHrNaxAfHmiDP74bTra6ELQXW9j4X9ziBK95IC3OI5muWH2wuoSO6M4obyD7FAhukgGcLAtC7DzPqdNv9-lQP1BpQXD6gtx1rbUcsLfx_unT0vufhAepagZ4bDNWaUdZYyhZC6RMPsmQZJRstzlrzjFDSSex0Cw95snWyfWXSmbDfWLs26UfVGh84s6G7Dok187dDGeeqQMx4iMxGhb84Xy6tqbDeuMVqo3tvyDtdxy4ovM-VfpHXYnm- -Z3i2ZhonTHlrIlZ-2MvRc6DK3_pvi5hUEXSueEyurXCf1YUnx9-hXarIGzeE7UzZZw1sNWyXsEEwYk-1AjiOTn5qrtTBHOQLXx-3ZGcItVL-wkh1tnjMQ4KUx3OA6XvmPb3GkZmmWNQJ0EDSDbkk-CSxCgoqhKYfTWgrummNLYSLh-KEE-P56Ewi5_FPEB5VsjMORJud6hWNMOsvm58suTuQWSF9czYlNeR5dFHl_WdNe7dCDZT4nIq_WNNeEhJnDryUiFC73LvvMVjLQPvO_loRSkoHuFRuIvASxIeIdnNxVWVtCm20HzEz2Ee1JB_tR26N8qc9VeUkQRaNy1NdM6bo7pJbQ8YnFy3M2sawS3tOpLzsZWTTTVCZ4SKJ0IqUyruqiy1tz3m00]--></g></svg></p><p>The sequence diagram of this flow is self-explanatory. Take note of the use of a JWT Signed Placeholder Message as an Access Control List in the fetch request.</p>
<div style="break-after:page"></div>
<h4 id="to-authorize-relayingforwarding-of-the-placeholder-message">To authorize relaying/forwarding of the Placeholder Message: </h4>
<ul>
<li>We will use the OAuth 2.0 Token Exchange grant type (RFC 8693).</li>
<li>We will use a JWT Assertion with the "message_digest" claim (a SHA-256 digest of the Placeholder Message that serves as a digital signature). This assertion embodies the DKIM signature.</li>
<li>A forwarding policy can be set on the authorization server e.g., each user may/may not set their own forwarding rules on the authorization server.</li>
<li>The forwarding MBX2/MTA2 entity should not fetch the External Resources—only the final destination MBX3/MTA3 agent should.</li>
<li>We will use the DPoP mechanism to bind the JWT Assertion to the client.</li>
<li>The token exchange and relaying/forwarding process can begin after the successful Placeholder Message delivery.</li>
</ul>
<p>Suppose we have another trust domain, <a href="http://example.org">example.org</a>, and user Bob has the two email addresses: <a href="mailto:bob@example.net">bob@example.net</a> and <a href="mailto:bobby@example.org">bobby@example.org</a>.</p>
<p>A sequence diagram illustrating relaying/forwarding process where the MBX2/MTA2 entity forwards a Placeholder Message to the destination MBX3/MTA3 service.</p>
<h5 id="sequence-diagram-3">Sequence Diagram </h5>
<p class="plantuml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" data-diagram-type="SEQUENCE" height="2015px" preserveAspectRatio="none" style="width:1780px;height:2015px;background:#FFFFFF;" version="1.1" viewBox="0 0 1780 2015" width="1780px" zoomAndPan="magnify"><title>OAuth 2.0 Token Exchange for relaying/forwarding Placeholder Message using JWT Assertion and DPoP.</title><defs></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="822.3154" x="486.085" y="27.9951">OAuth 2.0 Token Exchange for relaying/forwarding Placeholder Message using JWT Assertion and DPoP.</text><g><title>MBX2/MTA2</title><rect fill="#FFFFFF" height="1819.8984" style="stroke:#181818;stroke-width:1;" width="10" x="392.2813" y="134.9922"></rect></g><g><title>MBX2/MTA2</title><rect fill="#D3D3D3" height="501.3906" style="stroke:#181818;stroke-width:1;" width="10" x="397.2813" y="1453.5"></rect></g><g><title>AS2 Authorization Server</title><rect fill="#FFFFFF" height="360.8594" style="stroke:#181818;stroke-width:1;" width="10" x="923.6074" y="913.9766"></rect></g><g><title>MBX3/MTA3</title><rect fill="#FFFFFF" height="360.8594" style="stroke:#181818;stroke-width:1;" width="10" x="1366.7329" y="1516.7656"></rect></g><g><title>MBX1/MTA1</title><rect fill="transparent" height="1906.2969" width="8" x="50.0068" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="54" x2="54" y1="73.5938" y2="1979.8906"></line></g><g><title>MBX2/MTA2</title><rect fill="transparent" height="1906.2969" width="8" x="393.2813" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="397.2744" x2="397.2744" y1="73.5938" y2="1979.8906"></line></g><g><title>AS2 Authorization Server</title><rect fill="transparent" height="1906.2969" width="8" x="924.6074" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="927.6323" x2="927.6323" y1="73.5938" y2="1979.8906"></line></g><g><title>MBX3/MTA3</title><rect fill="transparent" height="1906.2969" width="8" x="1367.7329" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1371.7261" x2="1371.7261" y1="73.5938" y2="1979.8906"></line></g><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="5" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="12" y="62.292">MBX1/MTA1</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="5" y="1978.8906"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="12" y="1998.8857">MBX1/MTA1</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="348.2744" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="355.2744" y="62.292">MBX2/MTA2</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="348.2744" y="1978.8906"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="355.2744" y="1998.8857">MBX2/MTA2</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="189.9502" x="833.6323" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="175.9502" x="840.6323" y="62.292">AS2 Authorization Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="189.9502" x="833.6323" y="1978.8906"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="175.9502" x="840.6323" y="1998.8857">AS2 Authorization Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="1322.7261" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="1329.7261" y="62.292">MBX3/MTA3</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="1322.7261" y="1978.8906"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="1329.7261" y="1998.8857">MBX3/MTA3</text><g><title>MBX2/MTA2</title><rect fill="#FFFFFF" height="1819.8984" style="stroke:#181818;stroke-width:1;" width="10" x="392.2813" y="134.9922"></rect></g><g><title>MBX2/MTA2</title><rect fill="#D3D3D3" height="501.3906" style="stroke:#181818;stroke-width:1;" width="10" x="397.2813" y="1453.5"></rect></g><g><title>AS2 Authorization Server</title><rect fill="#FFFFFF" height="360.8594" style="stroke:#181818;stroke-width:1;" width="10" x="923.6074" y="913.9766"></rect></g><g><title>MBX3/MTA3</title><rect fill="#FFFFFF" height="360.8594" style="stroke:#181818;stroke-width:1;" width="10" x="1366.7329" y="1516.7656"></rect></g><polygon fill="#181818" points="380.2813,130.9922,390.2813,134.9922,380.2813,138.9922,384.2813,134.9922" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="54.0068" x2="386.2813" y1="134.9922" y2="134.9922"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="319.2744" x="61.0068" y="99.6606">Post Placeholder Message (Placeholder Message,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="258.6479" x="65.1392" y="114.7935">Authorization: Bearer &lt;JWT Assertion&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140.4546" x="65.1392" y="129.9263">DPoP: &lt;DPoP Proof&gt;)</text><line style="stroke:#181818;stroke-width:1;" x1="402.2813" x2="444.2813" y1="164.125" y2="164.125"></line><line style="stroke:#181818;stroke-width:1;" x1="444.2813" x2="444.2813" y1="164.125" y2="177.125"></line><line style="stroke:#181818;stroke-width:1;" x1="403.2813" x2="444.2813" y1="177.125" y2="177.125"></line><polygon fill="#181818" points="413.2813,173.125,403.2813,177.125,413.2813,181.125,409.2813,177.125" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="374.9941" x="409.2813" y="159.0591">Validate DPoP Proof (using "jkt" from JWT Assertion "cnf")</text><line style="stroke:#181818;stroke-width:1;" x1="402.2813" x2="444.2813" y1="221.3906" y2="221.3906"></line><line style="stroke:#181818;stroke-width:1;" x1="444.2813" x2="444.2813" y1="221.3906" y2="234.3906"></line><line style="stroke:#181818;stroke-width:1;" x1="403.2813" x2="444.2813" y1="234.3906" y2="234.3906"></line><polygon fill="#181818" points="413.2813,230.3906,403.2813,234.3906,413.2813,238.3906,409.2813,234.3906" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="495.4346" x="409.2813" y="201.1919">Validate JWT Assertion (verify message_digest), use DNS discovery to verify</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="329.875" x="413.4136" y="216.3247">that AS1 is the corresponding JWT Assertion issuer</text><line style="stroke:#181818;stroke-width:1;" x1="402.2813" x2="444.2813" y1="278.6563" y2="278.6563"></line><line style="stroke:#181818;stroke-width:1;" x1="444.2813" x2="444.2813" y1="278.6563" y2="291.6563"></line><line style="stroke:#181818;stroke-width:1;" x1="403.2813" x2="444.2813" y1="291.6563" y2="291.6563"></line><polygon fill="#181818" points="413.2813,287.6563,403.2813,291.6563,413.2813,295.6563,409.2813,291.6563" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382.2114" x="409.2813" y="258.4575">Use DNS discovery to verify that MTA1 is the correct client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127.5625" x="413.4136" y="273.5903">making the request</text><line style="stroke:#181818;stroke-width:1;" x1="402.2813" x2="444.2813" y1="335.9219" y2="335.9219"></line><line style="stroke:#181818;stroke-width:1;" x1="444.2813" x2="444.2813" y1="335.9219" y2="348.9219"></line><line style="stroke:#181818;stroke-width:1;" x1="403.2813" x2="444.2813" y1="348.9219" y2="348.9219"></line><polygon fill="#181818" points="413.2813,344.9219,403.2813,348.9219,413.2813,352.9219,409.2813,348.9219" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273.0762" x="409.2813" y="315.7231">Create JWT Signed Placeholder Message=</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="278.8462" x="409.2813" y="330.856">&lt;Placeholder Message&gt;||&lt;JWT Assertion&gt;</text><line style="stroke:#181818;stroke-width:1;" x1="402.2813" x2="444.2813" y1="438.5859" y2="438.5859"></line><line style="stroke:#181818;stroke-width:1;" x1="444.2813" x2="444.2813" y1="438.5859" y2="451.5859"></line><line style="stroke:#181818;stroke-width:1;" x1="403.2813" x2="444.2813" y1="451.5859" y2="451.5859"></line><polygon fill="#181818" points="413.2813,447.5859,403.2813,451.5859,413.2813,455.5859,409.2813,451.5859" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="371.3442" x="409.2813" y="372.9888">Store JWT Signed Placeholder Message in the store using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="364.438" x="413.4136" y="388.1216">message_digest from the JWT Assertion as an identifier,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="370.373" x="413.4136" y="403.2544">and use it as an Access Control List to allow/deny access</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="385.6201" x="413.4136" y="418.3872">to the External Resource stored on the MBX1/MTA1 service</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179.0737" x="413.4136" y="433.52">during the fetching process</text><polygon fill="#181818" points="65.0068,476.7188,55.0068,480.7188,65.0068,484.7188,61.0068,480.7188" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="59.0068" x2="391.2813" y1="480.7188" y2="480.7188"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="283.6323" x="71.0068" y="475.6528">Placeholder Message Delivery Confirmation</text><line style="stroke:#181818;stroke-width:1;" x1="402.2813" x2="444.2813" y1="509.8516" y2="509.8516"></line><line style="stroke:#181818;stroke-width:1;" x1="444.2813" x2="444.2813" y1="509.8516" y2="522.8516"></line><line style="stroke:#181818;stroke-width:1;" x1="403.2813" x2="444.2813" y1="522.8516" y2="522.8516"></line><polygon fill="#181818" points="413.2813,518.8516,403.2813,522.8516,413.2813,526.8516,409.2813,522.8516" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273.3428" x="409.2813" y="504.7856">Generate DPoP Proof (using new key pair)</text><line style="stroke:#181818;stroke-width:1;" x1="402.2813" x2="444.2813" y1="567.1172" y2="567.1172"></line><line style="stroke:#181818;stroke-width:1;" x1="444.2813" x2="444.2813" y1="567.1172" y2="580.1172"></line><line style="stroke:#181818;stroke-width:1;" x1="403.2813" x2="444.2813" y1="580.1172" y2="580.1172"></line><polygon fill="#181818" points="413.2813,576.1172,403.2813,580.1172,413.2813,584.1172,409.2813,580.1172" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="487.5889" x="409.2813" y="546.9185">Add the new (Forwarded-From: &lt;bob@example.net&gt;) header at the top of</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214.5698" x="413.4136" y="562.0513">JWT Signed Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="402.2813" x2="444.2813" y1="624.3828" y2="624.3828"></line><line style="stroke:#181818;stroke-width:1;" x1="444.2813" x2="444.2813" y1="624.3828" y2="637.3828"></line><line style="stroke:#181818;stroke-width:1;" x1="403.2813" x2="444.2813" y1="637.3828" y2="637.3828"></line><polygon fill="#181818" points="413.2813,633.3828,403.2813,637.3828,413.2813,641.3828,409.2813,637.3828" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="486.2051" x="409.2813" y="604.1841">Add the new (Forwarded-To: &lt;bobby@example.org&gt;) header at the top of</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214.5698" x="413.4136" y="619.3169">JWT Signed Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="402.2813" x2="444.2813" y1="666.5156" y2="666.5156"></line><line style="stroke:#181818;stroke-width:1;" x1="444.2813" x2="444.2813" y1="666.5156" y2="679.5156"></line><line style="stroke:#181818;stroke-width:1;" x1="403.2813" x2="444.2813" y1="679.5156" y2="679.5156"></line><polygon fill="#181818" points="413.2813,675.5156,403.2813,679.5156,413.2813,683.5156,409.2813,679.5156" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="480.6064" x="409.2813" y="661.4497">Add the new (Date) header at the top of JWT Signed Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="402.2813" x2="444.2813" y1="723.7813" y2="723.7813"></line><line style="stroke:#181818;stroke-width:1;" x1="444.2813" x2="444.2813" y1="723.7813" y2="736.7813"></line><line style="stroke:#181818;stroke-width:1;" x1="403.2813" x2="444.2813" y1="736.7813" y2="736.7813"></line><polygon fill="#181818" points="413.2813,732.7813,403.2813,736.7813,413.2813,740.7813,409.2813,736.7813" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="495.2314" x="409.2813" y="703.5825">Create JWT Signed Placeholder Message Digest msg_digest=&lt;SHA256 hash</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242.125" x="413.4136" y="718.7153">of JWT Signed Placeholder Message&gt;</text><line style="stroke:#181818;stroke-width:1;" x1="402.2813" x2="444.2813" y1="781.0469" y2="781.0469"></line><line style="stroke:#181818;stroke-width:1;" x1="444.2813" x2="444.2813" y1="781.0469" y2="794.0469"></line><line style="stroke:#181818;stroke-width:1;" x1="403.2813" x2="444.2813" y1="794.0469" y2="794.0469"></line><polygon fill="#181818" points="413.2813,790.0469,403.2813,794.0469,413.2813,798.0469,409.2813,794.0469" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377.0444" x="409.2813" y="760.8481">Add the new (Digest: &lt;msg_digest&gt;) header at the top of</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214.5698" x="413.4136" y="775.981">JWT Signed Placeholder Message</text><polygon fill="#181818" points="911.6074,909.9766,921.6074,913.9766,911.6074,917.9766,915.6074,913.9766" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="402.2813" x2="917.6074" y1="913.9766" y2="913.9766"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165.0645" x="409.2813" y="818.1138">Token Exchange Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="415.6763" x="409.2813" y="833.2466">(grant_type=urn:ietf:params:oauth:grant-type:token-exchange,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="401.1909" x="409.2813" y="848.3794">requested_token_type=urn:ietf:params:oauth:token-type:jwt,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="216.6899" x="409.2813" y="863.5122">subject_token=&lt;JWT Assertion&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382.3574" x="409.2813" y="878.645">subject_token_type=urn:ietf:params:oauth:token-type:jwt,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="279.0684" x="409.2813" y="893.7778">msg=&lt;JWT Signed Placeholder Message&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="326.917" x="409.2813" y="908.9106">dpop=&lt;DPoP Proof&gt;,client_id=&lt;MTA2 client ID&gt;)</text><line style="stroke:#181818;stroke-width:1;" x1="933.6074" x2="975.6074" y1="943.1094" y2="943.1094"></line><line style="stroke:#181818;stroke-width:1;" x1="975.6074" x2="975.6074" y1="943.1094" y2="956.1094"></line><line style="stroke:#181818;stroke-width:1;" x1="934.6074" x2="975.6074" y1="956.1094" y2="956.1094"></line><polygon fill="#181818" points="944.6074,952.1094,934.6074,956.1094,944.6074,960.1094,940.6074,956.1094" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146.9736" x="940.6074" y="938.0435">Validate JWT Assertion</text><line style="stroke:#181818;stroke-width:1;" x1="933.6074" x2="975.6074" y1="985.2422" y2="985.2422"></line><line style="stroke:#181818;stroke-width:1;" x1="975.6074" x2="975.6074" y1="985.2422" y2="998.2422"></line><line style="stroke:#181818;stroke-width:1;" x1="934.6074" x2="975.6074" y1="998.2422" y2="998.2422"></line><polygon fill="#181818" points="944.6074,994.2422,934.6074,998.2422,944.6074,1002.2422,940.6074,998.2422" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128.9717" x="940.6074" y="980.1763">Validate DPoP Proof</text><line style="stroke:#181818;stroke-width:1;" x1="933.6074" x2="975.6074" y1="1057.6406" y2="1057.6406"></line><line style="stroke:#181818;stroke-width:1;" x1="975.6074" x2="975.6074" y1="1057.6406" y2="1070.6406"></line><line style="stroke:#181818;stroke-width:1;" x1="934.6074" x2="975.6074" y1="1070.6406" y2="1070.6406"></line><polygon fill="#181818" points="944.6074,1066.6406,934.6074,1070.6406,944.6074,1074.6406,940.6074,1070.6406" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="409.1255" x="940.6074" y="1022.3091">Validate JWT Signed Placeholder Message format and evaluate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="314.1646" x="944.7397" y="1037.4419">Forwarded-From, Forwarded-To headers against</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199.4243" x="944.7397" y="1052.5747">the policy/rules set on the AS2</text><line style="stroke:#181818;stroke-width:1;" x1="933.6074" x2="975.6074" y1="1114.9063" y2="1114.9063"></line><line style="stroke:#181818;stroke-width:1;" x1="975.6074" x2="975.6074" y1="1114.9063" y2="1127.9063"></line><line style="stroke:#181818;stroke-width:1;" x1="934.6074" x2="975.6074" y1="1127.9063" y2="1127.9063"></line><polygon fill="#181818" points="944.6074,1123.9063,934.6074,1127.9063,944.6074,1131.9063,940.6074,1127.9063" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="290.6338" x="940.6074" y="1094.7075">Verify top header (Digest: &lt;msg_digest&gt;) of</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214.5698" x="944.7397" y="1109.8403">JWT Signed Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="933.6074" x2="975.6074" y1="1187.3047" y2="1187.3047"></line><line style="stroke:#181818;stroke-width:1;" x1="975.6074" x2="975.6074" y1="1187.3047" y2="1200.3047"></line><line style="stroke:#181818;stroke-width:1;" x1="934.6074" x2="975.6074" y1="1200.3047" y2="1200.3047"></line><polygon fill="#181818" points="944.6074,1196.3047,934.6074,1200.3047,944.6074,1204.3047,940.6074,1200.3047" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="238.3989" x="940.6074" y="1151.9731">Create JWT Assertion (azp=client_id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245.7622" x="944.7397" y="1167.106">cnf={jkt=SHA256(JWK Thumbprint)},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382.4526" x="944.7397" y="1182.2388">message_digest={alg="SHA256", value=&lt;msg_digest&gt;})</text><polygon fill="#181818" points="413.2813,1270.8359,403.2813,1274.8359,413.2813,1278.8359,409.2813,1274.8359" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="407.2813" x2="927.6074" y1="1274.8359" y2="1274.8359"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174.6938" x="419.2813" y="1224.3716">Token Exchange Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218.4482" x="419.2813" y="1239.5044">(access_token=&lt;JWT Assertion&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="328.7388" x="419.2813" y="1254.6372">token_type=urn:ietf:params:oauth:token-type:jwt,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377.8252" x="419.2813" y="1269.77">issued_token_type=urn:ietf:params:oauth:token-type:jwt)</text><line style="stroke:#181818;stroke-width:1;" x1="402.2813" x2="444.2813" y1="1303.9688" y2="1303.9688"></line><line style="stroke:#181818;stroke-width:1;" x1="444.2813" x2="444.2813" y1="1303.9688" y2="1316.9688"></line><line style="stroke:#181818;stroke-width:1;" x1="403.2813" x2="444.2813" y1="1316.9688" y2="1316.9688"></line><polygon fill="#181818" points="413.2813,1312.9688,403.2813,1316.9688,413.2813,1320.9688,409.2813,1316.9688" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="497.3262" x="409.2813" y="1298.9028">Generate new DPoP Proof (using the same key pair, for MBX3/MTA3 service)</text><line style="stroke:#181818;stroke-width:1;" x1="402.2813" x2="444.2813" y1="1361.2344" y2="1361.2344"></line><line style="stroke:#181818;stroke-width:1;" x1="444.2813" x2="444.2813" y1="1361.2344" y2="1374.2344"></line><line style="stroke:#181818;stroke-width:1;" x1="403.2813" x2="444.2813" y1="1374.2344" y2="1374.2344"></line><polygon fill="#181818" points="413.2813,1370.2344,403.2813,1374.2344,413.2813,1378.2344,409.2813,1374.2344" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="430.3267" x="409.2813" y="1341.0356">Use DNS to discover MBX3/MTA3 service using the domain part of</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163.1221" x="413.4136" y="1356.1685">recipient's email address</text><line style="stroke:#181818;stroke-width:1;" x1="402.2813" x2="444.2813" y1="1403.3672" y2="1403.3672"></line><line style="stroke:#181818;stroke-width:1;" x1="444.2813" x2="444.2813" y1="1403.3672" y2="1416.3672"></line><line style="stroke:#181818;stroke-width:1;" x1="403.2813" x2="444.2813" y1="1416.3672" y2="1416.3672"></line><polygon fill="#181818" points="413.2813,1412.3672,403.2813,1416.3672,413.2813,1420.3672,409.2813,1416.3672" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="388.5464" x="409.2813" y="1398.3013">Create Placeholder Message request to MBX3/MTA3 service</text><line style="stroke:#181818;stroke-width:1;" x1="402.2813" x2="449.2813" y1="1440.5" y2="1440.5"></line><line style="stroke:#181818;stroke-width:1;" x1="449.2813" x2="449.2813" y1="1440.5" y2="1453.5"></line><line style="stroke:#181818;stroke-width:1;" x1="408.2813" x2="449.2813" y1="1453.5" y2="1453.5"></line><polygon fill="#181818" points="418.2813,1449.5,408.2813,1453.5,418.2813,1457.5,414.2813,1453.5" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="237.7451" x="414.2813" y="1435.4341">Queue Placeholder Message request</text><polygon fill="#181818" points="65.0068,1483.6328,55.0068,1487.6328,65.0068,1491.6328,61.0068,1487.6328" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="59.0068" x2="396.2813" y1="1487.6328" y2="1487.6328"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="244.0166" x="71.0068" y="1482.5669">Placeholder Message request queued</text><polygon fill="#181818" points="1354.7329,1512.7656,1364.7329,1516.7656,1354.7329,1520.7656,1358.7329,1516.7656" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="407.2813" x2="1360.7329" y1="1516.7656" y2="1516.7656"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="804.1401" x="414.2813" y="1511.6997">Post Placeholder Message (JWT Signed Placeholder Message, Authorization: Bearer &lt;JWT Assertion&gt;, DPoP: &lt;DPoP Proof&gt;)</text><line style="stroke:#181818;stroke-width:1;" x1="1376.7329" x2="1418.7329" y1="1545.8984" y2="1545.8984"></line><line style="stroke:#181818;stroke-width:1;" x1="1418.7329" x2="1418.7329" y1="1545.8984" y2="1558.8984"></line><line style="stroke:#181818;stroke-width:1;" x1="1377.7329" x2="1418.7329" y1="1558.8984" y2="1558.8984"></line><polygon fill="#181818" points="1387.7329,1554.8984,1377.7329,1558.8984,1387.7329,1562.8984,1383.7329,1558.8984" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="374.9941" x="1383.7329" y="1540.8325">Validate DPoP Proof (using "jkt" from JWT Assertion "cnf")</text><line style="stroke:#181818;stroke-width:1;" x1="1376.7329" x2="1418.7329" y1="1618.2969" y2="1618.2969"></line><line style="stroke:#181818;stroke-width:1;" x1="1418.7329" x2="1418.7329" y1="1618.2969" y2="1631.2969"></line><line style="stroke:#181818;stroke-width:1;" x1="1377.7329" x2="1418.7329" y1="1631.2969" y2="1631.2969"></line><polygon fill="#181818" points="1387.7329,1627.2969,1377.7329,1631.2969,1387.7329,1635.2969,1383.7329,1631.2969" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="311.3398" x="1383.7329" y="1582.9653">Validate JWT Assertion (verify message_digest),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377.5205" x="1387.8652" y="1598.0981">use DNS discovery to verify that AS2 is the corresponding</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="132.3169" x="1387.8652" y="1613.231">JWT Assertion issuer</text><line style="stroke:#181818;stroke-width:1;" x1="1376.7329" x2="1418.7329" y1="1675.5625" y2="1675.5625"></line><line style="stroke:#181818;stroke-width:1;" x1="1418.7329" x2="1418.7329" y1="1675.5625" y2="1688.5625"></line><line style="stroke:#181818;stroke-width:1;" x1="1377.7329" x2="1418.7329" y1="1688.5625" y2="1688.5625"></line><polygon fill="#181818" points="1387.7329,1684.5625,1377.7329,1688.5625,1387.7329,1692.5625,1383.7329,1688.5625" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382.2114" x="1383.7329" y="1655.3638">Use DNS discovery to verify that MTA2 is the correct client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127.5625" x="1387.8652" y="1670.4966">making the request</text><line style="stroke:#181818;stroke-width:1;" x1="1376.7329" x2="1418.7329" y1="1732.8281" y2="1732.8281"></line><line style="stroke:#181818;stroke-width:1;" x1="1418.7329" x2="1418.7329" y1="1732.8281" y2="1745.8281"></line><line style="stroke:#181818;stroke-width:1;" x1="1377.7329" x2="1418.7329" y1="1745.8281" y2="1745.8281"></line><polygon fill="#181818" points="1387.7329,1741.8281,1377.7329,1745.8281,1387.7329,1749.8281,1383.7329,1745.8281" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273.0762" x="1383.7329" y="1712.6294">Create JWT Signed Placeholder Message=</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="356.3447" x="1383.7329" y="1727.7622">&lt;JWT Signed Placeholder Message&gt;||&lt;JWT Assertion&gt;</text><line style="stroke:#181818;stroke-width:1;" x1="1376.7329" x2="1418.7329" y1="1835.4922" y2="1835.4922"></line><line style="stroke:#181818;stroke-width:1;" x1="1418.7329" x2="1418.7329" y1="1835.4922" y2="1848.4922"></line><line style="stroke:#181818;stroke-width:1;" x1="1377.7329" x2="1418.7329" y1="1848.4922" y2="1848.4922"></line><polygon fill="#181818" points="1387.7329,1844.4922,1377.7329,1848.4922,1387.7329,1852.4922,1383.7329,1848.4922" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="371.3442" x="1383.7329" y="1769.895">Store JWT Signed Placeholder Message in the store using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="364.438" x="1387.8652" y="1785.0278">message_digest from the JWT Assertion as an identifier,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="370.373" x="1387.8652" y="1800.1606">and use it as an Access Control List to allow/deny access</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="385.6201" x="1387.8652" y="1815.2935">to the External Resource stored on the MBX1/MTA1 service</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179.0737" x="1387.8652" y="1830.4263">during the fetching process</text><polygon fill="#181818" points="418.2813,1873.625,408.2813,1877.625,418.2813,1881.625,414.2813,1877.625" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="412.2813" x2="1370.7329" y1="1877.625" y2="1877.625"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="283.6323" x="424.2813" y="1872.5591">Placeholder Message Delivery Confirmation</text><line style="stroke:#181818;stroke-width:1;" x1="407.2813" x2="449.2813" y1="1906.7578" y2="1906.7578"></line><line style="stroke:#181818;stroke-width:1;" x1="449.2813" x2="449.2813" y1="1906.7578" y2="1919.7578"></line><line style="stroke:#181818;stroke-width:1;" x1="408.2813" x2="449.2813" y1="1919.7578" y2="1919.7578"></line><polygon fill="#181818" points="418.2813,1915.7578,408.2813,1919.7578,418.2813,1923.7578,414.2813,1919.7578" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="253.7729" x="414.2813" y="1901.6919">Dequeue Placeholder Message request</text><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="407.2813" x2="449.2813" y1="1953.8906" y2="1953.8906"></line><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="449.2813" x2="449.2813" y1="1953.8906" y2="1966.8906"></line><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="402.2813" x2="449.2813" y1="1966.8906" y2="1966.8906"></line><polygon fill="#181818" points="412.2813,1962.8906,402.2813,1966.8906,412.2813,1970.8906,408.2813,1966.8906" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260.2666" x="414.2813" y="1948.8247">Placeholder Message request dequeued</text><!--SRC=[xLTBSzis4BxhL-oeXqWpibrBqnuuegPAvAHDuqQDtAO7ptXWOYN1fW0Q06qhZ_-U1Kb9f4bHT3gzzQG75hiVzl7jhXKsH7W_ZkqI-iS_meMwHGbdZy6IoGN2N6dG6BAra8iJ-l70DAUlC0rPW4iLSjHmZiOmaesDEtdxyGB6ng2sGabWaiDaggR7hOZHFu68cBJGFd_vp-d9-SNuj0tCm9cqmgvFIo9z9zBFYVIB8kDP7nnmfSKdbfYReRv7dTnm1-dFajw1qpl8wHsqMXa6E1fjR7amLSPMlhHJyMVlKXR1UF0IcIQ1OS4b8oVeNEB1q7t0L2ir7tLRBB3YdbdSlZN3r2zW-fk5WZkftLtef9vltzpQDiorMZq9GZkGytQtNbtnHeVS9kPhMALlk-9YWSPsUnHZilp73BWmWIAXDLW5gJ0zoowPXV7i58IXxmY1qXfDf2GlPuOm9gROL87wQx-Hr8JBd8ADm48G2fIMGApOhRFcpZJUnOIxqiWhZPjtpyH28g-Aj7yfXnL_ZxvyUHBKIXCpg_GX2o1a0jKaiaaWtHiAVazZwgIU59UX-WB1wTrYBb2xp785vu8aR7Oy3W9I1g-Kj5g5y4wGFd8d2qFrS49Nry0I2HS-bHWvUxIe9GlX0neLwo03nq6bKBV52mJaNWH8LtciDqwVemsMxaUabLEySytMDwTUfIic68eat0HsBlGgAQFgCdY34dLr6KXyW5jSGyI4haxwCUS9KYVPUPsI6lAZr-HbAifhTVqBFh9L5EAnH3lgmXAPWqc9vsvP5O6Qqvlh0_iSonSgjNkztbfMUl7VMPwGvwgLVu_gHfK4apILLsQHPRK_dFqwxl_qCooPMTAZ3XeVDNXOefcSkJFptLxCMzir4-zfX_oGSiobx2mqDPWhkuxGZxNq1DgvHws7hOod62dm4e4Z9-1Pf-G8CoLKk1bL8RzAZkhKf7SJDJSFbkwQ-Fg6A32zwPVRJU7yMPh9ZQc-cgYG68zKvEUxMIzbuol1_Q7huHaxms-JVAFBjUZMxljJVrUtg2ONTe2Qgg_9Nnf-Y90IViLx5iPqXNAeo1uzoDTqbdV4mWicf4kH9FyY5OfWVQBZ40qngDtGAaqpTJ2pzaV9cwNpdcHlajhxpUHgEJSDi4-Hlusewp8qKFYVQTpmqnBklFtuErmiuzLrH6t0Th_sIZtC_yp2XTzEvTizS2v4Fm_zQxUO1VaYBzMS6oeC1Q2JDg-zgV_yb4_cacTNORV5iJAlQvkNuwno0ql60RR2RHVh9MFuTd3TjDrkgtPwecw-6Q3ATs5dYgiLfIUu8JbD7XgdHEI2_S80qba8Z7DTwEHbzgygcOpJ798IW4fTVyOOrweg3SdmmpknMDetcgrRpGUD3R0xPuzNk75GD_pN5rUluHRGP0VOxYM30hH_lGFiKTTi1w0CYGyDw6upgze1CchQimKKOJNP0lhFtmAAHXfl0GUQuBw5e6Zj_uKWjn0CYXJVV278CUscJAh8P89t1-cap1ZzUiRWc7562GJjwoyQ4z1sJ3Zmidxh6m00]--></g></svg></p><p>The sequence diagram of this flow is self-explanatory. It outlines the process of forwarding the Placeholder Message to the destination MBX3/MTA3 service while chronologically appending the JWT Assertion to the end of the Placeholder Message.</p>
<div style="break-after:page"></div>
<h2 id="project-implementation">Project Implementation </h2>
<p>We plan to implement this project as a proof of concept using Golang for the backend services, with a filesystem as the data store and SQLite for storing references and metadata of External Resources. OpenAPI 3.1 documentation will be developed to ensure clear and standardized API references. For the frontend, we will create a Progressive Web App (PWA) using the React framework, utilizing styled-components for styling. Additionally, we will design a synchronization protocol with polling to sync the Placeholder Message and inline External Resources with the mailbox.</p>
<h2 id="future-work">Future Work </h2>
<ol>
<li>Retry mechanism.</li>
</ol>
<h2 id="sketchy-ideas">Sketchy Ideas </h2>
<ol>
<li>Email address verification link (verify email address, password reset) should be encrypted.</li>
<li>The user's public and private keys are stored in the AS. During an OAuth 2.0 redirect, the browser renders the user's private key in a hidden, read-only text field to enable cryptographic processes only during user interaction.</li>
</ol>
<h1 id="prompt">Prompt </h1>
<p>Do you understand this project? Ask me if something is not clear to you.</p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>