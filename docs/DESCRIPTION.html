<!DOCTYPE html><html><head>
      <title>DESCRIPTION</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////home/igor/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.8.15/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="system-instructions">System Instructions </h1>
<p>You are an expert in OAuth 2.0 and email system. You are an experienced frontend and backend developer. You know how to code in these languages (a) Golang, SQL (b) HTML, Javascript/Typescript, CSS and you know how to use React framework with styled-components. You can write API documentation using OpenAPI 3.1 specification. You know how to design a synchronization protocol to synchronize data between backend services and a frontend application.</p>
<h1 id="the-federizer-project">The Federizer Project </h1>
<p>We aim to create an Internet mail system, similar to the current email system, that facilitates the transmission of various types of data, such as messages, documents, books, photos, podcasts, and videos, using a set of OAuth 2.0 mechanisms.</p>
<h2 id="logic">Logic </h2>
<h3 id="placeholder-message-and-confined-external-resources">Placeholder Message and Confined External Resources </h3>
<p>Each email entity consists of a Placeholder Message and its associated External Resources—the message bodies stored within the mailbox.</p>
<p>The Placeholder Message also serves as an access control list, granting access to the External Resources to the individuals specified in "From", "To", "Cc", and "Bcc" headers of the Placeholder Message. This implies that the External Resources are confined to these individuals.</p>
<p>Owners of the External Resources can send each recipient a copy of the Placeholder Message, signed by their agent. This action notifies the recipients' agents to fetch the corresponding External Resources.</p>
<h3 id="contextual-discharge">Contextual Discharge </h3>
<p>As the Placeholder Message passes through each mailbox service, a chronological sequence of signed Placeholder Message Envelope Headers is formed.</p>
<p>To discharge the External Resources to other recipients, specified in the "Forwarded-From" and "Forwarded-To" headers of the passing Placeholder Message, a chain of signed Placeholder Message Envelope Headers should be presented. This enables access and allows the other recipients to fetch the External Resources.</p>
<p>Upon fetching the External Resources, each recipient gains ownership of the copies stored in their mailbox.</p>
<h2 id="concept">Concept </h2>
<h3 id="acronyms">Acronyms </h3>
<p>For the sake of brevity of this document, the following list of acronyms will be used:</p>
<ul>
<li>AS: Authorization Server</li>
<li>RS: Resource Server</li>
<li>MTA: Mail Transfer Agent</li>
<li>MBX: Mailbox</li>
<li>APP: Webmail Application</li>
</ul>
<h3 id="components">Components </h3>
<p>Suppose we have two trust domains, <a href="http://example.com">example.com</a> and <a href="http://example.net">example.net</a>, and two users: (a) Alice with the email address <a href="mailto:alice@example.com">alice@example.com</a>, and (b) Bob with the email address <a href="mailto:bob@example.net">bob@example.net</a>. These domains and users do not have any pre-established trust relationship, nor do we intend to create any permanent trust relationship (e.g. through federation) between the trust domains.</p>
<p>We have the following components:</p>
<ul>
<li>
<p>Authorization Server (AS1): Operates under the <a href="http://example.com">example.com</a> trust domain.</p>
</li>
<li>
<p>Authorization Server (AS2): Operates under the <a href="http://example.net">example.net</a> trust domain.</p>
</li>
<li>
<p>Client (Client1): Operates under the <a href="http://example.com">example.com</a> trust domain and serves as Alice's Webmail application (APP1).</p>
</li>
<li>
<p>Client (Client2): Operates under the <a href="http://example.com">example.com</a> trust domain and serves as Alice's Mail Transfer Agent (MTA1)</p>
</li>
<li>
<p>Client (Client3): Operates under the <a href="http://example.net">example.net</a> trust domain and serves as Bob's Mail Transfer Agent (MTA2)</p>
</li>
<li>
<p>Client (Client4): Operates under the <a href="http://example.net">example.net</a> trust domain and serves as Bob's Webmail application (APP2).</p>
</li>
<li>
<p>Resource Server (RS1): Operates under the <a href="http://example.com">example.com</a> trust domain and serves as Alice's Mailbox (MBX1).</p>
</li>
<li>
<p>Resource Server (RS2): Operates under the <a href="http://example.net">example.net</a> trust domain and serves as Bob's Mailbox (MBX2).</p>
</li>
<li>
<p>MBX1 and MTA1: We will refer to them collectively as the MBX1/MTA1 entity, that acts in a dual role and functions as both a service and an agent:</p>
<ul>
<li>
<p>Acts as an RS1 with respect to Client1 or Client3.</p>
</li>
<li>
<p>Acts as a Client2 with respect to RS2.</p>
</li>
</ul>
</li>
<li>
<p>MBX2 and MTA2: We will refer to them collectively as the MBX2/MTA2 entity, that acts in a dual role and functions as both a service and an agent:</p>
<ul>
<li>
<p>Acts as an RS2 with respect to Client4 or Client2.</p>
</li>
<li>
<p>Acts as a Client3 with respect to RS1.</p>
</li>
</ul>
</li>
</ul>
<p>The MTA allows bidirectional data transfer, it can send and receive resources using the POST and GET http methods. That allows to deliver Alice's resources to Bob in two different ways:</p>
<ol>
<li>
<p>Alice's MTA1 sends her resources to Bob's MBX2.</p>
</li>
<li>
<p>Alice temporarily shares her resources to Bob on her MBX1 and sends a notification message (a Placeholder Message, see Fig. 1) via MTA1 to Bob's MBX2/MTA2 service. Next, the Bob's MTA2 fetches the resources from Alice's MBX1/MTA1 service.</p>
</li>
</ol>
<p>Taking into account both ways of transferring Alice's resources to Bob and highlight the symmetry of the system (Alice can deliver her resources to Bob in two ways; Bob can deliver his resources to Alice in two ways) we can summarize the concept of dual roles as follows:</p>
<ul>
<li>
<p>the MBX1/MTA1 acts as RS1 when Alice posts/gets her resources via APP1.</p>
</li>
<li>
<p>the MBX1/MTA1 acts as Client2 when transferring Alice's resources to Bob's MBX2.</p>
</li>
<li>
<p>the MBX1/MTA1 acts as RS1 when Bob's MTA2 fetches Alice's shared resources from Alice's MBX1.</p>
</li>
<li>
<p>the MBX2/MTA2 acts as RS2 when Bob posts/gets his resources via APP2.</p>
</li>
<li>
<p>the MBX2/MTA2 acts as Client3 when transferring Bob's resources to Alice's MBX1.</p>
</li>
<li>
<p>the MBX2/MTA2 acts as RS2 when Alice's MTA1 fetches Bob's shared resources from Bob's MBX2.</p>
</li>
</ul>
<h3 id="oauth-20-flow">OAuth 2.0 Flow </h3>
<p>We utilize two OAuth 2.0 grant types:</p>
<ol>
<li>
<p>Authorization Code Grant with PKCE: Facilitates user-driven interactions (e.g., Alice or Bob accessing their respective mailboxes using Webmail applications).</p>
</li>
<li>
<p>Token Exchange (RFC 8693) for Email Transfer with JWT Assertion and the Demonstrating Proof of Possession (DPoP) mechanism using the "eh" claim: Authorizes automated service-to-service interactions (e.g., Alice's MTA1 accessing Bob's Mailbox MBX2). We call this complex authorization mechanism Cross-Domain Authorization Grant and will describe it in more detail later.</p>
</li>
</ol>
<h3 id="client-registration">Client Registration </h3>
<p>We use the following OAuth 2.0 Client Registration Schema:</p>
<ul>
<li>
<p>The APP1 is registered at the AS1 as a public client.</p>
</li>
<li>
<p>The APP2 is registered at the AS2 as a public client.</p>
</li>
<li>
<p>The MBX1/MTA1 is registered at the AS1 as a confidential client.</p>
</li>
<li>
<p>The MBX2/MTA2 is registered at the AS2 as a confidential client.</p>
</li>
</ul>
<h3 id="service-discovery">Service Discovery </h3>
<p>In the OAuth 2.0-based internet mail architecture, the mailbox (locator) and the email address (user identity identifier) are separated. This separation allows users from the <a href="http://example.com">example.com</a> trust domain to have their mailboxes hosted in another domain, such as <a href="http://example.edu">example.edu</a>. This architecture always requires two DNS records: one for the identity provider and another for the storage provider. However, both providers may operate under the same trust domain, as we will assume in the following description.</p>
<p>We implement service discovery using these DNS records:</p>
<ol>
<li>
<p><code>_federizer._as._tcp.example.com. 3600 IN SRV 10 5 443 as1.example.com.</code></p>
<ul>
<li>Points either: (a) directly to the authorization service, or (b) to a redirect service that redirects http requests to the URL of the authorization service (e.g., <a href="http://example.com/as1">example.com/as1</a>), see Note 1. This is used by the MBX2/MTA2 service to verify that Alice's AS1 is the corresponding JWT Assertion issuer.</li>
</ul>
</li>
<li>
<p><code>_federizer._rs._tcp.example.com. 3600 IN SRV 10 5 443 rs1.example.com.</code></p>
<ul>
<li>Points either: (a) directly to the resource server, or (b) to a redirect service that redirects http requests to the URL of the resource server (e.g., <a href="http://example.com/rs1">example.com/rs1</a>), see Note 1. This is used by the MBX2/MTA2 agent to discover the MBX1/MTA1 service and by the MBX2/MTA2 service to verify that the MBX1/MTA1 agent is the correct client making the request, see Note 2.</li>
</ul>
</li>
<li>
<p><code>_federizer._as._tcp.example.net. 3600 IN SRV 10 5 443 as2.example.net.</code></p>
<ul>
<li>Points either: (a) directly to the authorization service, or (b) to a redirect service that redirects http requests to the URL of the authorization service (e.g., <a href="http://example.net/as2">example.net/as2</a>), see Note 1. This is used by the MBX1/MTA1 service to verify that Bob's AS2 is the corresponding JWT Assertion issuer.</li>
</ul>
</li>
<li>
<p><code>_federizer._rs._tcp.example.net. 3600 IN SRV 10 5 443 rs2.example.net.</code></p>
<ul>
<li>Points either: (a) directly to the resource server, or (b) to a redirect service that redirects http requests to the URL of the resource server (e.g., <a href="http://example.net/rs2">example.net/rs2</a>), see Note 1. This is used by the MBX1/MTA1 agent to discover the MBX2/MTA2 service and by the MBX1/MTA1 service to verify that the MBX2/MTA2 agent is the correct client making the request, see Note 2.</li>
</ul>
</li>
</ol>
<p>Note 1: DNS SRV records cannot point to a URL with a path, while using a URL with a specific path is common for Authorization Servers or Resource Servers. A trusted redirect service can run on the hostname specified in the SRV record and redirect (e.g., a 302 Found) http requests to the actual URL of the Authorization Server or Resource Server, including the path.</p>
<p>Note 2: We utilize the dual role feature of MBX1/MTA1 and MBX2/MTA2 entities to provide metadata about Client2 and Client3. When each MTA is registered with its respective AS as a confidential client, the sibling MTX resource server can supply specific metadata about its MTA, including the MTA client_id. This client_id, also included in the JWT Assertion as an "azp" claim, is used to verify that the correct client is making the request. We refer to this mechanism as a DNS-bound client identity via the sibling SRV record. This allows for the use of DNS records to specify an OAuth 2.0-based internet mail hosting provider.</p>
<h3 id="conceptual-example">Conceptual Example </h3>
<ul>
<li>
<p>The External Resources owned by the author stored on the RS of the origin mailbox service are temporarily shared with recipients by creating a Placeholder Message which also acts as an access control list. Following a successful sharing process, using the Cross-Domain Authorization Grant, the Placeholder Message is sent to each recipient through the MTA operating within the origin trust domain. This Placeholder Message stores SHA-256 digests of the referenced External Resources in its <code>Content-ID</code> headers (see Figure 1 for an example of a Placeholder Message).</p>
</li>
<li>
<p>The MTA operating within the destination trust domain using the Cross-Domain Authorization Grant attempts to fetch the External Resources from the RS of the origin mailbox service. After successful authorization, the External Resource is fetched using a digest value of the Content-ID header from the Placeholder Message body as an identifier and is stored on the RS of the destination mailbox service. That means that each recipient becomes the owner of the corresponding copy of the referenced External Resource (a Signed Placeholder Message can prove it, as explained later—TBD), which they can download and use, or send to other recipients. Finally, the Webmail application downloads the relevant data from the RS of the destination mailbox service and reconstructs the original message according to the Placeholder Message source.</p>
</li>
</ul>
<h4 id="draft-placeholder-message">Draft Placeholder Message </h4>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token comment"># Envelope</span>
<span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">From</span><span class="token punctuation">:</span> Alice &lt;alice@example.com<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Subject</span><span class="token punctuation">:</span> Vacation photo
    <span class="token punctuation">-</span> <span class="token key atrule">To</span><span class="token punctuation">:</span> Bob &lt;bob@example.net<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Message-ID</span><span class="token punctuation">:</span> &lt;b07d0cdf<span class="token punctuation">-</span>c6f4<span class="token punctuation">-</span>4f67<span class="token punctuation">-</span>b24c<span class="token punctuation">-</span>cc847a4c2df4@example.com<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">X-Thread-ID</span><span class="token punctuation">:</span> &lt;68fb9177<span class="token punctuation">-</span>6853<span class="token punctuation">-</span>466a<span class="token punctuation">-</span>8f7d<span class="token punctuation">-</span>c96fbb885f81@example.com<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Content-Type</span><span class="token punctuation">:</span> multipart/mixed
<span class="token comment"># Body</span>
<span class="token punctuation">-</span> <span class="token key atrule">parts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">Content-Type</span><span class="token punctuation">:</span> multipart/alternative
      <span class="token key atrule">parts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">Content-Disposition</span><span class="token punctuation">:</span> inline
            <span class="token punctuation">-</span> <span class="token key atrule">Content-ID</span><span class="token punctuation">:</span> &lt;aSQnmlBT6RndpDnwTSStJUVhlh9XL9_y2QXX42NhKuI<span class="token punctuation">&gt;</span>
            <span class="token punctuation">-</span> <span class="token key atrule">Content-Type</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> message/external<span class="token punctuation">-</span>body; access<span class="token punctuation">-</span>type='x<span class="token punctuation">-</span>content<span class="token punctuation">-</span>addressed<span class="token punctuation">-</span>uri';
                hash<span class="token punctuation">-</span>algorithm='sha256'; size='42'
              <span class="token punctuation">-</span> text/plain; charset=UTF<span class="token punctuation">-</span><span class="token number">8</span>
        <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">Content-Disposition</span><span class="token punctuation">:</span> inline
            <span class="token punctuation">-</span> <span class="token key atrule">Content-ID</span><span class="token punctuation">:</span> &lt;Y_ION3g8WQuqGzhsDlVrhAgQ0D7AbXu9T<span class="token punctuation">-</span>HSv3w<span class="token punctuation">-</span><span class="token punctuation">-</span>zY<span class="token punctuation">&gt;</span>
            <span class="token punctuation">-</span> <span class="token key atrule">Content-Type</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> message/external<span class="token punctuation">-</span>body; access<span class="token punctuation">-</span>type='x<span class="token punctuation">-</span>content<span class="token punctuation">-</span>addressed<span class="token punctuation">-</span>uri';
                hash<span class="token punctuation">-</span>algorithm='sha256'; size='109'
              <span class="token punctuation">-</span> text/html; charset=UTF<span class="token punctuation">-</span><span class="token number">8</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">Content-Type</span><span class="token punctuation">:</span> multipart/mixed
      <span class="token key atrule">parts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">Content-Disposition</span><span class="token punctuation">:</span> attachment; filename='Venice.png'
            <span class="token punctuation">-</span> <span class="token key atrule">Content-ID</span><span class="token punctuation">:</span> &lt;1pzyqfFWbfhJ3hrydjL9jO9Qgeg70TgZQ_zpOkt4HOU<span class="token punctuation">&gt;</span>
            <span class="token punctuation">-</span> <span class="token key atrule">Content-Type</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> message/external<span class="token punctuation">-</span>body; access<span class="token punctuation">-</span>type='x<span class="token punctuation">-</span>content<span class="token punctuation">-</span>addressed<span class="token punctuation">-</span>uri';
                hash<span class="token punctuation">-</span>algorithm='sha256'; size='3520247'
              <span class="token punctuation">-</span> image/png
</code></pre><p>Fig. 1. An example of a draft Placeholder Message in YAML format.</p>
<p>In the example above, all headers are part of the original email composition. Additional headers, such as <code>Date</code>, <code>Received</code>, <code>Forwarded-From</code>, and <code>Forwarded-To</code>, are added sequentially as the Placeholder Message passes through each mailbox service. The most recent header appears at the top of the list (see Figure 2).</p>
<h4 id="signed-placeholder-message-envelope-headers">Signed Placeholder Message Envelope Headers </h4>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token comment"># Envelope</span>
<span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Message-ID</span><span class="token punctuation">:</span> &lt;b07d0cdf<span class="token punctuation">-</span>c6f4<span class="token punctuation">-</span>4f67<span class="token punctuation">-</span>b24c<span class="token punctuation">-</span>cc847a4c2df4@example.com<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">JWT-Assertion-Digest</span><span class="token punctuation">:</span> &lt;PpN6Qr16xzNhDx_stziNtYEUXHlJ8v1OVxGELWr0tuY<span class="token punctuation">&gt;</span> <span class="token comment"># last hop JWT Assertion Digest</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Received</span><span class="token punctuation">:</span> from example.com by example.net; Sun Dec 22 20<span class="token punctuation">:</span>58<span class="token punctuation">:</span>14 CEST 2024
<span class="token punctuation">-</span> <span class="token key atrule">jwt-assertion</span><span class="token punctuation">:</span>
    <span class="token key atrule">header</span><span class="token punctuation">:</span>
      <span class="token key atrule">alg</span><span class="token punctuation">:</span> RS256
      <span class="token key atrule">typ</span><span class="token punctuation">:</span> JWT
    <span class="token key atrule">payload</span><span class="token punctuation">:</span>
      <span class="token key atrule">iss</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//as1.example.com/
      <span class="token key atrule">azp</span><span class="token punctuation">:</span> client2.example.com
      <span class="token key atrule">scope</span><span class="token punctuation">:</span> internet_mail
      <span class="token key atrule">cnf</span><span class="token punctuation">:</span>
        <span class="token key atrule">jkt</span><span class="token punctuation">:</span> 0ZcOCORZNYy<span class="token punctuation">-</span>DWpqq30jZyJGHTN0d2HglBV3uiguA4I <span class="token comment"># DPoP JWK Thumbprint (here superfluous)</span>
      <span class="token key atrule">eh</span><span class="token punctuation">:</span>                                                <span class="token comment"># last hop Envelope Headers</span>
        <span class="token key atrule">eht</span><span class="token punctuation">:</span> tKKw0<span class="token punctuation">-</span>Munn<span class="token punctuation">-</span>PQKcmE_nuF32eziwCS0FBtUz_fJMva5E <span class="token comment"># Envelope Headers Thumbprint</span>
        <span class="token key atrule">ehl</span><span class="token punctuation">:</span>                                             <span class="token comment"># Named list of hashed Envelope Headers</span>
          <span class="token punctuation">-</span> Message<span class="token punctuation">-</span>ID
          <span class="token punctuation">-</span> From
          <span class="token punctuation">-</span> Recipients<span class="token punctuation">-</span>Digest
          <span class="token punctuation">-</span> Body<span class="token punctuation">-</span>Digest
    <span class="token key atrule">signature</span><span class="token punctuation">:</span> GHSqC5F1H6D7SkN0JwhVw6aKt8TNuBWKoKXv19HlkMJP6dQPfw9u6LgxEyRBjt08STyqIAqSPuu7tzWzL_efxYi1j_9ABteTcHDC9lJRNAwp9TNmg9K4uXtdSw57K3vdzDfeCxcfwhJS_t3wz1vtyF3pvsdkJ5G81qxZ8Gh8n5hZsadzknL6yCeL_x9K_ykDFJl_TVBUf7Q1ImyEUaCx04DA<span class="token punctuation">-</span>eZv85xlWkG0NeutVQ6epeB<span class="token punctuation">-</span>XAuFxImaTzM<span class="token punctuation">-</span>kP66YXDNeK1ohtoS99Qk9S_e0cQZV7dl3wtxSCf3A<span class="token punctuation">-</span>sqTrh0nDPn8D71annnXBsqUWJsD4QERed<span class="token punctuation">-</span>lKnGagbzJn57mw
<span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Date</span><span class="token punctuation">:</span> Sun Dec 22 20<span class="token punctuation">:</span>49<span class="token punctuation">:</span>35 CEST 2024
    <span class="token punctuation">-</span> <span class="token key atrule">Recipients-Digest</span><span class="token punctuation">:</span> &lt;tSutyHKcSxIt_2VxOi1mYtU5h9ffs<span class="token punctuation">-</span>AHK9d6ffwxmle<span class="token punctuation">&gt;</span> <span class="token comment"># To, Cc, Bcc headers digest</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Body-Digest</span><span class="token punctuation">:</span> &lt;nZURGvgk4xoy6<span class="token punctuation">-</span>aI6dna5ddskq5ud_GyI7u96hkxYh4<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">From</span><span class="token punctuation">:</span> Alice &lt;alice@example.com<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Subject</span><span class="token punctuation">:</span> Vacation photo
    <span class="token punctuation">-</span> <span class="token key atrule">To</span><span class="token punctuation">:</span> Bob &lt;bob@example.net<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Message-ID</span><span class="token punctuation">:</span> &lt;b07d0cdf<span class="token punctuation">-</span>c6f4<span class="token punctuation">-</span>4f67<span class="token punctuation">-</span>b24c<span class="token punctuation">-</span>cc847a4c2df4@example.com<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">X-Thread-ID</span><span class="token punctuation">:</span> &lt;68fb9177<span class="token punctuation">-</span>6853<span class="token punctuation">-</span>466a<span class="token punctuation">-</span>8f7d<span class="token punctuation">-</span>c96fbb885f81@example.com<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Content-Type</span><span class="token punctuation">:</span> multipart/mixed
</code></pre><p>Fig. 2. An example of a signed Placeholder Placeholder Message Envelope Headers in YAML format at the end of the send/receive process.</p>
<p>The <code>Date</code> header means that the message has been sent and is immutable—without the <code>Date</code> header it is a draft message.<br>
The <code>Recipients-Digest</code> is a digest of the concatenated values of the <code>To</code>, <code>Cc</code>, <code>Bcc</code> headers, or of the single value of the<code>Forwarded-To</code> header. It hides the real recipients from being exposed in the authorization server.<br>
The <code>Body-Digest</code> header binds the message body to the envelope headers. Body binding through a body digest involves generating a SHA-256 hash of the message body.<br>
The <code>eht</code> claim binds the envelope headers to the JWT Assertion.</p>
<h4 id="chain-of-signed-placeholder-message-envelope-headers">Chain of Signed Placeholder Message Envelope Headers </h4>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token comment"># Envelope</span>
<span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Message-ID</span><span class="token punctuation">:</span> &lt;b07d0cdf<span class="token punctuation">-</span>c6f4<span class="token punctuation">-</span>4f67<span class="token punctuation">-</span>b24c<span class="token punctuation">-</span>cc847a4c2df4@example.com<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">JWT-Assertion-Digest</span><span class="token punctuation">:</span> &lt;tVaz0gjAdWeLn5JIz8g8NUNVnJL2ZAPnEcapTNM0zc7<span class="token punctuation">&gt;</span> <span class="token comment"># last hop JWT Assertion Digest</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Received</span><span class="token punctuation">:</span> from example.net by example.org; Sun Dec 22 21<span class="token punctuation">:</span>01<span class="token punctuation">:</span>34 CEST 2024
<span class="token punctuation">-</span> <span class="token key atrule">jwt-assertion</span><span class="token punctuation">:</span>
    <span class="token key atrule">header</span><span class="token punctuation">:</span>
      <span class="token key atrule">alg</span><span class="token punctuation">:</span> RS256
      <span class="token key atrule">typ</span><span class="token punctuation">:</span> JWT
    <span class="token key atrule">payload</span><span class="token punctuation">:</span>
      <span class="token key atrule">iss</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//as2.example.net/
      <span class="token key atrule">azp</span><span class="token punctuation">:</span> client3.example.net
      <span class="token key atrule">scope</span><span class="token punctuation">:</span> internet_mail
      <span class="token key atrule">cnf</span><span class="token punctuation">:</span>
        <span class="token key atrule">jkt</span><span class="token punctuation">:</span> gFSUE65ghV8FBld<span class="token punctuation">-</span>0J85pwB4TOKKqEfMvvd8Rm8Hy9G <span class="token comment"># DPoP JWK Thumbprint (here superfluous)</span>
      <span class="token key atrule">eh</span><span class="token punctuation">:</span>                                                <span class="token comment"># last hop Envelope Headers</span>
        <span class="token key atrule">eht</span><span class="token punctuation">:</span> zTvzWxYg9zuqZHvZhg6RvdpqPpLvtXMS<span class="token punctuation">-</span>l8QUehswJP <span class="token comment"># Envelope Headers Thumbprint</span>
        <span class="token key atrule">ehl</span><span class="token punctuation">:</span>                                             <span class="token comment"># Named list of hashed Envelope Headers</span>
          <span class="token punctuation">-</span> Message<span class="token punctuation">-</span>ID
          <span class="token punctuation">-</span> Forwarded<span class="token punctuation">-</span>From
          <span class="token punctuation">-</span> Recipients<span class="token punctuation">-</span>Digest
          <span class="token punctuation">-</span> JWT<span class="token punctuation">-</span>Assertion<span class="token punctuation">-</span>Digest
    <span class="token key atrule">signature</span><span class="token punctuation">:</span> Drs2jP8vasca5qCDmmB<span class="token punctuation">-</span>spUuPqrdAq1oGVaObRC_kTgdlx48hpDJcYZ18mxBTGJ_cnoRQ1gBdlHaKnnM0ir6QPEt3qDpuU7mT9v6Gj84GhsXfbsGGpIWPL4ZNPI<span class="token punctuation">-</span>u8TNeZWMZc0VkVNx1FswIOMQNLLQsPZ1gPPGLnT7LTWzyib8leE779itPLyI6jMrhrYxOfbGRIb4V9jIiRxsbTKUH1tNdZ9Hy5PC75u24<span class="token punctuation">-</span>YiUNup8tF4O9JStzoe3K6QJG0jHjhVRJ_efqt6tBPdl2XfjZOEr_1cMIFsk6iV_2GiqqacHRKzC0JoBp8Djxyp_DaD8OP8m3AbyHP5Ial9s7zhhg
<span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Recipients-Digest</span><span class="token punctuation">:</span> &lt;i0LnZ<span class="token punctuation">-</span>Ju2O3_1E2qNFRg2T7DwtMePhvQnWqTQO9ZpWK<span class="token punctuation">&gt;</span> <span class="token comment"># Forwarded-To header digest    </span>
    <span class="token punctuation">-</span> <span class="token key atrule">Forwarded-To</span><span class="token punctuation">:</span> Bobby &lt;bobby@example.org<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Forwarded-From</span><span class="token punctuation">:</span> Bob &lt;bob@example.net<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Message-ID</span><span class="token punctuation">:</span> &lt;b07d0cdf<span class="token punctuation">-</span>c6f4<span class="token punctuation">-</span>4f67<span class="token punctuation">-</span>b24c<span class="token punctuation">-</span>cc847a4c2df4@example.com<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">JWT-Assertion-Digest</span><span class="token punctuation">:</span> &lt;PpN6Qr16xzNhDx_stziNtYEUXHlJ8v1OVxGELWr0tuY<span class="token punctuation">&gt;</span> <span class="token comment"># last hop JWT Assertion Digest</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Received</span><span class="token punctuation">:</span> from example.com by example.net; Sun Dec 22 20<span class="token punctuation">:</span>58<span class="token punctuation">:</span>14 CEST 2024
<span class="token punctuation">-</span> <span class="token key atrule">jwt-assertion</span><span class="token punctuation">:</span>
    <span class="token key atrule">header</span><span class="token punctuation">:</span>
      <span class="token key atrule">alg</span><span class="token punctuation">:</span> RS256
      <span class="token key atrule">typ</span><span class="token punctuation">:</span> JWT
    <span class="token key atrule">payload</span><span class="token punctuation">:</span>
      <span class="token key atrule">iss</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//as1.example.com/
      <span class="token key atrule">azp</span><span class="token punctuation">:</span> client2.example.com
      <span class="token key atrule">scope</span><span class="token punctuation">:</span> internet_mail
      <span class="token key atrule">cnf</span><span class="token punctuation">:</span>
        <span class="token key atrule">jkt</span><span class="token punctuation">:</span> 0ZcOCORZNYy<span class="token punctuation">-</span>DWpqq30jZyJGHTN0d2HglBV3uiguA4I <span class="token comment"># JWK Thumbprint (here superfluous)</span>
      <span class="token key atrule">eh</span><span class="token punctuation">:</span>                                                <span class="token comment"># last hop Envelope Headers</span>
        <span class="token key atrule">eht</span><span class="token punctuation">:</span> tKKw0<span class="token punctuation">-</span>Munn<span class="token punctuation">-</span>PQKcmE_nuF32eziwCS0FBtUz_fJMva5E <span class="token comment"># Envelope Headers Thumbprint</span>
        <span class="token key atrule">ehl</span><span class="token punctuation">:</span>                                             <span class="token comment"># Named list of hashed Envelope Headers</span>
          <span class="token punctuation">-</span> Message<span class="token punctuation">-</span>ID
          <span class="token punctuation">-</span> From
          <span class="token punctuation">-</span> Recipients<span class="token punctuation">-</span>Digest
          <span class="token punctuation">-</span> Body<span class="token punctuation">-</span>Digest
    <span class="token key atrule">signature</span><span class="token punctuation">:</span> GHSqC5F1H6D7SkN0JwhVw6aKt8TNuBWKoKXv19HlkMJP6dQPfw9u6LgxEyRBjt08STyqIAqSPuu7tzWzL_efxYi1j_9ABteTcHDC9lJRNAwp9TNmg9K4uXtdSw57K3vdzDfeCxcfwhJS_t3wz1vtyF3pvsdkJ5G81qxZ8Gh8n5hZsadzknL6yCeL_x9K_ykDFJl_TVBUf7Q1ImyEUaCx04DA<span class="token punctuation">-</span>eZv85xlWkG0NeutVQ6epeB<span class="token punctuation">-</span>XAuFxImaTzM<span class="token punctuation">-</span>kP66YXDNeK1ohtoS99Qk9S_e0cQZV7dl3wtxSCf3A<span class="token punctuation">-</span>sqTrh0nDPn8D71annnXBsqUWJsD4QERed<span class="token punctuation">-</span>lKnGagbzJn57mw
<span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Date</span><span class="token punctuation">:</span> Sun Dec 22 20<span class="token punctuation">:</span>49<span class="token punctuation">:</span>35 CEST 2024
    <span class="token punctuation">-</span> <span class="token key atrule">Recipients-Digest</span><span class="token punctuation">:</span> &lt;tSutyHKcSxIt_2VxOi1mYtU5h9ffs<span class="token punctuation">-</span>AHK9d6ffwxmle<span class="token punctuation">&gt;</span> <span class="token comment"># To, Cc, Bcc headers digest</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Body-Digest</span><span class="token punctuation">:</span> &lt;nZURGvgk4xoy6<span class="token punctuation">-</span>aI6dna5ddskq5ud_GyI7u96hkxYh4<span class="token punctuation">&gt;</span> <span class="token comment"># Body Digest</span>
    <span class="token punctuation">-</span> <span class="token key atrule">From</span><span class="token punctuation">:</span> Alice &lt;alice@example.com<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Subject</span><span class="token punctuation">:</span> Vacation photo
    <span class="token punctuation">-</span> <span class="token key atrule">To</span><span class="token punctuation">:</span> Bob &lt;bob@example.net<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Message-ID</span><span class="token punctuation">:</span> &lt;b07d0cdf<span class="token punctuation">-</span>c6f4<span class="token punctuation">-</span>4f67<span class="token punctuation">-</span>b24c<span class="token punctuation">-</span>cc847a4c2df4@example.com<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">X-Thread-ID</span><span class="token punctuation">:</span> &lt;68fb9177<span class="token punctuation">-</span>6853<span class="token punctuation">-</span>466a<span class="token punctuation">-</span>8f7d<span class="token punctuation">-</span>c96fbb885f81@example.com<span class="token punctuation">&gt;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">Content-Type</span><span class="token punctuation">:</span> multipart/mixed
</code></pre><p>Fig. 3. An example of chained, signed Placeholder Message Envelope Headers in YAML format at the end of the send/receive/forward/receive process.</p>
<h2 id="digital-assets">Digital Assets </h2>
<p>The user can digitally sign the Placeholder Message, referred to as a PGP Signed Placeholder Message, either as a whole (the email body) or in parts by group of headers (<code>Content-Disposition</code>, <code>Content-ID</code>, <code>Content-Type</code>) of the individual External Resources using the <code>application/pgp-signature</code> protocol. The signature transforms the External Resource into a digital asset that has verifiable authenticity, integrity, and data origin, provided the resource includes provenance metadata—TBD.</p>
<h2 id="resources-delivery-scenario">Resource(s) Delivery Scenario </h2>
<p>We describe the delivery of Alice's resources to Bob.</p>
<p>Alice wants to send a vacation photo to Bob. She creates a new Placeholder Message in YAML format using the APP1 compose form. Alice opens the compose form and fills in the "To", "Subject", and (optionally) "Text" fields. While composing the message, she uploads the photo to the MBX1/MTA1 service to add it as an External Resource to the Placeholder Message. After a successful upload, the service returns a digest of the uploaded photo. This digest is then added to the Placeholder Message as the value of the <code>Content-ID</code> header and an External Resource with the <code>Content-Disposition: attachment</code> header. The content of the "Text" field is posted as a resource to the MBX1/MTA1 service that returns a digest of the posted text. This digest is then added to the Placeholder Message as the value of the <code>Content-ID</code> header and an External Resource with the <code>Content-Disposition: inline</code> header. Finally, to initiate the delivery process, Alice presses the "Send" button, posting the Placeholder Message to the MBX1/MTA1 service.</p>
<p>The MBX1/MTA1 agent sends the Placeholder Message to the MBX2/MTA2 service, using the Cross-Domain Authorization Grant. After completing the validation process, the MBX2/MTA2 agent fetches the External Resources from the MBX1/MTA1 service using the Cross-Domain Authorization Grant and notifies the APP2 Webmail application that it has received a new email.</p>
<p>Upon receiving the notification, Bob's APP2 downloads the Placeholder Message from the MBX2/MTA2 service. Using the information contained within, APP2 downloads the corresponding External Resources with the <code>Content-Disposition: inline</code> header (the "Text" field) to accurately reconstruct and display the content of the original Placeholder Message (including the content of the "Text" field). After this  delivery process, Bob is able to download the External Resource with the <code>Content-Disposition: attachment</code> header (the vacation photo) identified by its digest from the MBX2/MTA service.</p>
<div style="break-after:page"></div>
<h2 id="sequence-diagrams">Sequence Diagrams </h2>
<h3 id="oauth-20-authorization-code-grant-with-pkce">OAuth 2.0 Authorization Code Grant with PKCE </h3>
<p>This diagram illustrates the sequence of interactions in an OAuth 2.0 Authorization Code Grant flow enhanced with Proof Key for Code Exchange (PKCE). It is used in the interaction of Alice's APP1 with Alice's MBX1/MTA1 service and also in the interaction of Bob's App2 with Bob's MBX2/MTA2 service.</p>
<h4 id="to-authorize-a-public-client-to-interact-with-the-backend-service">To authorize a public client to interact with the backend service: </h4>
<ul>
<li>We will use OAuth 2.0 Authorization Code Grant with PKCE (RFC 7636).</li>
<li>The client should be registered at the authorization server as a public client.</li>
</ul>
<h5 id="sequence-diagram">Sequence Diagram </h5>
<p class="plantuml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" data-diagram-type="SEQUENCE" height="960px" preserveAspectRatio="none" style="width:1213px;height:960px;background:#FFFFFF;" version="1.1" viewBox="0 0 1213 960" width="1213px" zoomAndPan="magnify"><title>OAuth 2.0 Authorization Code Grant with PKCE</title><defs></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="370.1113" x="420.6377" y="27.9951">OAuth 2.0 Authorization Code Grant with PKCE</text><g><title>User/Browser</title><rect fill="#FFFFFF" height="131.6641" style="stroke:#181818;stroke-width:1;" width="10" x="49.833" y="379.1172"></rect></g><g><title>Client Application</title><rect fill="#FFFFFF" height="711.9141" style="stroke:#181818;stroke-width:1;" width="10" x="263.3994" y="149.7266"></rect></g><g><title>Authorization Server</title><rect fill="#FFFFFF" height="438.2578" style="stroke:#181818;stroke-width:1;" width="10" x="710.873" y="349.9844"></rect></g><g><title>Resource Server</title><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1;" width="10" x="888.0381" y="832.5078"></rect></g><g><title>Code Verifier</title><rect fill="#FFFFFF" height="31.2969" style="stroke:#181818;stroke-width:1;" width="10" x="1015.4453" y="188.8594"></rect></g><g><title>Code Verifier</title><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1;" width="10" x="1015.4453" y="599.3125"></rect></g><g><title>Code Challenge</title><rect fill="#FFFFFF" height="31.2969" style="stroke:#181818;stroke-width:1;" width="10" x="1140.2446" y="259.2891"></rect></g><g><title>Code Challenge</title><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1;" width="10" x="1140.2446" y="657.5781"></rect></g><g><title>User/Browser</title><rect fill="transparent" height="761.0469" width="8" x="50.833" y="118.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="54" x2="54" y1="118.5938" y2="879.6406"></line></g><g><title>Client Application</title><rect fill="transparent" height="761.0469" width="8" x="264.3994" y="118.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="267.7974" x2="267.7974" y1="118.5938" y2="879.6406"></line></g><g><title>Authorization Server</title><rect fill="transparent" height="761.0469" width="8" x="711.873" y="118.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="715.8086" x2="715.8086" y1="118.5938" y2="879.6406"></line></g><g><title>Resource Server</title><rect fill="transparent" height="761.0469" width="8" x="889.0381" y="118.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="892.2881" x2="892.2881" y1="118.5938" y2="879.6406"></line></g><g><title>Code Verifier</title><rect fill="transparent" height="691.2656" width="8" x="1016.4453" y="188.375"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1019.7881" x2="1019.7881" y1="188.375" y2="879.6406"></line></g><g><title>Code Challenge</title><rect fill="transparent" height="620.8359" width="8" x="1141.2446" y="258.8047"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1145.1025" x2="1145.1025" y1="258.8047" y2="879.6406"></line></g><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93.666" x="5" y="115.292">User/Browser</text><ellipse cx="54.833" cy="50.7969" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"></ellipse><path d="M54.833,58.7969 L54.833,85.7969 M41.833,66.7969 L67.833,66.7969 M54.833,85.7969 L41.833,100.7969 M54.833,85.7969 L67.833,100.7969 " fill="transparent" style="stroke:#181818;stroke-width:0.5;"></path><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93.666" x="5" y="891.6357">User/Browser</text><ellipse cx="54.833" cy="903.4375" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"></ellipse><path d="M54.833,911.4375 L54.833,938.4375 M41.833,919.4375 L67.833,919.4375 M54.833,938.4375 L41.833,953.4375 M54.833,938.4375 L67.833,953.4375 " fill="transparent" style="stroke:#181818;stroke-width:0.5;"></path><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="137.2041" x="199.7974" y="87.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="123.2041" x="206.7974" y="107.292">Client Application</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="137.2041" x="199.7974" y="878.6406"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="123.2041" x="206.7974" y="898.6357">Client Application</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="158.1289" x="636.8086" y="87.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="144.1289" x="643.8086" y="107.292">Authorization Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="158.1289" x="636.8086" y="878.6406"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="144.1289" x="643.8086" y="898.6357">Authorization Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="129.5" x="828.2881" y="87.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="115.5" x="835.2881" y="107.292">Resource Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="129.5" x="828.2881" y="878.6406"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="115.5" x="835.2881" y="898.6357">Resource Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105.3145" x="967.7881" y="878.6406"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91.3145" x="974.7881" y="898.6357">Code Verifier</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="124.2842" x="1083.1025" y="878.6406"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110.2842" x="1090.1025" y="898.6357">Code Challenge</text><g><title>User/Browser</title><rect fill="#FFFFFF" height="131.6641" style="stroke:#181818;stroke-width:1;" width="10" x="49.833" y="379.1172"></rect></g><g><title>Client Application</title><rect fill="#FFFFFF" height="711.9141" style="stroke:#181818;stroke-width:1;" width="10" x="263.3994" y="149.7266"></rect></g><g><title>Authorization Server</title><rect fill="#FFFFFF" height="438.2578" style="stroke:#181818;stroke-width:1;" width="10" x="710.873" y="349.9844"></rect></g><g><title>Resource Server</title><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1;" width="10" x="888.0381" y="832.5078"></rect></g><g><title>Code Verifier</title><rect fill="#FFFFFF" height="31.2969" style="stroke:#181818;stroke-width:1;" width="10" x="1015.4453" y="188.8594"></rect></g><g><title>Code Verifier</title><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1;" width="10" x="1015.4453" y="599.3125"></rect></g><g><title>Code Challenge</title><rect fill="#FFFFFF" height="31.2969" style="stroke:#181818;stroke-width:1;" width="10" x="1140.2446" y="259.2891"></rect></g><g><title>Code Challenge</title><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1;" width="10" x="1140.2446" y="657.5781"></rect></g><polygon fill="#181818" points="251.3994,145.7266,261.3994,149.7266,251.3994,153.7266,255.3994,149.7266" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="54.833" x2="257.3994" y1="149.7266" y2="149.7266"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189.5664" x="61.833" y="144.6606">Initiate authorization request</text><polygon fill="#181818" points="955.7881,174.8594,965.7881,178.8594,955.7881,182.8594,959.7881,178.8594" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="273.3994" x2="961.7881" y1="178.8594" y2="178.8594"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148.8779" x="280.3994" y="173.7935">Generate code_verifier</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105.3145" x="967.7881" y="157.7266"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91.3145" x="974.7881" y="177.7217">Code Verifier</text><polygon fill="#181818" points="284.3994,216.1563,274.3994,220.1563,284.3994,224.1563,280.3994,220.1563" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="278.3994" x2="1019.4453" y1="220.1563" y2="220.1563"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84.0303" x="290.3994" y="215.0903">code_verifier</text><polygon fill="#181818" points="1071.1025,245.2891,1081.1025,249.2891,1071.1025,253.2891,1075.1025,249.2891" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="273.3994" x2="1077.1025" y1="249.2891" y2="249.2891"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="354.6055" x="280.3994" y="244.2231">Generate code_challenge from code_verifier (SHA256)</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="124.2842" x="1083.1025" y="228.1563"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110.2842" x="1090.1025" y="248.1514">Code Challenge</text><polygon fill="#181818" points="284.3994,286.5859,274.3994,290.5859,284.3994,294.5859,280.3994,290.5859" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="278.3994" x2="1144.2446" y1="290.5859" y2="290.5859"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100.915" x="290.3994" y="285.52">code_challenge</text><polygon fill="#181818" points="698.873,345.9844,708.873,349.9844,698.873,353.9844,702.873,349.9844" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="273.3994" x2="704.873" y1="349.9844" y2="349.9844"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144.5933" x="280.3994" y="314.6528">Authorization Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="291.4082" x="280.3994" y="329.7856">(response_type=code, client_id, redirect_uri,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="403.4126" x="280.3994" y="344.9185">scope, state, code_challenge, code_challenge_method=S256)</text><polygon fill="#181818" points="70.833,375.1172,60.833,379.1172,70.833,383.1172,66.833,379.1172" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="64.833" x2="709.873" y1="379.1172" y2="379.1172"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152.9531" x="76.833" y="374.0513">Authentication Request</text><polygon fill="#181818" points="698.873,404.25,708.873,408.25,698.873,412.25,702.873,408.25" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="59.833" x2="704.873" y1="408.25" y2="408.25"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="83.624" x="66.833" y="403.1841">Authenticate</text><polygon fill="#181818" points="70.833,433.3828,60.833,437.3828,70.833,441.3828,66.833,437.3828" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="64.833" x2="709.873" y1="437.3828" y2="437.3828"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192.5371" x="76.833" y="432.3169">Consent Request (if required)</text><polygon fill="#181818" points="698.873,462.5156,708.873,466.5156,698.873,470.5156,702.873,466.5156" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="59.833" x2="704.873" y1="466.5156" y2="466.5156"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175.8682" x="66.833" y="461.4497">Grant Consent (if required)</text><polygon fill="#181818" points="284.3994,506.7813,274.3994,510.7813,284.3994,514.7813,280.3994,510.7813" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="278.3994" x2="709.873" y1="510.7813" y2="510.7813"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124.4839" x="290.3994" y="490.5825">Authorization Code</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82.6909" x="290.3994" y="505.7153">(code, state)</text><polygon fill="#181818" points="698.873,566.1797,708.873,570.1797,698.873,574.1797,702.873,570.1797" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="273.3994" x2="704.873" y1="570.1797" y2="570.1797"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97.1826" x="280.3994" y="534.8481">Token Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="336.9019" x="280.3994" y="549.981">(grant_type=authorization_code, code, redirect_uri,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151.436" x="280.3994" y="565.1138">client_id, code_verifier)</text><polygon fill="#181818" points="1003.4453,595.3125,1013.4453,599.3125,1003.4453,603.3125,1007.4453,599.3125" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="720.873" x2="1009.4453" y1="599.3125" y2="599.3125"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142.9365" x="727.873" y="594.2466">Retrieve code_verifier</text><polygon fill="#181818" points="731.873,624.4453,721.873,628.4453,731.873,632.4453,727.873,628.4453" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="725.873" x2="1019.4453" y1="628.4453" y2="628.4453"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84.0303" x="737.873" y="623.3794">code_verifier</text><polygon fill="#181818" points="1128.2446,653.5781,1138.2446,657.5781,1128.2446,661.5781,1132.2446,657.5781" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="720.873" x2="1134.2446" y1="657.5781" y2="657.5781"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="354.6055" x="727.873" y="652.5122">Generate code_challenge from code_verifier (SHA256)</text><polygon fill="#181818" points="731.873,682.7109,721.873,686.7109,731.873,690.7109,727.873,686.7109" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="725.873" x2="1144.2446" y1="686.7109" y2="686.7109"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100.915" x="737.873" y="681.645">code_challenge</text><line style="stroke:#181818;stroke-width:1;" x1="720.873" x2="762.873" y1="715.8438" y2="715.8438"></line><line style="stroke:#181818;stroke-width:1;" x1="762.873" x2="762.873" y1="715.8438" y2="728.8438"></line><line style="stroke:#181818;stroke-width:1;" x1="721.873" x2="762.873" y1="728.8438" y2="728.8438"></line><polygon fill="#181818" points="731.873,724.8438,721.873,728.8438,731.873,732.8438,727.873,728.8438" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143.165" x="727.873" y="710.7778">Verify code_challenge</text><polygon fill="#181818" points="284.3994,784.2422,274.3994,788.2422,284.3994,792.2422,280.3994,788.2422" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="278.3994" x2="714.873" y1="788.2422" y2="788.2422"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="261.6377" x="290.3994" y="752.9106">Access Token, Refresh Token (optional),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190.6836" x="290.3994" y="768.0435">ID Token (if OpenID Connect)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="413.4736" x="290.3994" y="783.1763">(access_token, token_type, expires_in, refresh_token, id_token)</text><polygon fill="#181818" points="876.0381,828.5078,886.0381,832.5078,876.0381,836.5078,880.0381,832.5078" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="273.3994" x2="882.0381" y1="832.5078" y2="832.5078"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176.2109" x="280.3994" y="812.3091">Access Protected Resource</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97.2651" x="280.3994" y="827.4419">(access_token)</text><polygon fill="#181818" points="279.3994,857.6406,269.3994,861.6406,279.3994,865.6406,275.3994,861.6406" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="273.3994" x2="892.0381" y1="861.6406" y2="861.6406"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127.3467" x="285.3994" y="856.5747">Protected Resource</text><!--SRC=[lLLDRzGm4BtdLrXxsaWfe4fmMAb8Iq2buj1g5pXLYY9djckHni7sRYc_dXdRIMmdI1K7BXjxCXzlvhtP665QOBVRapcoorTl61sa4hzh8sJ7Ija0krPrPzYJG8-xB-MdBAkvaOfzqw1OhTcA3gy_AFc4prNMrye8BdgAALi1-20dVzpsVIkuJHwxhkB2Ur1dp4QXzC9Tuu0TQ7bI74BVmURzCulnuhq7ic4tdJ2YDi3gg9g2doVGXXeJPthj_3EkW6uhEuRleCH1-49a6GoPxutg1EODkuOE52NWQAxEW_jK9KeINDX5W3aERc0vF89Q7kksXUu1HgoZ9G4xsbEqV7Z13ae-nY3OUlzvU_dsNHwt4jG8R_DcnjnfDqie9_etYJXtZhNxRgr0zxBJK9dd7gweHi6upL29fa1w6w60c-gaH77VQIvxTD06onO9elHUFGAMRAxsSRk19gSZeIN1EPnOt0jz03g5azUepRH17mYBcKjg4mVZKxArE5ZrOdzDlfZIRUyG5_k75GAIvly1E6CtLJkqFEJDzh9CrrVv0qAQ7WYAuoZQlyepPdyJiW8Q8mtcoNZYpTk1KGBE_xXvOGylsxuvbl-rM3EiBrYk66sOmJRqd2Rwcqmu1wqTomME_81hUFIahsLFpDPjZXpUV1oigBxR7iY0WkoGvHnbKTiybN5vxCEAf63mgqSjw4fqf0kRVt0JZJj5MWpMSb9a_4qOOTyfQH00DAD30YKW8VcinDTe9lEi8RuaJqYG- -3y0G00]--></g></svg></p><p>The sequence diagram of this standard flow is self-explanatory.</p>
<div style="break-after:page"></div>
<h3 id="oauth-20-cross-domain-authorization-grant">OAuth 2.0 Cross-Domain Authorization Grant </h3>
<p>We need to replace the DomainKeys Identified Mail (DKIM) email authentication method by the Cross-Domain Authorization Grant, which we present as a JWT Assertion to Mailbox services running in different trust domains.</p>
<h4 id="to-authorize-the-transfer-of-the-placeholder-message">To authorize the transfer of the Placeholder Message: </h4>
<ul>
<li>We will use the OAuth 2.0 Token Exchange grant type (RFC 8693).</li>
<li>We will exchange the Access Token for a JWT Assertion.</li>
<li>We will use a JWT Assertion with the "eht" claim (a SHA-256 thumbprint of the set of Placeholder Message Envelope Headers that serves as a digital signature). This assertion embodies the DKIM signature.</li>
<li>We will use the DPoP mechanism to bind the JWT Assertion to the client.</li>
<li>The MBX1/MTA1 agent should be registered at the AS1 authorization server as a confidential client.</li>
</ul>
<h5 id="sequence-diagram-1">Sequence Diagram </h5>
<p class="plantuml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" data-diagram-type="SEQUENCE" height="1889px" preserveAspectRatio="none" style="width:1812px;height:1889px;background:#FFFFFF;" version="1.1" viewBox="0 0 1812 1889" width="1812px" zoomAndPan="magnify"><title>OAuth 2.0 Token Exchange for transferring Placeholder Messages using JWT Assertion and DPoP</title><defs></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="764.4766" x="530.8826" y="27.9951">OAuth 2.0 Token Exchange for transferring Placeholder Messages using JWT Assertion and DPoP</text><g><title>Client1</title><rect fill="#FFFFFF" height="881.1797" style="stroke:#181818;stroke-width:1;" width="10" x="31.7188" y="83.5938"></rect></g><g><title>MBX1/MTA1</title><rect fill="#FFFFFF" height="1652.5" style="stroke:#181818;stroke-width:1;" width="10" x="328.7275" y="119.8594"></rect></g><g><title>MBX1/MTA1</title><rect fill="#D3D3D3" height="541.3906" style="stroke:#181818;stroke-width:1;" width="10" x="333.7275" y="1188.8359"></rect></g><g><title>AS1 Authorization Server</title><rect fill="#FFFFFF" height="348.9922" style="stroke:#181818;stroke-width:1;" width="10" x="933.8389" y="571.5156"></rect></g><g><title>MBX2/MTA2</title><rect fill="#FFFFFF" height="622.6563" style="stroke:#181818;stroke-width:1;" width="10" x="1392.9604" y="1222.9688"></rect></g><g><title>MBX2/MTA2</title><rect fill="#D3D3D3" height="14" style="stroke:#181818;stroke-width:1;" width="10" x="1397.9604" y="1831.625"></rect></g><g><title>Client1</title><rect fill="transparent" height="1781.0313" width="8" x="32.7188" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="36" x2="36" y1="73.5938" y2="1854.625"></line></g><g><title>MBX1/MTA1</title><rect fill="transparent" height="1781.0313" width="8" x="329.7275" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="333.7207" x2="333.7207" y1="73.5938" y2="1854.625"></line></g><g><title>AS1 Authorization Server</title><rect fill="transparent" height="1781.0313" width="8" x="934.8389" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="937.8638" x2="937.8638" y1="73.5938" y2="1854.625"></line></g><g><title>MBX2/MTA2</title><rect fill="transparent" height="1781.0313" width="8" x="1393.9604" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1397.9536" x2="1397.9536" y1="73.5938" y2="1854.625"></line></g><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="63.4375" x="5" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="49.4375" x="12" y="62.292">Client1</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="63.4375" x="5" y="1853.625"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="49.4375" x="12" y="1873.6201">Client1</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="284.7207" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="291.7207" y="62.292">MBX1/MTA1</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="284.7207" y="1853.625"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="291.7207" y="1873.6201">MBX1/MTA1</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="189.9502" x="843.8638" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="175.9502" x="850.8638" y="62.292">AS1 Authorization Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="189.9502" x="843.8638" y="1853.625"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="175.9502" x="850.8638" y="1873.6201">AS1 Authorization Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="1348.9536" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="1355.9536" y="62.292">MBX2/MTA2</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="1348.9536" y="1853.625"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="1355.9536" y="1873.6201">MBX2/MTA2</text><g><title>Client1</title><rect fill="#FFFFFF" height="881.1797" style="stroke:#181818;stroke-width:1;" width="10" x="31.7188" y="83.5938"></rect></g><g><title>MBX1/MTA1</title><rect fill="#FFFFFF" height="1652.5" style="stroke:#181818;stroke-width:1;" width="10" x="328.7275" y="119.8594"></rect></g><g><title>MBX1/MTA1</title><rect fill="#D3D3D3" height="541.3906" style="stroke:#181818;stroke-width:1;" width="10" x="333.7275" y="1188.8359"></rect></g><g><title>AS1 Authorization Server</title><rect fill="#FFFFFF" height="348.9922" style="stroke:#181818;stroke-width:1;" width="10" x="933.8389" y="571.5156"></rect></g><g><title>MBX2/MTA2</title><rect fill="#FFFFFF" height="622.6563" style="stroke:#181818;stroke-width:1;" width="10" x="1392.9604" y="1222.9688"></rect></g><g><title>MBX2/MTA2</title><rect fill="#D3D3D3" height="14" style="stroke:#181818;stroke-width:1;" width="10" x="1397.9604" y="1831.625"></rect></g><polygon fill="#181818" points="316.7275,115.8594,326.7275,119.8594,316.7275,123.8594,320.7275,119.8594" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="41.7188" x2="322.7275" y1="119.8594" y2="119.8594"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="173.9448" x="48.7188" y="99.6606">Send Placeholder Message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156.6729" x="52.8511" y="114.7935">(includes Access Token)</text><line style="stroke:#181818;stroke-width:1;" x1="338.7275" x2="380.7275" y1="148.9922" y2="148.9922"></line><line style="stroke:#181818;stroke-width:1;" x1="380.7275" x2="380.7275" y1="148.9922" y2="161.9922"></line><line style="stroke:#181818;stroke-width:1;" x1="339.7275" x2="380.7275" y1="161.9922" y2="161.9922"></line><polygon fill="#181818" points="349.7275,157.9922,339.7275,161.9922,349.7275,165.9922,345.7275,161.9922" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273.3428" x="345.7275" y="143.9263">Generate DPoP Proof (using new key pair)</text><line style="stroke:#181818;stroke-width:1;" x1="338.7275" x2="380.7275" y1="206.2578" y2="206.2578"></line><line style="stroke:#181818;stroke-width:1;" x1="380.7275" x2="380.7275" y1="206.2578" y2="219.2578"></line><line style="stroke:#181818;stroke-width:1;" x1="339.7275" x2="380.7275" y1="219.2578" y2="219.2578"></line><polygon fill="#181818" points="349.7275,215.2578,339.7275,219.2578,349.7275,223.2578,345.7275,219.2578" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="445.3706" x="345.7275" y="186.0591">Create Body-Digest=&lt;SHA256(Placeholder Message Body)&gt; header</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249.7549" x="349.8599" y="201.1919">and add it to the Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="338.7275" x2="380.7275" y1="263.5234" y2="263.5234"></line><line style="stroke:#181818;stroke-width:1;" x1="380.7275" x2="380.7275" y1="263.5234" y2="276.5234"></line><line style="stroke:#181818;stroke-width:1;" x1="339.7275" x2="380.7275" y1="276.5234" y2="276.5234"></line><polygon fill="#181818" points="349.7275,272.5234,339.7275,276.5234,349.7275,280.5234,345.7275,276.5234" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="379.1455" x="345.7275" y="243.3247">Create Recipients-Digest=&lt;SHA256(To||Cc||Bcc)&gt; header</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249.7549" x="349.8599" y="258.4575">and add it to the Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="338.7275" x2="380.7275" y1="305.6563" y2="305.6563"></line><line style="stroke:#181818;stroke-width:1;" x1="380.7275" x2="380.7275" y1="305.6563" y2="318.6563"></line><line style="stroke:#181818;stroke-width:1;" x1="339.7275" x2="380.7275" y1="318.6563" y2="318.6563"></line><polygon fill="#181818" points="349.7275,314.6563,339.7275,318.6563,349.7275,322.6563,345.7275,318.6563" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="446.2529" x="345.7275" y="300.5903">Create Date=&lt;Date&gt; header and add it to the Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="338.7275" x2="380.7275" y1="362.9219" y2="362.9219"></line><line style="stroke:#181818;stroke-width:1;" x1="380.7275" x2="380.7275" y1="362.9219" y2="375.9219"></line><line style="stroke:#181818;stroke-width:1;" x1="339.7275" x2="380.7275" y1="375.9219" y2="375.9219"></line><polygon fill="#181818" points="349.7275,371.9219,339.7275,375.9219,349.7275,379.9219,345.7275,375.9219" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="536.999" x="345.7275" y="342.7231">Store the Placeholder Message in the store, using the Message-ID header value as</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="462.5791" x="349.8599" y="357.856">an identifier, &lt;Stored Placeholder Message&gt;=&lt;Placeholder Message&gt;</text><polygon fill="#181818" points="921.8389,567.5156,931.8389,571.5156,921.8389,575.5156,925.8389,571.5156" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="338.7275" x2="927.8389" y1="571.5156" y2="571.5156"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165.0645" x="345.7275" y="399.9888">Token Exchange Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="415.6763" x="345.7275" y="415.1216">(grant_type=urn:ietf:params:oauth:grant-type:token-exchange,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="401.1909" x="345.7275" y="430.2544">requested_token_type=urn:ietf:params:oauth:token-type:jwt,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215.7695" x="345.7275" y="445.3872">subject_token=&lt;Access Token&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="450.1377" x="345.7275" y="460.52">subject_token_type=urn:ietf:params:oauth:token-type:access_token,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="278.3574" x="345.7275" y="475.6528">headers=[{"Message-ID":&lt;Message-ID&gt;},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="271.0068" x="345.7275" y="490.7856">{"From":"Alice &lt;alice@example.com&gt;"},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="287.187" x="345.7275" y="505.9185">{"Recipients-Digest":&lt;Recipients-Digest&gt;},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="472.7925" x="345.7275" y="521.0513">{"Body-Digest":"nZURGvgk4xoy6-aI6dna5ddskq5ud_GyI7u96hkxYh4"}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136.8301" x="345.7275" y="536.1841">dpop=&lt;DPoP Proof&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185.0151" x="345.7275" y="551.3169">client_id=&lt;MTA1 client ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140.0674" x="345.7275" y="566.4497">scope=internet_mail)</text><line style="stroke:#181818;stroke-width:1;" x1="943.8389" x2="985.8389" y1="600.6484" y2="600.6484"></line><line style="stroke:#181818;stroke-width:1;" x1="985.8389" x2="985.8389" y1="600.6484" y2="613.6484"></line><line style="stroke:#181818;stroke-width:1;" x1="944.8389" x2="985.8389" y1="613.6484" y2="613.6484"></line><polygon fill="#181818" points="954.8389,609.6484,944.8389,613.6484,954.8389,617.6484,950.8389,613.6484" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146.0532" x="950.8389" y="595.5825">Validate Access Token</text><line style="stroke:#181818;stroke-width:1;" x1="943.8389" x2="985.8389" y1="642.7813" y2="642.7813"></line><line style="stroke:#181818;stroke-width:1;" x1="985.8389" x2="985.8389" y1="642.7813" y2="655.7813"></line><line style="stroke:#181818;stroke-width:1;" x1="944.8389" x2="985.8389" y1="655.7813" y2="655.7813"></line><polygon fill="#181818" points="954.8389,651.7813,944.8389,655.7813,954.8389,659.7813,950.8389,655.7813" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128.9717" x="950.8389" y="637.7153">Validate DPoP Proof</text><line style="stroke:#181818;stroke-width:1;" x1="943.8389" x2="985.8389" y1="700.0469" y2="700.0469"></line><line style="stroke:#181818;stroke-width:1;" x1="985.8389" x2="985.8389" y1="700.0469" y2="713.0469"></line><line style="stroke:#181818;stroke-width:1;" x1="944.8389" x2="985.8389" y1="713.0469" y2="713.0469"></line><polygon fill="#181818" points="954.8389,709.0469,944.8389,713.0469,954.8389,717.0469,950.8389,713.0469" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="415.5303" x="950.8389" y="679.8481">Verify that the "From" header (the email address of the sender)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="348.4102" x="954.9712" y="694.981">matches the email claim present in the Access Token</text><line style="stroke:#181818;stroke-width:1;" x1="943.8389" x2="985.8389" y1="832.9766" y2="832.9766"></line><line style="stroke:#181818;stroke-width:1;" x1="985.8389" x2="985.8389" y1="832.9766" y2="845.9766"></line><line style="stroke:#181818;stroke-width:1;" x1="944.8389" x2="985.8389" y1="845.9766" y2="845.9766"></line><polygon fill="#181818" points="954.8389,841.9766,944.8389,845.9766,954.8389,849.9766,950.8389,845.9766" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="203.8613" x="950.8389" y="737.1138">Create JWT Assertion (iss=AS1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139.1279" x="954.9712" y="752.2466">scope=internet_mail,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92.1362" x="954.9712" y="767.3794">azp=client_id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245.7622" x="954.9712" y="782.5122">cnf={jkt=SHA256(JWK Thumbprint)},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="373.8579" x="954.9712" y="797.645">eh={eht=SHA256(Message-ID||From||Recipients-Digest||</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88.4546" x="959.1035" y="812.7778">Body-Digest),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="416.8569" x="959.1035" y="827.9106">ehl=["Message-ID","From","Recipients-Digest","Body-Digest"]})</text><polygon fill="#181818" points="349.7275,916.5078,339.7275,920.5078,349.7275,924.5078,345.7275,920.5078" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="343.7275" x2="937.8389" y1="920.5078" y2="920.5078"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174.6938" x="355.7275" y="870.0435">Token Exchange Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218.4482" x="355.7275" y="885.1763">(access_token=&lt;JWT Assertion&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="328.7388" x="355.7275" y="900.3091">token_type=urn:ietf:params:oauth:token-type:jwt,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377.8252" x="355.7275" y="915.4419">issued_token_type=urn:ietf:params:oauth:token-type:jwt)</text><polygon fill="#181818" points="47.7188,960.7734,37.7188,964.7734,47.7188,968.7734,43.7188,964.7734" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="41.7188" x2="327.7275" y1="964.7734" y2="964.7734"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="263.0088" x="53.7188" y="944.5747">The sending of the Placeholder Message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133.2563" x="57.8511" y="959.7075">has been authorized</text><line style="stroke:#181818;stroke-width:1;" x1="338.7275" x2="380.7275" y1="1039.3047" y2="1039.3047"></line><line style="stroke:#181818;stroke-width:1;" x1="380.7275" x2="380.7275" y1="1039.3047" y2="1052.3047"></line><line style="stroke:#181818;stroke-width:1;" x1="339.7275" x2="380.7275" y1="1052.3047" y2="1052.3047"></line><polygon fill="#181818" points="349.7275,1048.3047,339.7275,1052.3047,349.7275,1056.3047,345.7275,1052.3047" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="571.1113" x="345.7275" y="988.8403">Replace the stored Placeholder Message with the new JWT Signed Placeholder Message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="499.7573" x="349.8599" y="1003.9731">&lt;Stored Placeholder Message&gt;=&lt;JWT Assertion&gt;||&lt;Placeholder Message&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="508.9106" x="349.8599" y="1019.106">use this Stored Placeholder Message as an access control list to grant or deny</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190.6772" x="349.8599" y="1034.2388">access to External Resources</text><line style="stroke:#181818;stroke-width:1;" x1="338.7275" x2="380.7275" y1="1081.4375" y2="1081.4375"></line><line style="stroke:#181818;stroke-width:1;" x1="380.7275" x2="380.7275" y1="1081.4375" y2="1094.4375"></line><line style="stroke:#181818;stroke-width:1;" x1="339.7275" x2="380.7275" y1="1094.4375" y2="1094.4375"></line><polygon fill="#181818" points="349.7275,1090.4375,339.7275,1094.4375,349.7275,1098.4375,345.7275,1094.4375" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="497.3262" x="345.7275" y="1076.3716">Generate new DPoP Proof (using the same key pair, for MBX2/MTA2 service)</text><line style="stroke:#181818;stroke-width:1;" x1="338.7275" x2="380.7275" y1="1138.7031" y2="1138.7031"></line><line style="stroke:#181818;stroke-width:1;" x1="380.7275" x2="380.7275" y1="1138.7031" y2="1151.7031"></line><line style="stroke:#181818;stroke-width:1;" x1="339.7275" x2="380.7275" y1="1151.7031" y2="1151.7031"></line><polygon fill="#181818" points="349.7275,1147.7031,339.7275,1151.7031,349.7275,1155.7031,345.7275,1151.7031" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="502.106" x="345.7275" y="1118.5044">Use DNS to discover MBX2/MTA2 service using the domain part of recipient's</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91.3428" x="349.8599" y="1133.6372">email address</text><line style="stroke:#181818;stroke-width:1;" x1="338.7275" x2="385.7275" y1="1175.8359" y2="1175.8359"></line><line style="stroke:#181818;stroke-width:1;" x1="385.7275" x2="385.7275" y1="1175.8359" y2="1188.8359"></line><line style="stroke:#181818;stroke-width:1;" x1="344.7275" x2="385.7275" y1="1188.8359" y2="1188.8359"></line><polygon fill="#181818" points="354.7275,1184.8359,344.7275,1188.8359,354.7275,1192.8359,350.7275,1188.8359" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="318.6841" x="350.7275" y="1170.77">Oueue the Placeholder Message transfer request</text><polygon fill="#181818" points="1380.9604,1218.9688,1390.9604,1222.9688,1380.9604,1226.9688,1384.9604,1222.9688" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="343.7275" x2="1386.9604" y1="1222.9688" y2="1222.9688"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="869.7305" x="350.7275" y="1217.9028">Transfer the Placeholder Message (message=&lt;Placeholder Message&gt;, Authorization: Bearer &lt;JWT Assertion&gt;, DPoP: &lt;DPoP Proof&gt;)</text><line style="stroke:#181818;stroke-width:1;" x1="1402.9604" x2="1444.9604" y1="1252.1016" y2="1252.1016"></line><line style="stroke:#181818;stroke-width:1;" x1="1444.9604" x2="1444.9604" y1="1252.1016" y2="1265.1016"></line><line style="stroke:#181818;stroke-width:1;" x1="1403.9604" x2="1444.9604" y1="1265.1016" y2="1265.1016"></line><polygon fill="#181818" points="1413.9604,1261.1016,1403.9604,1265.1016,1413.9604,1269.1016,1409.9604,1265.1016" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="374.9941" x="1409.9604" y="1247.0356">Validate DPoP Proof (using "jkt" from JWT Assertion "cnf")</text><line style="stroke:#181818;stroke-width:1;" x1="1402.9604" x2="1444.9604" y1="1309.3672" y2="1309.3672"></line><line style="stroke:#181818;stroke-width:1;" x1="1444.9604" x2="1444.9604" y1="1309.3672" y2="1322.3672"></line><line style="stroke:#181818;stroke-width:1;" x1="1403.9604" x2="1444.9604" y1="1322.3672" y2="1322.3672"></line><polygon fill="#181818" points="1413.9604,1318.3672,1403.9604,1322.3672,1413.9604,1326.3672,1409.9604,1322.3672" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="395.2813" x="1409.9604" y="1289.1685">Validate JWT Assertion, use DNS discovery to verify that AS1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="269.7944" x="1414.0928" y="1304.3013">is the corresponding JWT Assertion issuer</text><line style="stroke:#181818;stroke-width:1;" x1="1402.9604" x2="1444.9604" y1="1351.5" y2="1351.5"></line><line style="stroke:#181818;stroke-width:1;" x1="1444.9604" x2="1444.9604" y1="1351.5" y2="1364.5"></line><line style="stroke:#181818;stroke-width:1;" x1="1403.9604" x2="1444.9604" y1="1364.5" y2="1364.5"></line><polygon fill="#181818" points="1413.9604,1360.5,1403.9604,1364.5,1413.9604,1368.5,1409.9604,1364.5" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166.6641" x="1409.9604" y="1346.4341">Verify the "eht" signature</text><line style="stroke:#181818;stroke-width:1;" x1="1402.9604" x2="1444.9604" y1="1408.7656" y2="1408.7656"></line><line style="stroke:#181818;stroke-width:1;" x1="1444.9604" x2="1444.9604" y1="1408.7656" y2="1421.7656"></line><line style="stroke:#181818;stroke-width:1;" x1="1403.9604" x2="1444.9604" y1="1421.7656" y2="1421.7656"></line><polygon fill="#181818" points="1413.9604,1417.7656,1403.9604,1421.7656,1413.9604,1425.7656,1409.9604,1421.7656" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382.2114" x="1409.9604" y="1388.5669">Use DNS discovery to verify that MTA1 is the correct client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127.5625" x="1414.0928" y="1403.6997">making the request</text><line style="stroke:#181818;stroke-width:1;" x1="1402.9604" x2="1444.9604" y1="1466.0313" y2="1466.0313"></line><line style="stroke:#181818;stroke-width:1;" x1="1444.9604" x2="1444.9604" y1="1466.0313" y2="1479.0313"></line><line style="stroke:#181818;stroke-width:1;" x1="1403.9604" x2="1444.9604" y1="1479.0313" y2="1479.0313"></line><polygon fill="#181818" points="1413.9604,1475.0313,1403.9604,1479.0313,1413.9604,1483.0313,1409.9604,1479.0313" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="262.1836" x="1409.9604" y="1445.8325">Create JWT Signed Placeholder Message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="369.9478" x="1414.0928" y="1460.9653">&lt;Placeholder Message&gt;=&lt;JWT Assertion&gt;||&lt;message&gt;</text><line style="stroke:#181818;stroke-width:1;" x1="1402.9604" x2="1444.9604" y1="1523.2969" y2="1523.2969"></line><line style="stroke:#181818;stroke-width:1;" x1="1444.9604" x2="1444.9604" y1="1523.2969" y2="1536.2969"></line><line style="stroke:#181818;stroke-width:1;" x1="1403.9604" x2="1444.9604" y1="1536.2969" y2="1536.2969"></line><polygon fill="#181818" points="1413.9604,1532.2969,1403.9604,1536.2969,1413.9604,1540.2969,1409.9604,1536.2969" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="284.0386" x="1409.9604" y="1503.0981">Create Received=&lt;from, by, Date&gt; header</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249.7549" x="1414.0928" y="1518.231">and add it to the Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="1402.9604" x2="1444.9604" y1="1580.5625" y2="1580.5625"></line><line style="stroke:#181818;stroke-width:1;" x1="1444.9604" x2="1444.9604" y1="1580.5625" y2="1593.5625"></line><line style="stroke:#181818;stroke-width:1;" x1="1403.9604" x2="1444.9604" y1="1593.5625" y2="1593.5625"></line><polygon fill="#181818" points="1413.9604,1589.5625,1403.9604,1593.5625,1413.9604,1597.5625,1409.9604,1593.5625" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="281.2456" x="1409.9604" y="1560.3638">Create Message-ID=&lt;Message-ID&gt; header</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249.7549" x="1414.0928" y="1575.4966">and add it to the Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="1402.9604" x2="1444.9604" y1="1652.9609" y2="1652.9609"></line><line style="stroke:#181818;stroke-width:1;" x1="1444.9604" x2="1444.9604" y1="1652.9609" y2="1665.9609"></line><line style="stroke:#181818;stroke-width:1;" x1="1403.9604" x2="1444.9604" y1="1665.9609" y2="1665.9609"></line><polygon fill="#181818" points="1413.9604,1661.9609,1403.9604,1665.9609,1413.9604,1669.9609,1409.9604,1665.9609" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="284.1973" x="1409.9604" y="1617.6294">Store the Placeholder Message in the store,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="335.6133" x="1414.0928" y="1632.7622">using the Message-ID header value as an identifier,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="375.6353" x="1414.0928" y="1647.895">&lt;Stored Placeholder Message&gt;=&lt;Placeholder Message&gt;</text><polygon fill="#181818" points="354.7275,1691.0938,344.7275,1695.0938,354.7275,1699.0938,350.7275,1695.0938" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="348.7275" x2="1391.9604" y1="1695.0938" y2="1695.0938"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="283.6323" x="360.7275" y="1690.0278">Placeholder Message Delivery Confirmation</text><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="343.7275" x2="385.7275" y1="1729.2266" y2="1729.2266"></line><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="385.7275" x2="385.7275" y1="1729.2266" y2="1742.2266"></line><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="338.7275" x2="385.7275" y1="1742.2266" y2="1742.2266"></line><polygon fill="#181818" points="348.7275,1738.2266,338.7275,1742.2266,348.7275,1746.2266,344.7275,1742.2266" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334.7119" x="350.7275" y="1724.1606">Dequeue the Placeholder Message transfer request</text><line style="stroke:#181818;stroke-width:1;" x1="338.7275" x2="380.7275" y1="1771.3594" y2="1771.3594"></line><line style="stroke:#181818;stroke-width:1;" x1="380.7275" x2="380.7275" y1="1771.3594" y2="1784.3594"></line><line style="stroke:#181818;stroke-width:1;" x1="333.7275" x2="380.7275" y1="1784.3594" y2="1784.3594"></line><polygon fill="#181818" points="343.7275,1780.3594,333.7275,1784.3594,343.7275,1788.3594,339.7275,1784.3594" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="407.7798" x="345.7275" y="1766.2935">The Placeholder Message transfer request has been dequeued</text><line style="stroke:#181818;stroke-width:1;" x1="1402.9604" x2="1449.9604" y1="1818.625" y2="1818.625"></line><line style="stroke:#181818;stroke-width:1;" x1="1449.9604" x2="1449.9604" y1="1818.625" y2="1831.625"></line><line style="stroke:#181818;stroke-width:1;" x1="1408.9604" x2="1449.9604" y1="1831.625" y2="1831.625"></line><polygon fill="#181818" points="1418.9604,1827.625,1408.9604,1831.625,1418.9604,1835.625,1414.9604,1831.625" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="325.8062" x="1414.9604" y="1798.4263">Queue the Placeholder Message proceeding using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="292.2334" x="1419.0928" y="1813.5591">the Message-ID header value as an identifier</text><!--SRC=[hLTHSnet47xdL-nS7m8pEAsPs9qo75DiNDTfqxYsqxGD6Ozyjt0oXtJHwOY9oN_lIdS7To1ZUveN0zBgszLgz_lMckiOuUqWqn5qNlu0LtAA0axkWeY92S9OAj2AYNICId4nWVEO1HZ9E4G5Rp1DsGHJo5ApzVhz5GpI59NcKW0J8GpFvNaZORGGy8G93Tvnp57eVGzO2iNtki6Rex_tltzpDSXDJeJcUh5XChZS1nElLFmBixukKSrHsHDc8_-vXTink9qARgVHO87cSwPn5Kpn2NlzqdcNuEakZekF13Iv2E8if1mCWe1My_orrhZb3Hh5bnhmAGfKniea2iwLb6DeviaK-1cck824STLo7ZvMQ8uUoN2nD-Jq3DhlNVuww1mSDXsnMhjM7o9aj3hAtuU58N0DMeAEq7N3NOula79hafLkkh-Io-Lni5mU1S4tzJYaFtxF_2rH_mVcfPOA7pe1NDYjr1YrY_es2yN-tjcmZ63EuWoffkm5WOUK43xcgDhGiowSbTFtUwxLQg3hGkvkDkK5VieetoFHd51hwckzID3FbEXorECkbJsRfLt92A1h3VQCGLSRa3qiGDeZeN8O3A_jrYwO_Ao5kVsiwMoQtTnYeFEJVgzQ_FtDxIS2CukH7o68FBsf_-7UMoVTw_RMF_fVoUpU-qN9cTVr1Z4F47hCVFoCTsoMnFWoaBE-bvjjbIjXRQqLa9MU8cJnxxkBq_ba-kfEBWxtsDbXADX16ARJJmTPU7swEFin- -amcjxz4xtolduaW32H2TNfggVx8o89u-QQXtxFa1lalu4kOR8LI4eG5ngLG7qzOpokC4Y5qHhhxvibyXTTFBJcbQTuYlqwp5tMgFXuGHt0j6s3FEbb2pJD4fgmJIyguvw8pFOFCIUg5lN6ZEaW8ffScmOnupD8oDnaecYu9qPV449TSPeyJNqI1yeeE59gbjcNn5yzXLa8nDY_lvrglw2kr-z_Wwieczqaf7QwPSe1CFBlCLgPh0jmkJHfM2wtocYvf6DLPcuP70AA_G_LQcxdUMmxYhDTAyAFNrlrnwyosHOxf8aKAQbJizfIVg-MBLDtpszxod3sVBveDK9qblEAxkWwXV3ITOgwCPHRb95RUoCIyXkagxDY6C2mwgXKT2VxNs1YCDSaxwHf-CnfB38sHevD_YxvHE13my1kmg-dVxbqAe2faomrSV4K7eOpCmofJVw-44YXbOmXvgcLGKlwG9CRYT5Yj3AZdPCxqn0iDaKYCqNBk-SIS-tjsSGcZSrmDQ2qxPou6h7e-TISQBZbplqxkj_mZqiJJyYfKKr1RvsjQ6uegNq5c77E58GgU-M5qTmQxJZTlSqmUrZeo-4M2ZNScjpWkz_v9DAdYYqSr-bGlPO83xbepl8lRirlrsVPBXmXKxI_sQxs7RfGbPMjCRDJHjYfHUZW-l8fFU8-3yR4GXjawX4pUgtTSBKJRLktvbtBHrsO5vvNb8EucLwCvo8GIAKiKuNR_pjOcb5kvoKUYH2HiWSfTIJJcKAd-Rl7Oh9gN0qfq8KuMz6QbaLObeVBIKMDTlF34ubXLXy7dSv8CP3FaUO9ytXjk5cqeJePFtFUTlfOAvLV7Rk-XOTdJD-M4H-VlpUcxqVfUCVytQdhgol28SRSbjEn56EkPhPt6oygyhFHaVjrpA4ff-VGqXRolfFihfw8jnRFC8yaT7bmFjsVEmDFb0mGRK_RLnk9PxtR5gDLwVS_]--></g></svg></p><p>The sequence diagram of this flow is self-explanatory.</p>
<div style="break-after:page"></div>
<h4 id="to-authorize-relayingforwarding-of-the-placeholder-message">To authorize relaying/forwarding of the Placeholder Message: </h4>
<ul>
<li>We will use the OAuth 2.0 Token Exchange grant type (RFC 8693).</li>
<li>We will exchange the JWT Assertion for another JWT Assertion.</li>
<li>We will use a JWT Assertion with the "eht" claim (a SHA-256 thumbprint of the set of Placeholder Message Envelope Headers that serves as a digital signature). This assertion embodies the DKIM signature.</li>
<li>A forwarding policy can be set on the authorization server e.g., user may/may not be allowed to autoforward Placeholder Messages.</li>
<li>The forwarding MBX2/MTA2 entity should not fetch the External Resources—only the final destination MBX3/MTA3 agent should.</li>
<li>We will use the DPoP mechanism to bind the JWT Assertion to the client.</li>
<li>The token exchange and relaying/forwarding process can begin after the successful Placeholder Message delivery.</li>
</ul>
<p>Suppose we have another trust domain, <a href="http://example.org">example.org</a>, and user Bob has two email addresses: <a href="mailto:bob@example.net">bob@example.net</a> and <a href="mailto:bobby@example.org">bobby@example.org</a>. The sequence diagram below illustrates the relaying/forwarding process, in which the MBX2/MTA2 entity in the <a href="http://example.net">example.net</a> trust domain forwards a Placeholder Message to the destination MBX3/MTA3 service operating within the <a href="http://example.org">example.org</a> trust domain.</p>
<h5 id="sequence-diagram-2">Sequence Diagram </h5>
<p class="plantuml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" data-diagram-type="SEQUENCE" height="1988px" preserveAspectRatio="none" style="width:1496px;height:1988px;background:#FFFFFF;" version="1.1" viewBox="0 0 1496 1988" width="1496px" zoomAndPan="magnify"><title>OAuth 2.0 Token Exchange for relaying/forwarding Placeholder Message using JWT Assertion and DPoP</title><defs></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="816.9971" x="346.906" y="27.9951">OAuth 2.0 Token Exchange for relaying/forwarding Placeholder Message using JWT Assertion and DPoP</text><g><title>MBX2/MTA2</title><rect fill="#FFFFFF" height="1787.1641" style="stroke:#181818;stroke-width:1;" width="10" x="49.0068" y="83.5938"></rect></g><g><title>MBX2/MTA2</title><rect fill="#D3D3D3" height="99.5313" style="stroke:#181818;stroke-width:1;" width="10" x="54.0068" y="83.5938"></rect></g><g><title>MBX2/MTA2</title><rect fill="#D3D3D3" height="526.2578" style="stroke:#181818;stroke-width:1;" width="10" x="54.0068" y="1302.3672"></rect></g><g><title>AS2 Authorization Server</title><rect fill="#FFFFFF" height="364.125" style="stroke:#181818;stroke-width:1;" width="10" x="654.1182" y="714.1797"></rect></g><g><title>MBX3/MTA3</title><rect fill="#FFFFFF" height="607.5234" style="stroke:#181818;stroke-width:1;" width="10" x="1077.5278" y="1336.5"></rect></g><g><title>MBX3/MTA3</title><rect fill="#D3D3D3" height="14" style="stroke:#181818;stroke-width:1;" width="10" x="1082.5278" y="1930.0234"></rect></g><g><title>MBX2/MTA2</title><rect fill="transparent" height="1879.4297" width="8" x="50.0068" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="54" x2="54" y1="73.5938" y2="1953.0234"></line></g><g><title>AS2 Authorization Server</title><rect fill="transparent" height="1879.4297" width="8" x="655.1182" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="658.1431" x2="658.1431" y1="73.5938" y2="1953.0234"></line></g><g><title>MBX3/MTA3</title><rect fill="transparent" height="1879.4297" width="8" x="1078.5278" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1082.521" x2="1082.521" y1="73.5938" y2="1953.0234"></line></g><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="5" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="12" y="62.292">MBX2/MTA2</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="5" y="1952.0234"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="12" y="1972.0186">MBX2/MTA2</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="189.9502" x="564.1431" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="175.9502" x="571.1431" y="62.292">AS2 Authorization Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="189.9502" x="564.1431" y="1952.0234"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="175.9502" x="571.1431" y="1972.0186">AS2 Authorization Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="1033.521" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="1040.521" y="62.292">MBX3/MTA3</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="1033.521" y="1952.0234"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="1040.521" y="1972.0186">MBX3/MTA3</text><g><title>MBX2/MTA2</title><rect fill="#FFFFFF" height="1787.1641" style="stroke:#181818;stroke-width:1;" width="10" x="49.0068" y="83.5938"></rect></g><g><title>MBX2/MTA2</title><rect fill="#D3D3D3" height="99.5313" style="stroke:#181818;stroke-width:1;" width="10" x="54.0068" y="83.5938"></rect></g><g><title>MBX2/MTA2</title><rect fill="#D3D3D3" height="526.2578" style="stroke:#181818;stroke-width:1;" width="10" x="54.0068" y="1302.3672"></rect></g><g><title>AS2 Authorization Server</title><rect fill="#FFFFFF" height="364.125" style="stroke:#181818;stroke-width:1;" width="10" x="654.1182" y="714.1797"></rect></g><g><title>MBX3/MTA3</title><rect fill="#FFFFFF" height="607.5234" style="stroke:#181818;stroke-width:1;" width="10" x="1077.5278" y="1336.5"></rect></g><g><title>MBX3/MTA3</title><rect fill="#D3D3D3" height="14" style="stroke:#181818;stroke-width:1;" width="10" x="1082.5278" y="1930.0234"></rect></g><line style="stroke:#181818;stroke-width:1;" x1="64.0068" x2="106.0068" y1="134.9922" y2="134.9922"></line><line style="stroke:#181818;stroke-width:1;" x1="106.0068" x2="106.0068" y1="134.9922" y2="147.9922"></line><line style="stroke:#181818;stroke-width:1;" x1="65.0068" x2="106.0068" y1="147.9922" y2="147.9922"></line><polygon fill="#181818" points="75.0068,143.9922,65.0068,147.9922,75.0068,151.9922,71.0068,147.9922" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="342.4434" x="71.0068" y="99.6606">Load the Placeholder Message using the Message-ID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="284.5591" x="75.1392" y="114.7935">header value as an identifier from the store</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="375.6353" x="71.0068" y="129.9263">&lt;Placeholder Message&gt;=&lt;Stored Placeholder Message&gt;</text><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="64.0068" x2="106.0068" y1="182.125" y2="182.125"></line><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="106.0068" x2="106.0068" y1="182.125" y2="195.125"></line><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="59.0068" x2="106.0068" y1="195.125" y2="195.125"></line><polygon fill="#181818" points="69.0068,191.125,59.0068,195.125,69.0068,199.125,65.0068,195.125" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="311.9238" x="71.0068" y="177.0591">The Placeholder Message proceeding dequeued</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="219.2578" y2="219.2578"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="219.2578" y2="232.2578"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="232.2578" y2="232.2578"></line><polygon fill="#181818" points="70.0068,228.2578,60.0068,232.2578,70.0068,236.2578,66.0068,232.2578" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273.3428" x="66.0068" y="214.1919">Generate DPoP Proof (using new key pair)</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="276.5234" y2="276.5234"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="276.5234" y2="289.5234"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="289.5234" y2="289.5234"></line><polygon fill="#181818" points="70.0068,285.5234,60.0068,289.5234,70.0068,293.5234,66.0068,289.5234" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="368.0498" x="66.0068" y="256.3247">Create JWT-Assertion-Digest=&lt;SHA256(JWT Assertion)&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="299.6855" x="70.1392" y="271.4575">header and add it to the Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="333.7891" y2="333.7891"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="333.7891" y2="346.7891"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="346.7891" y2="346.7891"></line><polygon fill="#181818" points="70.0068,342.7891,60.0068,346.7891,70.0068,350.7891,66.0068,346.7891" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="356.6812" x="66.0068" y="313.5903">Create Forwarded-From=&lt;bob@example.net&gt; header</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249.7549" x="70.1392" y="328.7231">and add it to the Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="391.0547" y2="391.0547"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="391.0547" y2="404.0547"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="404.0547" y2="404.0547"></line><polygon fill="#181818" points="70.0068,400.0547,60.0068,404.0547,70.0068,408.0547,66.0068,404.0547" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="355.2974" x="66.0068" y="370.856">Create Forwarded-To=&lt;bobby@example.org&gt; header</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249.7549" x="70.1392" y="385.9888">and add it to the Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="448.3203" y2="448.3203"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="448.3203" y2="461.3203"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="461.3203" y2="461.3203"></line><polygon fill="#181818" points="70.0068,457.3203,60.0068,461.3203,70.0068,465.3203,66.0068,461.3203" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="396.1001" x="66.0068" y="428.1216">Create Recipients-Digest=&lt;SHA256(Forwarded-To)&gt; header</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249.7549" x="70.1392" y="443.2544">and add it to the Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="490.4531" y2="490.4531"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="490.4531" y2="503.4531"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="503.4531" y2="503.4531"></line><polygon fill="#181818" points="70.0068,499.4531,60.0068,503.4531,70.0068,507.4531,66.0068,503.4531" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="446.2529" x="66.0068" y="485.3872">Create Date=&lt;Date&gt; header and add it to the Placeholder Message</text><polygon fill="#181818" points="642.1182,710.1797,652.1182,714.1797,642.1182,718.1797,646.1182,714.1797" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="648.1182" y1="714.1797" y2="714.1797"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165.0645" x="66.0068" y="527.52">Token Exchange Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="415.6763" x="66.0068" y="542.6528">(grant_type=urn:ietf:params:oauth:grant-type:token-exchange,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="401.1909" x="66.0068" y="557.7856">requested_token_type=urn:ietf:params:oauth:token-type:jwt,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="216.6899" x="66.0068" y="572.9185">subject_token=&lt;JWT Assertion&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382.3574" x="66.0068" y="588.0513">subject_token_type=urn:ietf:params:oauth:token-type:jwt,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="278.3574" x="66.0068" y="603.1841">headers=[{"Message-ID":&lt;Message-ID&gt;},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="326.4727" x="66.0068" y="618.3169">{"Forwarded-From":"Bob &lt;bob@example.net&gt;"},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="287.187" x="66.0068" y="633.4497">{"Recipients-Digest":&lt;Recipients-Digest&gt;},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="335.0547" x="66.0068" y="648.5825">{"Forwarded-To":"Bobby &lt;bobby@example.org&gt;},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="336.7432" x="66.0068" y="663.7153">{"JWT-Assertion-Digest":&lt;JWT-Assertion-Digest&gt;}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136.8301" x="66.0068" y="678.8481">dpop=&lt;DPoP Proof&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180.8828" x="66.0068" y="693.981">client_id=&lt;MTA2 client ID&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140.0674" x="66.0068" y="709.1138">scope=internet_mail)</text><line style="stroke:#181818;stroke-width:1;" x1="664.1182" x2="706.1182" y1="743.3125" y2="743.3125"></line><line style="stroke:#181818;stroke-width:1;" x1="706.1182" x2="706.1182" y1="743.3125" y2="756.3125"></line><line style="stroke:#181818;stroke-width:1;" x1="665.1182" x2="706.1182" y1="756.3125" y2="756.3125"></line><polygon fill="#181818" points="675.1182,752.3125,665.1182,756.3125,675.1182,760.3125,671.1182,756.3125" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146.9736" x="671.1182" y="738.2466">Validate JWT Assertion</text><line style="stroke:#181818;stroke-width:1;" x1="664.1182" x2="706.1182" y1="785.4453" y2="785.4453"></line><line style="stroke:#181818;stroke-width:1;" x1="706.1182" x2="706.1182" y1="785.4453" y2="798.4453"></line><line style="stroke:#181818;stroke-width:1;" x1="665.1182" x2="706.1182" y1="798.4453" y2="798.4453"></line><polygon fill="#181818" points="675.1182,794.4453,665.1182,798.4453,675.1182,802.4453,671.1182,798.4453" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128.9717" x="671.1182" y="780.3794">Validate DPoP Proof</text><line style="stroke:#181818;stroke-width:1;" x1="664.1182" x2="706.1182" y1="842.7109" y2="842.7109"></line><line style="stroke:#181818;stroke-width:1;" x1="706.1182" x2="706.1182" y1="842.7109" y2="855.7109"></line><line style="stroke:#181818;stroke-width:1;" x1="665.1182" x2="706.1182" y1="855.7109" y2="855.7109"></line><polygon fill="#181818" points="675.1182,851.7109,665.1182,855.7109,675.1182,859.7109,671.1182,855.7109" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="295.7056" x="671.1182" y="822.5122">Evaluate the Forwarded-From header against</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199.4243" x="675.2505" y="837.645">the policy/rules set on the AS2</text><line style="stroke:#181818;stroke-width:1;" x1="664.1182" x2="706.1182" y1="990.7734" y2="990.7734"></line><line style="stroke:#181818;stroke-width:1;" x1="706.1182" x2="706.1182" y1="990.7734" y2="1003.7734"></line><line style="stroke:#181818;stroke-width:1;" x1="665.1182" x2="706.1182" y1="1003.7734" y2="1003.7734"></line><polygon fill="#181818" points="675.1182,999.7734,665.1182,1003.7734,675.1182,1007.7734,671.1182,1003.7734" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="203.8613" x="671.1182" y="879.7778">Create JWT Assertion (iss=AS2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139.1279" x="675.2505" y="894.9106">scope=internet_mail,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92.1362" x="675.2505" y="910.0435">azp=client_id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245.7622" x="675.2505" y="925.1763">cnf={jkt=SHA256(JWK Thumbprint)},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="324.8159" x="675.2505" y="940.3091">eh={eht=SHA256(Message-ID||Forwarded-From||</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="268.5947" x="679.3828" y="955.4419">Recipients-Digest||JWT-Assertion-Digest),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="381.145" x="679.3828" y="970.5747">ehl=["Message-ID","Forwarded-From","Recipients-Digest",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166.8101" x="679.3828" y="985.7075">"JWT-Assertion-Digest"]})</text><polygon fill="#181818" points="70.0068,1074.3047,60.0068,1078.3047,70.0068,1082.3047,66.0068,1078.3047" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="64.0068" x2="658.1182" y1="1078.3047" y2="1078.3047"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174.6938" x="76.0068" y="1027.8403">Token Exchange Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218.4482" x="76.0068" y="1042.9731">(access_token=&lt;JWT Assertion&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="328.7388" x="76.0068" y="1058.106">token_type=urn:ietf:params:oauth:token-type:jwt,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377.8252" x="76.0068" y="1073.2388">issued_token_type=urn:ietf:params:oauth:token-type:jwt)</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="1152.8359" y2="1152.8359"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="1152.8359" y2="1165.8359"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="1165.8359" y2="1165.8359"></line><polygon fill="#181818" points="70.0068,1161.8359,60.0068,1165.8359,70.0068,1169.8359,66.0068,1165.8359" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="571.1113" x="66.0068" y="1102.3716">Replace the stored Placeholder Message with the new JWT Signed Placeholder Message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="499.7573" x="70.1392" y="1117.5044">&lt;Stored Placeholder Message&gt;=&lt;JWT Assertion&gt;||&lt;Placeholder Message&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="477.2104" x="70.1392" y="1132.6372">no need to use this Stored Placeholder Message as an access control list,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="484.5737" x="70.1392" y="1147.77">the External Resources will be fetched from the origin MBX1/MTA1 service</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="1194.9688" y2="1194.9688"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="1194.9688" y2="1207.9688"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="1207.9688" y2="1207.9688"></line><polygon fill="#181818" points="70.0068,1203.9688,60.0068,1207.9688,70.0068,1211.9688,66.0068,1207.9688" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="497.3262" x="66.0068" y="1189.9028">Generate new DPoP Proof (using the same key pair, for MBX3/MTA3 service)</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="1252.2344" y2="1252.2344"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="1252.2344" y2="1265.2344"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="1265.2344" y2="1265.2344"></line><polygon fill="#181818" points="70.0068,1261.2344,60.0068,1265.2344,70.0068,1269.2344,66.0068,1265.2344" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="430.3267" x="66.0068" y="1232.0356">Use DNS to discover MBX3/MTA3 service using the domain part of</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163.1221" x="70.1392" y="1247.1685">recipient's email address</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="106.0068" y1="1289.3672" y2="1289.3672"></line><line style="stroke:#181818;stroke-width:1;" x1="106.0068" x2="106.0068" y1="1289.3672" y2="1302.3672"></line><line style="stroke:#181818;stroke-width:1;" x1="65.0068" x2="106.0068" y1="1302.3672" y2="1302.3672"></line><polygon fill="#181818" points="75.0068,1298.3672,65.0068,1302.3672,75.0068,1306.3672,71.0068,1302.3672" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="318.6841" x="71.0068" y="1284.3013">Oueue the Placeholder Message transfer request</text><polygon fill="#181818" points="1065.5278,1332.5,1075.5278,1336.5,1065.5278,1340.5,1069.5278,1336.5" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="64.0068" x2="1071.5278" y1="1336.5" y2="1336.5"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="869.7305" x="71.0068" y="1331.4341">Transfer the Placeholder Message (message=&lt;Placeholder Message&gt;, Authorization: Bearer &lt;JWT Assertion&gt;, DPoP: &lt;DPoP Proof&gt;)</text><line style="stroke:#181818;stroke-width:1;" x1="1087.5278" x2="1129.5278" y1="1365.6328" y2="1365.6328"></line><line style="stroke:#181818;stroke-width:1;" x1="1129.5278" x2="1129.5278" y1="1365.6328" y2="1378.6328"></line><line style="stroke:#181818;stroke-width:1;" x1="1088.5278" x2="1129.5278" y1="1378.6328" y2="1378.6328"></line><polygon fill="#181818" points="1098.5278,1374.6328,1088.5278,1378.6328,1098.5278,1382.6328,1094.5278,1378.6328" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="374.9941" x="1094.5278" y="1360.5669">Validate DPoP Proof (using "jkt" from JWT Assertion "cnf")</text><line style="stroke:#181818;stroke-width:1;" x1="1087.5278" x2="1129.5278" y1="1422.8984" y2="1422.8984"></line><line style="stroke:#181818;stroke-width:1;" x1="1129.5278" x2="1129.5278" y1="1422.8984" y2="1435.8984"></line><line style="stroke:#181818;stroke-width:1;" x1="1088.5278" x2="1129.5278" y1="1435.8984" y2="1435.8984"></line><polygon fill="#181818" points="1098.5278,1431.8984,1088.5278,1435.8984,1098.5278,1439.8984,1094.5278,1435.8984" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="395.2813" x="1094.5278" y="1402.6997">Validate JWT Assertion, use DNS discovery to verify that AS2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="269.7944" x="1098.6602" y="1417.8325">is the corresponding JWT Assertion issuer</text><line style="stroke:#181818;stroke-width:1;" x1="1087.5278" x2="1129.5278" y1="1465.0313" y2="1465.0313"></line><line style="stroke:#181818;stroke-width:1;" x1="1129.5278" x2="1129.5278" y1="1465.0313" y2="1478.0313"></line><line style="stroke:#181818;stroke-width:1;" x1="1088.5278" x2="1129.5278" y1="1478.0313" y2="1478.0313"></line><polygon fill="#181818" points="1098.5278,1474.0313,1088.5278,1478.0313,1098.5278,1482.0313,1094.5278,1478.0313" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166.6641" x="1094.5278" y="1459.9653">Verify the "eht" signature</text><line style="stroke:#181818;stroke-width:1;" x1="1087.5278" x2="1129.5278" y1="1522.2969" y2="1522.2969"></line><line style="stroke:#181818;stroke-width:1;" x1="1129.5278" x2="1129.5278" y1="1522.2969" y2="1535.2969"></line><line style="stroke:#181818;stroke-width:1;" x1="1088.5278" x2="1129.5278" y1="1535.2969" y2="1535.2969"></line><polygon fill="#181818" points="1098.5278,1531.2969,1088.5278,1535.2969,1098.5278,1539.2969,1094.5278,1535.2969" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382.2114" x="1094.5278" y="1502.0981">Use DNS discovery to verify that MTA2 is the correct client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127.5625" x="1098.6602" y="1517.231">making the request</text><line style="stroke:#181818;stroke-width:1;" x1="1087.5278" x2="1129.5278" y1="1579.5625" y2="1579.5625"></line><line style="stroke:#181818;stroke-width:1;" x1="1129.5278" x2="1129.5278" y1="1579.5625" y2="1592.5625"></line><line style="stroke:#181818;stroke-width:1;" x1="1088.5278" x2="1129.5278" y1="1592.5625" y2="1592.5625"></line><polygon fill="#181818" points="1098.5278,1588.5625,1088.5278,1592.5625,1098.5278,1596.5625,1094.5278,1592.5625" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="262.1836" x="1094.5278" y="1559.3638">Create JWT Signed Placeholder Message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="369.9478" x="1098.6602" y="1574.4966">&lt;Placeholder Message&gt;=&lt;JWT Assertion&gt;||&lt;message&gt;</text><line style="stroke:#181818;stroke-width:1;" x1="1087.5278" x2="1129.5278" y1="1636.8281" y2="1636.8281"></line><line style="stroke:#181818;stroke-width:1;" x1="1129.5278" x2="1129.5278" y1="1636.8281" y2="1649.8281"></line><line style="stroke:#181818;stroke-width:1;" x1="1088.5278" x2="1129.5278" y1="1649.8281" y2="1649.8281"></line><polygon fill="#181818" points="1098.5278,1645.8281,1088.5278,1649.8281,1098.5278,1653.8281,1094.5278,1649.8281" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="284.0386" x="1094.5278" y="1616.6294">Create Received=&lt;from, by, Date&gt; header</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249.7549" x="1098.6602" y="1631.7622">and add it to the Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="1087.5278" x2="1129.5278" y1="1694.0938" y2="1694.0938"></line><line style="stroke:#181818;stroke-width:1;" x1="1129.5278" x2="1129.5278" y1="1694.0938" y2="1707.0938"></line><line style="stroke:#181818;stroke-width:1;" x1="1088.5278" x2="1129.5278" y1="1707.0938" y2="1707.0938"></line><polygon fill="#181818" points="1098.5278,1703.0938,1088.5278,1707.0938,1098.5278,1711.0938,1094.5278,1707.0938" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="281.2456" x="1094.5278" y="1673.895">Create Message-ID=&lt;Message-ID&gt; header</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249.7549" x="1098.6602" y="1689.0278">and add it to the Placeholder Message</text><line style="stroke:#181818;stroke-width:1;" x1="1087.5278" x2="1129.5278" y1="1751.3594" y2="1751.3594"></line><line style="stroke:#181818;stroke-width:1;" x1="1129.5278" x2="1129.5278" y1="1751.3594" y2="1764.3594"></line><line style="stroke:#181818;stroke-width:1;" x1="1088.5278" x2="1129.5278" y1="1764.3594" y2="1764.3594"></line><polygon fill="#181818" points="1098.5278,1760.3594,1088.5278,1764.3594,1098.5278,1768.3594,1094.5278,1764.3594" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="319.3125" x="1094.5278" y="1731.1606">Store the Placeholder Message in the store using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="292.2334" x="1098.6602" y="1746.2935">the Message-ID header value as an identifier</text><polygon fill="#181818" points="75.0068,1789.4922,65.0068,1793.4922,75.0068,1797.4922,71.0068,1793.4922" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="69.0068" x2="1076.5278" y1="1793.4922" y2="1793.4922"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="283.6323" x="81.0068" y="1788.4263">Placeholder Message Delivery Confirmation</text><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="64.0068" x2="106.0068" y1="1827.625" y2="1827.625"></line><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="106.0068" x2="106.0068" y1="1827.625" y2="1840.625"></line><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="59.0068" x2="106.0068" y1="1840.625" y2="1840.625"></line><polygon fill="#181818" points="69.0068,1836.625,59.0068,1840.625,69.0068,1844.625,65.0068,1840.625" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334.7119" x="71.0068" y="1822.5591">Dequeue the Placeholder Message transfer request</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="1869.7578" y2="1869.7578"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="1869.7578" y2="1882.7578"></line><line style="stroke:#181818;stroke-width:1;" x1="54.0068" x2="101.0068" y1="1882.7578" y2="1882.7578"></line><polygon fill="#181818" points="64.0068,1878.7578,54.0068,1882.7578,64.0068,1886.7578,60.0068,1882.7578" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="407.7798" x="66.0068" y="1864.6919">The Placeholder Message transfer request has been dequeued</text><line style="stroke:#181818;stroke-width:1;" x1="1087.5278" x2="1134.5278" y1="1917.0234" y2="1917.0234"></line><line style="stroke:#181818;stroke-width:1;" x1="1134.5278" x2="1134.5278" y1="1917.0234" y2="1930.0234"></line><line style="stroke:#181818;stroke-width:1;" x1="1093.5278" x2="1134.5278" y1="1930.0234" y2="1930.0234"></line><polygon fill="#181818" points="1103.5278,1926.0234,1093.5278,1930.0234,1103.5278,1934.0234,1099.5278,1930.0234" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="325.8062" x="1099.5278" y="1896.8247">Queue the Placeholder Message proceeding using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="292.2334" x="1103.6602" y="1911.9575">the Message-ID header value as an identifier</text><!--SRC=[hLVVSzis37xtNu7J7XhVsUrgt_RWitnBwtI_sZLht6rtJIz7Ix3DHYOraahgnltV1qYs9Lcqc-poabWa2830Xm-Waov1U7kQkGNqdduF4tsD2iu-HmkXvWWpRS1W8bPIpP_HnwqmCVs4yqH4kD19Z0RUeBM2P3FBEx_zFO5JQz4ugHK85SFuN9-tKa4BaKo5SX2yUV5FxzcRoMal067XJ3dfLhswoEb53zWfRUGNaQkwG7E39Z_16yLdGs-VzVOhUlkjbeYSl14ETvRs5-2xrtA-S3yRiMfjbxgZxUu0NciHWrlWaMlpxcQb- -luKi421KlTY2H3zaOea36InfcavPdHo_oCTThWfHfwD8_2uGNlnZwpezBHggUJ0qwcHaU8UUfY_3V33EDMZ8t0U6__CoeqBCM9X7EZzGnEYbihl8LhN44gf6bx3xyqo4S95TqTAhfZEKVhw7g_dFP- -F6a1fdsg0mUeqV4CKW7JXzAm36phmh4OjnzHG4FXrCz_Ga_YsMQu5E5RhGnTAaUqzH4vuQcgvqfRUQFQUeT4k0bOSdkHxBgHFinJOxfJpZalwE79QUgj2pRmJxFl6DGMdUfJkQ6IldAhL8CCwC64jriG4KkbdQW1IaOv09T5XWuLjB5ZPBEfJA56eolygrZQegpkPfFjuxEscpw2IDNd0o7DL2EzlSVfBa8c0q_t0KbHGI3OVan-afYTq4Thi4WUA6dq01jK0WtK40Q6siDnHDTg9skm0FIGjfNhAJSjppw-f6EnAbE2HqxUg0IZX9suqh6uP297efleAjI92DDmPFAeQ7xN2s5JDeb9rV8lLN-tiVFNoAHyOPPoZpTvq3fvX7fC-PjbcPSrzEom_zSICMGpMLIdSXezSna2Lgmw40NwzJ7ZfWfsR7ICq-ajI6Tey229rIyBBwauIx2l12fMNZtwTg5EqhzdNf1jfocXWwtEQ-0Y_0E5pkH4dthTVs6wpL9DrbclVOXeCsgINSIVgYYkxCFveu7iFbHFzm-VctNqr_hSllaOLEjBBNH4n55vCF16dvuxL8kieVJIRlQNAk0zb7iEqoPECjnmDlmuLRIYCOot7JvPXTohloo5DPZeyD-ODPhx_Z1sL6Qp94QOlZCielImc7DcpcdI094MZcZ4qYavKZclfzzPYIBX7EcCqDoTAyaWIcDckYY1UdTZKOq-isb0XhgdlDGzvpAojp82BynfN1ucfDA7bonnDsuqibdszt4k5NUzcj_JvSV_t71SOWb5IL3id6sCWh6cafL0K-de6TqURC5_nCBo6NClTDGcFpstlA8Td3aTDG2xGnvDC_xtT61jgc_JnMqrN38nCco-17weL6VpGVm0eMX_VsAonCnW6fhQEyxszzwsAzvwE7hRIu38hgWm4cTEGEYmQ1zN5tjH2T7DITsczKLfvZ-ondzMWZ714xf8zXpf29jJ4usSVEfapE5yHlVwaC8Y843i5IwmcK6lUBll-LJtb6hBaLkqs39rQMutg9m2m-VaKhhEKuazsIGPVrTuZL67G3b3T9CmCdhm7JLWUfC-S19rMkZx45XTS1w30ivyHsi6AbA1Y-OOCDvfHV77uMbpIeJ-4oDCP4vBbvgDPDccHTXwqdZGTVtFnB7nGlm_lJYUIdwI6joJtsmeAjFaLhuqRVeawRpp_tns8qQtmf8pyyrVnuDH-Nj_B_Ikf-KAZd_1m00]--></g></svg></p><p>The sequence diagram of this flow is self-explanatory. It outlines the process of forwarding the Placeholder Message to the destination MBX3/MTA3 service while chronologically appending the JWT Assertion to the top of the Placeholder Message.</p>
<div style="break-after:page"></div>
<h4 id="to-authorize-the-fetching-of-external-resources">To authorize the fetching of External Resources: </h4>
<ul>
<li>We will use the OAuth 2.0 Token Exchange grant type (RFC 8693).</li>
<li>We will exchange the JWT Assertion for an Access Token.</li>
<li>We will use the DPoP mechanism to bind the Access Token to the client.</li>
<li>The MBX3/MTA3 agent should be registered at the AS3 authorization server as a confidential client.</li>
<li>The token exchange and fetching process begins after the successful Placeholder Message delivery.</li>
<li>To fetch an External Resource, use the HTTP POST method to bypass caching. The request body should include the <code>envelope</code> parameter, which contains the (chain of) JWT Signed Placeholder Message Envelope Headers.</li>
</ul>
<h5 id="sequence-diagram-3">Sequence Diagram </h5>
<p class="plantuml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" data-diagram-type="SEQUENCE" height="1542px" preserveAspectRatio="none" style="width:1702px;height:1542px;background:#FFFFFF;" version="1.1" viewBox="0 0 1702 1542" width="1702px" zoomAndPan="magnify"><title>OAuth 2.0 Token Exchange for fetching External Resources using JWT Assertion and DPoP</title><defs></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="710.9102" x="502.8809" y="27.9951">OAuth 2.0 Token Exchange for fetching External Resources using JWT Assertion and DPoP</text><g><title>MBX1/MTA1</title><rect fill="#FFFFFF" height="456.9922" style="stroke:#181818;stroke-width:1;" width="10" x="49.0068" y="890.2422"></rect></g><g><title>AS3 Authorization Server</title><rect fill="#FFFFFF" height="306.8594" style="stroke:#181818;stroke-width:1;" width="10" x="750.374" y="397.5859"></rect></g><g><title>MBX3/MTA3</title><rect fill="#FFFFFF" height="1398.1719" style="stroke:#181818;stroke-width:1;" width="10" x="1248.3452" y="83.5938"></rect></g><g><title>MBX3/MTA3</title><rect fill="#D3D3D3" height="99.5313" style="stroke:#181818;stroke-width:1;" width="10" x="1253.3452" y="83.5938"></rect></g><g><title>MBX3/MTA3</title><rect fill="#D3D3D3" height="583.5234" style="stroke:#181818;stroke-width:1;" width="10" x="1253.3452" y="856.1094"></rect></g><g><title>MBX1/MTA1</title><rect fill="transparent" height="1433.1719" width="8" x="50.0068" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="54" x2="54" y1="73.5938" y2="1506.7656"></line></g><g><title>AS3 Authorization Server</title><rect fill="transparent" height="1433.1719" width="8" x="751.374" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="754.3989" x2="754.3989" y1="73.5938" y2="1506.7656"></line></g><g><title>MBX3/MTA3</title><rect fill="transparent" height="1433.1719" width="8" x="1249.3452" y="73.5938"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1253.3384" x2="1253.3384" y1="73.5938" y2="1506.7656"></line></g><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="5" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="12" y="62.292">MBX1/MTA1</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="5" y="1505.7656"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="12" y="1525.7607">MBX1/MTA1</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="189.9502" x="660.3989" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="175.9502" x="667.3989" y="62.292">AS3 Authorization Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="189.9502" x="660.3989" y="1505.7656"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="175.9502" x="667.3989" y="1525.7607">AS3 Authorization Server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="1204.3384" y="42.2969"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="1211.3384" y="62.292">MBX3/MTA3</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="98.0137" x="1204.3384" y="1505.7656"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.0137" x="1211.3384" y="1525.7607">MBX3/MTA3</text><g><title>MBX1/MTA1</title><rect fill="#FFFFFF" height="456.9922" style="stroke:#181818;stroke-width:1;" width="10" x="49.0068" y="890.2422"></rect></g><g><title>AS3 Authorization Server</title><rect fill="#FFFFFF" height="306.8594" style="stroke:#181818;stroke-width:1;" width="10" x="750.374" y="397.5859"></rect></g><g><title>MBX3/MTA3</title><rect fill="#FFFFFF" height="1398.1719" style="stroke:#181818;stroke-width:1;" width="10" x="1248.3452" y="83.5938"></rect></g><g><title>MBX3/MTA3</title><rect fill="#D3D3D3" height="99.5313" style="stroke:#181818;stroke-width:1;" width="10" x="1253.3452" y="83.5938"></rect></g><g><title>MBX3/MTA3</title><rect fill="#D3D3D3" height="583.5234" style="stroke:#181818;stroke-width:1;" width="10" x="1253.3452" y="856.1094"></rect></g><line style="stroke:#181818;stroke-width:1;" x1="1263.3452" x2="1305.3452" y1="134.9922" y2="134.9922"></line><line style="stroke:#181818;stroke-width:1;" x1="1305.3452" x2="1305.3452" y1="134.9922" y2="147.9922"></line><line style="stroke:#181818;stroke-width:1;" x1="1264.3452" x2="1305.3452" y1="147.9922" y2="147.9922"></line><polygon fill="#181818" points="1274.3452,143.9922,1264.3452,147.9922,1274.3452,151.9922,1270.3452,147.9922" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="342.4434" x="1270.3452" y="99.6606">Load the Placeholder Message using the Message-ID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="284.5591" x="1274.4775" y="114.7935">header value as an identifier from the store</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="375.6353" x="1270.3452" y="129.9263">&lt;Placeholder Message&gt;=&lt;Stored Placeholder Message&gt;</text><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="1263.3452" x2="1305.3452" y1="182.125" y2="182.125"></line><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="1305.3452" x2="1305.3452" y1="182.125" y2="195.125"></line><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="1258.3452" x2="1305.3452" y1="195.125" y2="195.125"></line><polygon fill="#181818" points="1268.3452,191.125,1258.3452,195.125,1268.3452,199.125,1264.3452,195.125" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="311.9238" x="1270.3452" y="177.0591">The Placeholder Message proceeding dequeued</text><line style="stroke:#181818;stroke-width:1;" x1="1258.3452" x2="1300.3452" y1="219.2578" y2="219.2578"></line><line style="stroke:#181818;stroke-width:1;" x1="1300.3452" x2="1300.3452" y1="219.2578" y2="232.2578"></line><line style="stroke:#181818;stroke-width:1;" x1="1259.3452" x2="1300.3452" y1="232.2578" y2="232.2578"></line><polygon fill="#181818" points="1269.3452,228.2578,1259.3452,232.2578,1269.3452,236.2578,1265.3452,232.2578" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273.3428" x="1265.3452" y="214.1919">Generate DPoP Proof (using new key pair)</text><polygon fill="#181818" points="771.374,393.5859,761.374,397.5859,771.374,401.5859,767.374,397.5859" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="765.374" x2="1247.3452" y1="397.5859" y2="397.5859"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165.0645" x="777.374" y="256.3247">Token Exchange Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="415.6763" x="777.374" y="271.4575">(grant_type=urn:ietf:params:oauth:grant-type:token-exchange,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152.4897" x="777.374" y="286.5903">audience=MBX1/MTA1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="468.9712" x="777.374" y="301.7231">requested_token_type=urn:ietf:params:oauth:token-type:access_token,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="216.6899" x="777.374" y="316.856">subject_token=&lt;JWT Assertion&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382.3574" x="777.374" y="331.9888">subject_token_type=urn:ietf:params:oauth:token-type:jwt,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136.8301" x="777.374" y="347.1216">dpop=&lt;DPoP Proof&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185.0151" x="777.374" y="362.2544">client_id=&lt;MTA3 client ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139.1279" x="777.374" y="377.3872">scope=internet_mail,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="188.2397" x="777.374" y="392.52">message-id=&lt;Message-ID&gt;)</text><line style="stroke:#181818;stroke-width:1;" x1="760.374" x2="802.374" y1="426.7188" y2="426.7188"></line><line style="stroke:#181818;stroke-width:1;" x1="802.374" x2="802.374" y1="426.7188" y2="439.7188"></line><line style="stroke:#181818;stroke-width:1;" x1="761.374" x2="802.374" y1="439.7188" y2="439.7188"></line><polygon fill="#181818" points="771.374,435.7188,761.374,439.7188,771.374,443.7188,767.374,439.7188" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146.9736" x="767.374" y="421.6528">Validate JWT Assertion</text><line style="stroke:#181818;stroke-width:1;" x1="760.374" x2="802.374" y1="468.8516" y2="468.8516"></line><line style="stroke:#181818;stroke-width:1;" x1="802.374" x2="802.374" y1="468.8516" y2="481.8516"></line><line style="stroke:#181818;stroke-width:1;" x1="761.374" x2="802.374" y1="481.8516" y2="481.8516"></line><polygon fill="#181818" points="771.374,477.8516,761.374,481.8516,771.374,485.8516,767.374,481.8516" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128.9717" x="767.374" y="463.7856">Validate DPoP Proof</text><line style="stroke:#181818;stroke-width:1;" x1="760.374" x2="802.374" y1="601.7813" y2="601.7813"></line><line style="stroke:#181818;stroke-width:1;" x1="802.374" x2="802.374" y1="601.7813" y2="614.7813"></line><line style="stroke:#181818;stroke-width:1;" x1="761.374" x2="802.374" y1="614.7813" y2="614.7813"></line><polygon fill="#181818" points="771.374,610.7813,761.374,614.7813,771.374,618.7813,767.374,614.7813" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202.9409" x="767.374" y="505.9185">Create Access Token (iss=AS3,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121.6782" x="771.5063" y="521.0513">exp=1737913610,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117.4951" x="771.5063" y="536.1841">aud=MBX1/MTA1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139.1279" x="771.5063" y="551.3169">scope=internet_mail,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92.1362" x="771.5063" y="566.4497">azp=client_id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191.4326" x="771.5063" y="581.5825">message-id=&lt;Message-ID&gt; ,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="246.7017" x="771.5063" y="596.7153">cnf={jkt=SHA256(JWK Thumbprint)})</text><polygon fill="#181818" points="1236.3452,700.4453,1246.3452,704.4453,1236.3452,708.4453,1240.3452,704.4453" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="755.374" x2="1242.3452" y1="704.4453" y2="704.4453"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174.6938" x="762.374" y="638.8481">Token Exchange Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217.5278" x="762.374" y="653.981">(access_token=&lt;Access Token&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130.9521" x="762.374" y="669.1138">token_type=Bearer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="444.666" x="762.374" y="684.2466">issued_token_type=urn:ietf:params:oauth:token-type:access_token,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108.5576" x="762.374" y="699.3794">expires_in:3600)</text><line style="stroke:#181818;stroke-width:1;" x1="1258.3452" x2="1300.3452" y1="748.7109" y2="748.7109"></line><line style="stroke:#181818;stroke-width:1;" x1="1300.3452" x2="1300.3452" y1="748.7109" y2="761.7109"></line><line style="stroke:#181818;stroke-width:1;" x1="1259.3452" x2="1300.3452" y1="761.7109" y2="761.7109"></line><polygon fill="#181818" points="1269.3452,757.7109,1259.3452,761.7109,1269.3452,765.7109,1265.3452,761.7109" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="337.4033" x="1265.3452" y="728.5122">Generate new DPoP Proof (using the same key pair,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155.7905" x="1269.4775" y="743.645">for MBX1/MTA1 service)</text><line style="stroke:#181818;stroke-width:1;" x1="1258.3452" x2="1300.3452" y1="805.9766" y2="805.9766"></line><line style="stroke:#181818;stroke-width:1;" x1="1300.3452" x2="1300.3452" y1="805.9766" y2="818.9766"></line><line style="stroke:#181818;stroke-width:1;" x1="1259.3452" x2="1300.3452" y1="818.9766" y2="818.9766"></line><polygon fill="#181818" points="1269.3452,814.9766,1259.3452,818.9766,1269.3452,822.9766,1265.3452,818.9766" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="430.3267" x="1265.3452" y="785.7778">Use DNS to discover MBX1/MTA1 service using the domain part of</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150.4268" x="1269.4775" y="800.9106">sender's email address</text><line style="stroke:#181818;stroke-width:1;" x1="1258.3452" x2="1305.3452" y1="843.1094" y2="843.1094"></line><line style="stroke:#181818;stroke-width:1;" x1="1305.3452" x2="1305.3452" y1="843.1094" y2="856.1094"></line><line style="stroke:#181818;stroke-width:1;" x1="1264.3452" x2="1305.3452" y1="856.1094" y2="856.1094"></line><polygon fill="#181818" points="1274.3452,852.1094,1264.3452,856.1094,1274.3452,860.1094,1270.3452,856.1094" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="302.2183" x="1270.3452" y="838.0435">Queue the External Resource fetching request</text><polygon fill="#181818" points="70.0068,886.2422,60.0068,890.2422,70.0068,894.2422,66.0068,890.2422" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="64.0068" x2="1252.3452" y1="890.2422" y2="890.2422"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="950.7456" x="76.0068" y="885.1763">Fetch External Resource (envelope=&lt;Placeholder Message Envelope&gt;, Content-ID, Authorization: Bearer &lt;Access Token&gt;, DPoP: &lt;DPoP Proof&gt;)</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="919.375" y2="919.375"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="919.375" y2="932.375"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="932.375" y2="932.375"></line><polygon fill="#181818" points="70.0068,928.375,60.0068,932.375,70.0068,936.375,66.0068,932.375" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="374.0737" x="66.0068" y="914.3091">Validate DPoP Proof (using "jkt" from Access Token "cnf")</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="961.5078" y2="961.5078"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="961.5078" y2="974.5078"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="974.5078" y2="974.5078"></line><polygon fill="#181818" points="70.0068,970.5078,60.0068,974.5078,70.0068,978.5078,66.0068,974.5078" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="667.3672" x="66.0068" y="956.4419">Validate Access Token, use DNS discovery to verify that AS3 is the corresponding Access Token issuer</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="1018.7734" y2="1018.7734"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="1018.7734" y2="1031.7734"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="1031.7734" y2="1031.7734"></line><polygon fill="#181818" points="70.0068,1027.7734,60.0068,1031.7734,70.0068,1035.7734,66.0068,1031.7734" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382.2114" x="66.0068" y="998.5747">Use DNS discovery to verify that MTA3 is the correct client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127.5625" x="70.1392" y="1013.7075">making the request</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="1076.0391" y2="1076.0391"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="1076.0391" y2="1089.0391"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="1089.0391" y2="1089.0391"></line><polygon fill="#181818" points="70.0068,1085.0391,60.0068,1089.0391,70.0068,1093.0391,66.0068,1089.0391" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="645.4487" x="66.0068" y="1055.8403">Load the Placeholder Message from the store using the message-id claim value from Access Token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97.5508" x="70.1392" y="1070.9731">as an identifier</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="1118.1719" y2="1118.1719"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="1118.1719" y2="1131.1719"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="1131.1719" y2="1131.1719"></line><polygon fill="#181818" points="70.0068,1127.1719,60.0068,1131.1719,70.0068,1135.1719,66.0068,1131.1719" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="592.8647" x="66.0068" y="1113.106">Verify the "envelope" parameter value against the Placeholder Message Envelope Headers</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="1190.5703" y2="1190.5703"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="1190.5703" y2="1203.5703"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="1203.5703" y2="1203.5703"></line><polygon fill="#181818" points="70.0068,1199.5703,60.0068,1203.5703,70.0068,1207.5703,66.0068,1203.5703" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="370.811" x="66.0068" y="1155.2388">Optional, valid only for forwarded Placeholder Messages:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="649.3145" x="70.1392" y="1170.3716">Use the "envelope" parameter value from the fetching request to discharge the External Resources</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="462.96" x="70.1392" y="1185.5044">in accordance with the "Forwarded-From" and "Forwarded-To" headers</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="1247.8359" y2="1247.8359"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="1247.8359" y2="1260.8359"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="1260.8359" y2="1260.8359"></line><polygon fill="#181818" points="70.0068,1256.8359,60.0068,1260.8359,70.0068,1264.8359,66.0068,1260.8359" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="533.0508" x="66.0068" y="1227.6372">Use the Placeholder Message as an access control list to allow/deny access to the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118.7837" x="70.1392" y="1242.77">External Resource</text><line style="stroke:#181818;stroke-width:1;" x1="59.0068" x2="101.0068" y1="1305.1016" y2="1305.1016"></line><line style="stroke:#181818;stroke-width:1;" x1="101.0068" x2="101.0068" y1="1305.1016" y2="1318.1016"></line><line style="stroke:#181818;stroke-width:1;" x1="60.0068" x2="101.0068" y1="1318.1016" y2="1318.1016"></line><polygon fill="#181818" points="70.0068,1314.1016,60.0068,1318.1016,70.0068,1322.1016,66.0068,1318.1016" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="624.8823" x="66.0068" y="1284.9028">Find External Resource in the store using Content-ID (file name of the External Resource equals</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190.3472" x="70.1392" y="1300.0356">the Content-ID header value)</text><polygon fill="#181818" points="1241.3452,1343.2344,1251.3452,1347.2344,1241.3452,1351.2344,1245.3452,1347.2344" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="54.0068" x2="1247.3452" y1="1347.2344" y2="1347.2344"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166.8672" x="61.0068" y="1342.1685">Return External Resource</text><line style="stroke:#181818;stroke-width:1;" x1="1263.3452" x2="1305.3452" y1="1391.5" y2="1391.5"></line><line style="stroke:#181818;stroke-width:1;" x1="1305.3452" x2="1305.3452" y1="1391.5" y2="1404.5"></line><line style="stroke:#181818;stroke-width:1;" x1="1264.3452" x2="1305.3452" y1="1404.5" y2="1404.5"></line><polygon fill="#181818" points="1274.3452,1400.5,1264.3452,1404.5,1274.3452,1408.5,1270.3452,1404.5" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="301.0249" x="1270.3452" y="1371.3013">Store the External Resource in the store using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="286.9585" x="1274.4775" y="1386.4341">the Content-ID header value as an identifier</text><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="1263.3452" x2="1305.3452" y1="1438.6328" y2="1438.6328"></line><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="1305.3452" x2="1305.3452" y1="1438.6328" y2="1451.6328"></line><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="1258.3452" x2="1305.3452" y1="1451.6328" y2="1451.6328"></line><polygon fill="#181818" points="1268.3452,1447.6328,1258.3452,1451.6328,1268.3452,1455.6328,1264.3452,1451.6328" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="318.2461" x="1270.3452" y="1433.5669">Dequeue the External Resource fetching request</text><line style="stroke:#181818;stroke-width:1;" x1="1258.3452" x2="1300.3452" y1="1480.7656" y2="1480.7656"></line><line style="stroke:#181818;stroke-width:1;" x1="1300.3452" x2="1300.3452" y1="1480.7656" y2="1493.7656"></line><line style="stroke:#181818;stroke-width:1;" x1="1253.3452" x2="1300.3452" y1="1493.7656" y2="1493.7656"></line><polygon fill="#181818" points="1263.3452,1489.7656,1253.3452,1493.7656,1263.3452,1497.7656,1259.3452,1493.7656" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="391.314" x="1265.3452" y="1475.6997">The External Resource fetching request has been dequeued</text><!--SRC=[fLPjRnf74FxEhnZH3mK96XDKHprnI4uS9qxZnZMawGSaQtqtmDh7xcLt3qAg_lVExd5mBmknr4zmixlp-impOxX943vTP6O9BtyvWwbyGW5llqLB9XO8SwbWZYPQSh4WgK4bM09tg6Mc8jIGQNlmuSiKBhH6PRWKm4GCbxVojfKo4aGyPS90- -RrtuCNDzEBGHkOXhV2SBCTLAzSJ8PW7P6AVsTErGJL6fLxOG_opuRUeTKxBEaTjbeiCdpD3EubTG7yz94lbkQTOjjM8UgFYzC0FaeMWraYt2OimgLCObHmWrepIaiUjZtTIVhNbpC1IsJsrfeb6Lflc00U8scSSnBFbLovDzf8XJCnycWUXwE9FOrzPiS7HykUJeyucIeP8SRMqnY_PfXXt8gnaHXlzEzGeBAtR27XLaavXquUjS0DFE4MKiPLj_BwKAAWZgCxwu0sCz5PA2hRlTcc66PA11pDFA22ifKE92C5WRlGjnS2OvNqSQUaDnCiYpcA2CCzcaYeSjqOtxlxftJd2frk5X5-TVw4bEZiuH4Zat-7emgYn_NpPvfut1Xw6QSo3KU7F8vd8aee2dFFut1aaGlvDrnVEakH9ELSs5v3SxzYF27fQeSpzsQFkN7tWEjIWxGE_-jr-OibFBRNAn4-vy4XWXEttoXqlhZaxa3GuLg7rDiK1U2tD1oy6hxwRJ0y7vnP2PMqKatmnm_iUnhkysO5Hp82zYmIy_2VnoSJJjvVlFprlFFXo-_K9jdg8LMakFjljvgYIZVLWQjJAJIrQwUCc71K3j6MhGICryWKAf9HuDd_WoNbYolKzrm4m_EpiswvWSi5Fzd3jcERVUoOYArmtymsSPRlzzK0GiUQHzZrw_-i2HH_JC18Y3bLpQQoyRP4bR6aMWgmx0roRYkDWlZgPmreYmmiZYbKxRNrfwKlfwKnX0xpQKS49wc-gNqGm9NLuD7SGR76nCBHnzNqFZyTz-2D9BmIRLrVzgeZB80S3L03Z2j806LUwDOT7nJU3YhUUZgog6cRCD_E1qsb1TlK4EtkQMtb1pqgMrxSeh9RMsRwvNFwjsG6xB3csfKaaagvDd6pfcBOTO3o6lxy8mkE6iic8hDZIjlzxAd0LL5sdv6JKxmwa4j8FL0B6MHyjPleZRnQMgfDUN-EYwWGsWMask0e0CrXOLXGUsXprDq2Rl3UhHdQQ-fJQb77afvLIlvBaMppBKwg3LEnVxFG0OLY2_835_SPg_TSGG9BfXP7-bIJ2Mf_8ZYfOaP373QSbavdyQfmhdz55jfkXIm9fxAzswtqKIWTorfUe9nM2KR2A9b0mdENMPB8pGigthQuGKBID1DD_xsMhpXvsYGEYhEEgmD3G6VEQUSMbdkfTVsaHcbbYKsPFIwzBQ-OfOOkS-KT6XepdW0Qoz_0oxLk0JtYLZEmqouUwu_Q2dkPxwVF9NZF5kiBPFeiRR0a7n-Go6g_9ViC_0S0]--></g></svg></p><p>The sequence diagram of this flow is self-explanatory. Take note of the use of a JWT Signed Placeholder Message as an access control list during the fetch request.</p>
<div style="break-after:page"></div>
<h2 id="project-implementation">Project Implementation </h2>
<p>We plan to implement this project as a proof of concept using Golang for the backend services, with a filesystem as the data store and SQLite for storing references and metadata of External Resources. OpenAPI 3.1 documentation will be developed to ensure clear and standardized API references. For the frontend, we will create a Progressive Web App (PWA) using the React framework, utilizing styled-components for styling. Additionally, we will design a synchronization protocol with polling to sync the Placeholder Message and inline External Resources with the mailbox.</p>
<h2 id="future-work">Future Work </h2>
<ol>
<li>Retry mechanism.</li>
</ol>
<h2 id="sketchy-ideas">Sketchy Ideas </h2>
<ol>
<li>Design a communication scheme to route the Placeholder Message through MBX/MTA intermediary entities, which will function as both proxy and reverse proxy services. This setup will facilitate the exchange of External Resources exclusively between the origin and the final destination. It is important to note that this scheme raises privacy considerations, as the intermediaries are not required to fetch the External Resources.</li>
<li>Email address verification link (verify email address, password reset) should be encrypted.</li>
<li>The user's public and private keys are stored in the AS. During an OAuth 2.0 redirect, the browser renders the user's private key in a hidden, read-only text field to enable cryptographic processes on the client only during user interaction.</li>
</ol>
<h1 id="prompt">Prompt </h1>
<p>Do you understand this project? Ask me if something is not clear to you.</p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>